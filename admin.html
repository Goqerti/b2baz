<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B2B Admin Panel - Professional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Global Styles & Reset */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      color: #374151;
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar Navigation */
    .sidebar {
        width: 250px;
        background: #111827;
        color: #f3f4f6;
        padding: 20px 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    .sidebar h1 {
        font-size: 22px;
        text-align: center;
        margin-bottom: 30px;
        color: #38bdf8;
    }
    .nav-group {
        flex-grow: 1;
    }
    .nav-item {
        padding: 12px 25px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        transition: background 0.3s, color 0.3s;
        border-left: 4px solid transparent;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #f3f4f6;
    }
    .nav-item:hover {
        background: #1f2937;
    }
    .nav-item.active {
        background: #3b82f6;
        border-left-color: #f3f4f6;
        color: white;
    }
    .logout-item {
        margin-top: 20px;
        padding: 15px 25px;
        cursor: pointer;
        color: #ef4444;
        font-weight: 600;
        border-top: 1px solid #334155;
        transition: background 0.3s;
    }
    .logout-item:hover {
        background: #27303e;
    }
    
    /* Main Content Area */
    .page {
      flex-grow: 1;
      padding: 30px;
    }
    .header-info {
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header-info h2 {
        font-size: 28px;
        margin: 0 0 5px;
        color: #111827;
    }
    .header-info p {
        font-size: 15px;
        color: #6b7280;
        margin: 0;
    }
    .user-info {
        font-size: 15px;
        font-weight: 600;
        color: #1d4ed8;
        padding: 8px 15px;
        background: #e0f2fe;
        border-radius: 6px;
    }

    /* Cards & Grids */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 25px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
    }
    
    /* Form Elements */
    h3 {
      font-size: 20px;
      margin: 0 0 15px;
      color: #111827;
      border-left: 4px solid #f59e0b;
      padding-left: 10px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #1f2937;
      font-size: 14px;
      outline: none;
      margin-bottom: 15px;
      transition: box-shadow 0.2s;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .btn {
      border-radius: 8px;
      border: none;
      padding: 10px 18px;
      background: #3b82f6;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 5px;
      transition: background 0.3s;
    }
    .btn:hover { background: #2563eb; }
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #cbd5e1;
      padding: 8px 15px;
      font-size: 13px;
      margin-top: 10px;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn-secondary:hover { background: #e2e8f0; }
    
    /* Room Type & Meal Plan Inputs */
    .room-type-row-inputs, .meal-plan-row-inputs {
        display: grid;
        grid-template-columns: 2fr 1fr 0.5fr 50px 60px; /* Name, Price, Checkbox, SeasonalBtn, DeleteBtn */
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }
    .meal-plan-row-inputs {
        grid-template-columns: 2fr 1fr 60px;
    }
    .room-type-row-inputs input, .room-type-row-inputs select,
    .meal-plan-row-inputs input, .meal-plan-row-inputs select {
        margin-bottom: 0 !important;
    }
    .room-type-checkbox-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .room-type-checkbox-group input {
        width: auto !important;
        accent-color: #3b82f6;
        margin: 0;
    }

    /* Lists & Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      font-size: 12px;
      color: #0369a1;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .list {
      margin-top: 20px;
      font-size: 13px;
      color: #4b5563;
      max-height: 250px;
      overflow-y: auto;
      border-top: 1px solid #e2e8f0;
      padding-top: 15px;
    }
    .list-item {
      padding: 10px 0;
      border-bottom: 1px dashed #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }
    .btn-action {
        background: none;
        border: none;
        padding: 5px 8px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s;
        margin-left: 5px;
    }
    .btn-edit {
        color: #3b82f6;
        border: 1px solid #3b82f6;
        background: #eff6ff;
    }
    .btn-edit:hover { background: #dbeafe; }
    .btn-delete {
        color: #ef4444;
        border: 1px solid #ef4444;
        background: #fef2f2;
    }
    .btn-delete:hover { background: #fca5a5; }
    .btn-save-inline { background: #10b981; color: white; }
    .btn-cancel-inline { background: #6b7280; color: white; }
    .list-item-content { flex-grow: 1; }
    
    .tag {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      margin-left: 6px;
      font-weight: 500;
    }
    .tag.pending { background: #fffbe6; color: #b45309; }
    .tag.confirmed { background: #d1fae5; color: #059669; }
    .tag.rejected { background: #fef2f2; color: #ef4444; }
    .tag.change { background: #e0f2fe; color: #1d4ed8; }

    .success { color: #10b981; margin-top: 10px; font-size: 13px; font-weight: 600; }
    .error { color: #ef4444; margin-top: 10px; font-size: 13px; font-weight: 600; }
    
    /* Reservations View Specific */
    .res-header-grid {
        display: grid;
        grid-template-columns: 0.1fr 0.3fr 0.4fr 0.4fr 0.6fr 0.5fr;
        font-weight: 700;
        padding: 15px 10px;
        border-bottom: 2px solid #e5e7eb;
        color: #111827;
        font-size: 14px;
        background: #f8fafc;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }
    .res-item-row {
        display: grid;
        grid-template-columns: 0.1fr 0.3fr 0.4fr 0.4fr 0.6fr 0.5fr;
        padding: 15px 10px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .res-item-row:hover { background: #f9fafb; }
    .res-amount { font-weight: 700; color: #10b981; text-align: right; }
    .res-detail-box {
        background: #e0f2fe;
        padding: 20px;
        border-radius: 10px;
        margin-top: 25px;
        font-size: 14px;
        white-space: pre-wrap;
        border-left: 5px solid #3b82f6;
    }
    .res-detail-box h4 { color: #111827; font-weight: 700; }
    .res-detail-box .actions {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed #c7d2fe;
    }
    .res-detail-box .actions button {
        margin-right: 10px;
        padding: 8px 15px;
        font-size: 13px;
        border-radius: 6px;
        cursor: pointer;
    }
    .res-detail-box .actions .btn-confirm { background: #10b981; color: white; border: none; }
    .res-detail-box .actions .btn-reject { background: #ef4444; color: white; border: none; }
    .res-detail-box .actions .btn-change { background: #3b82f6; color: white; border: none; }
    .res-detail-box .actions .btn-edit { background: #f59e0b; color: white; border: none; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); display: none; justify-content: center; 
        align-items: center; z-index: 1000;
    }
    .modal-content {
        background: white; padding: 30px; border-radius: 10px; 
        width: 90%; max-width: 800px; 
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
    }
    .modal-content h3 { border-left-color: #3b82f6; }
    .traveler-edit-row {
        border: 1px solid #e5e7eb; padding: 10px; border-radius: 8px; margin-bottom: 10px;
    }
    .traveler-edit-row input { margin-bottom: 8px; }
  </style>
</head>
<body>
    
    <script>
        const LOGGED_IN_AGENT = JSON.parse(localStorage.getItem('b2b_agent_auth'));
        if (!LOGGED_IN_AGENT || LOGGED_IN_AGENT.role !== 'Admin') {
            alert("Bu s…ôhif…ôy…ô daxil olmaq √º√ß√ºn Admin icaz…ôsi t…ôl…ôb olunur.");
            window.location.href = 'login.html'; 
        }
        
        const dateFormatter = new Intl.DateTimeFormat('az-AZ', { day: '2-digit', month: 'short', year: 'numeric' });
        function logout() {
            localStorage.removeItem('b2b_agent_auth');
            window.location.href = 'login.html';
        }
    </script>
    
    <div class="sidebar">
        <h1>Admin Console</h1>
        <div class="nav-group">
            <div class="nav-item active" data-view="hotels">
                <span style="font-size: 18px;">üè®</span> Hotell…ôr
            </div>
            <div class="nav-item" data-view="regions">
                <span style="font-size: 18px;">üåé</span> Regionlar
            </div>
            <div class="nav-item" data-view="operations">
                <span style="font-size: 18px;">‚úàÔ∏è</span> ∆èm…ôliyyatlar
            </div>
            <div class="nav-item" data-view="pending-agents">
                <span style="font-size: 18px;">üë§</span> Agent T…ôsdiqi
            </div>
            <div class="nav-item" data-view="reservations">
                <span style="font-size: 18px;">üìù</span> Rezervasiyalar
            </div>
        </div>
        <div class="logout-item" onclick="logout()">√áƒ±xƒ±≈ü et</div>
    </div>

    <div class="page">
        <div class="header-info">
            <div>
                <h2 id="viewTitle">Hotell…ôrin ƒ∞dar…ô Edilm…ôsi</h2>
                <p id="viewSubtitle">Otaq tipl…ôri, qidalanma planlarƒ± v…ô extra bed qiym…ôtl…ôrini idar…ô edin.</p>
            </div>
            <div id="agentInfo" class="user-info">
                Agent: <span id="agentNameDisplay">Y√ºkl…ônir...</span>
            </div>
        </div>

        <div id="hotelsView" style="display: block;">
            <div class="card">
                <h3 id="hotelFormTitle">üè® Yeni Hotel ∆èlav…ô Et</h3>
                <div class="pill">Otaq tipl…ôri, qidalanma planlarƒ± v…ô extra bed qiym…ôtl…ôri.</div>
                
                <div class="grid" style="gap: 15px;">
                    <div>
                        <label>Hotel adƒ±</label>
                        <input type="text" id="hotelName" placeholder="M…ôs: Alba Hotel" />
                    </div>
                    <div>
                        <label>Region</label>
                        <select id="hotelRegionSelect">
                            <option value="">Region se√ß...</option>
                        </select>
                    </div>
                    <div>
                        <label>Ulduz</label>
                        <select id="hotelStars">
                            <option value="3">3 ‚òÖ</option>
                            <option value="4" selected>4 ‚òÖ</option>
                            <option value="5">5 ‚òÖ</option>
                        </select>
                    </div>
                    <div>
                        <label>Extra bed / night ($)</label>
                        <input type="number" id="extraBedPrice" min="0" value="0" />
                    </div>
                </div>

                <div style="margin-top:25px;">
                    <strong style="font-size:14px; display: block; margin-bottom: 5px;">Otaq N√∂vl…ôri (Room types)</strong>
                    <div id="roomTypesAdmin"></div>
                    <button type="button" class="btn-secondary" onclick="createRoomTypeInput({}, 'roomTypesAdmin')">+ Room type …ôlav…ô et</button>
                </div>

                <div style="margin-top:25px;">
                    <strong style="font-size:14px; display: block; margin-bottom: 5px;">Qidalanma Planlarƒ± (Meal plans)</strong>
                    <div id="mealPlansAdmin"></div>
                    <button type="button" class="btn-secondary" onclick="createMealPlanInput({}, 'mealPlansAdmin')">+ Meal plan …ôlav…ô et</button>
                </div>

                <button class="btn" id="saveHotelBtn" style="margin-top:30px;">Hotel yadda saxla</button>
                <div id="hotelMsg"></div>

                <div class="list" id="hotelsList"></div>
            </div>
        </div>

        <div id="regionsView" style="display: none;">
            <div class="card" style="max-width: 500px;">
                <h3>üåé Regionlar</h3>
                <div class="pill">∆èsas coƒürafi b√∂lg…ôl…ôr</div>
                <label>Region adƒ±</label>
                <input type="text" id="regionName" placeholder="M…ôs: Baku" />
                <button class="btn" id="addRegionBtn">Region …ôlav…ô et</button>
                <div id="regionMsg"></div>
                <div class="list" id="regionsList"></div>
            </div>
        </div>

        <div id="operationsView" style="display: none;">
            <div class="card" style="max-width: 600px;">
                <h3>‚úàÔ∏è ∆èm…ôliyyatlar / Transferl…ôr</h3>
                <div class="pill">Transfer v…ô Tur qiym…ôtl…ôri (Sedan & Minivan)</div>
                <label>Operation adƒ±</label>
                <input type="text" id="opName" placeholder="M…ôs: Airport Transfer" />
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>Sedan Qiym…ôti ($)</label>
                        <input type="number" id="opPriceSedan" min="0" value="0" />
                    </div>
                    <div>
                        <label>Minivan Qiym…ôti ($)</label>
                        <input type="number" id="opPriceMinivan" min="0" value="0" />
                    </div>
                </div>
                <button class="btn" id="addOperationBtn">Operation …ôlav…ô et</button>
                <div id="opMsg"></div>
                <div class="list" id="operationsList"></div>
            </div>
        </div>

        <div id="pending-agentsView" style="display: none;">
            <div class="card" style="max-width: 500px;">
                <h3>üë§ Agent T…ôsdiqi G√∂zl…ôyir</h3>
                <div class="pill" style="background: #fffbe6; color: #b45309;">Qeydiyyatdan ke√ßmi≈ü, t…ôsdiql…ônm…ômi≈ü agentl…ôr.</div>
                <div id="pendingAgentsList"></div>
            </div>
        </div>
        
        <div id="reservationsView" style="display: none;">
            <div class="card" style="padding: 0;">
                <div class="res-header-grid">
                    <div># ID</div>
                    <div>Agent</div>
                    <div>Tarix Aralƒ±ƒüƒ±</div>
                    <div>Hotell…ôr</div>
                    <div>Status</div>
                    <div style="text-align: right;">Qiym…ôt</div>
                </div>
                <div id="reservationsList"></div>
            </div>
            <div id="reservationDetail" class="res-detail-box" style="display: none;"></div>
        </div>
    </div>
    
    <div id="editHotelModal" class="modal-overlay" onclick="closeModal('editHotelModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #6b7280;" onclick="closeModal('editHotelModal')">√ó</span>
            <h3>üè® Hotel Redakt…ô Et</h3>
            <div class="pill">M√∂vcud hotel m…ôlumatlarƒ±nƒ± yenil…ôyin</div>
            <input type="hidden" id="editHotelId">
            
            <div class="grid" style="gap: 15px;">
                <div>
                    <label>Hotel adƒ±</label>
                    <input type="text" id="editHotelName" />
                </div>
                <div>
                    <label>Region</label>
                    <select id="editHotelRegionSelect"></select>
                </div>
                <div>
                    <label>Ulduz</label>
                    <select id="editHotelStars">
                        <option value="3">3 ‚òÖ</option>
                        <option value="4">4 ‚òÖ</option>
                        <option value="5">5 ‚òÖ</option>
                    </select>
                </div>
                <div>
                    <label>Extra bed / night ($)</label>
                    <input type="number" id="editExtraBedPrice" min="0" />
                </div>
            </div>

            <div style="margin-top:25px;">
                <strong style="font-size:14px; display: block; margin-bottom: 5px;">Otaq N√∂vl…ôri</strong>
                <div id="roomTypesModal"></div>
                <button type="button" class="btn-secondary" onclick="createRoomTypeInput({}, 'roomTypesModal')">+ Room type …ôlav…ô et</button>
            </div>

            <div style="margin-top:25px;">
                <strong style="font-size:14px; display: block; margin-bottom: 5px;">Qidalanma Planlarƒ±</strong>
                <div id="mealPlansModal"></div>
                <button type="button" class="btn-secondary" onclick="createMealPlanInput({}, 'mealPlansModal')">+ Meal plan …ôlav…ô et</button>
            </div>

            <div id="editHotelMsg" class="error" style="display: none;"></div>
            <button class="btn" onclick="saveHotelFromModal()" style="margin-top:30px; width: 100%;">Yadda Saxla</button>
        </div>
    </div>
    
    <div id="seasonalPriceModal" class="modal-overlay" onclick="closeModal('seasonalPriceModal')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <span style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer;" onclick="closeModal('seasonalPriceModal')">√ó</span>
            <h3>üìÖ M√∂vs√ºmi Qiym…ôtl…ôr</h3>
            <p id="seasonalRoomTitle" style="color:#6b7280; margin-bottom:15px;"></p>
            
            <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div><label>Ba≈ülanƒüƒ±c</label><input type="date" id="seasStart" style="margin-bottom:0;"></div>
                    <div><label>Bitm…ô</label><input type="date" id="seasEnd" style="margin-bottom:0;"></div>
                    <div><label>Yeni Qiym…ôt ($)</label><input type="number" id="seasPrice" style="margin-bottom:0;" placeholder="0"></div>
                </div>
                <button class="btn" style="width:100%; margin-top:10px; background:#8b5cf6;" onclick="addSeasonalRange()">+ Aralƒ±q ∆èlav…ô Et</button>
            </div>

            <div style="max-height: 250px; overflow-y: auto;">
                <table style="width:100%; text-align: left; font-size:13px; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <th style="padding:8px;">Start</th>
                            <th style="padding:8px;">End</th>
                            <th style="padding:8px;">Price</th>
                            <th style="padding:8px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="seasonalListBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="saveSeasonalDataToRoom()">T…ôsdiql…ô v…ô Baƒüla</button>
            </div>
        </div>
    </div>
    
    <div id="changeDateModal" class="modal-overlay" onclick="closeModal('changeDateModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #6b7280;" onclick="closeModal('changeDateModal')">√ó</span>
            <h3>üìÖ Tarix D…ôyi≈üikliyi T…ôklifi G√∂nd…ôr</h3>
            <form id="changeDateForm">
                <input type="hidden" id="changeResId">
                <label>Yeni Check-in tarixi</label>
                <input type="date" id="newCheckIn" required>
                <label>Yeni Check-out tarixi</label>
                <input type="date" id="newCheckOut" required>
                <label>Agent √º√ß√ºn Qeyd (Max 250 simvol) *</label>
                <textarea id="adminNote" maxlength="250" rows="3" required></textarea>
                <div id="changeDateMsg" class="error" style="margin-top: 10px; display: none;"></div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 15px;">T…ôklifi G√∂nd…ôr</button>
            </form>
        </div>
    </div>
    
    <div id="editReservationModal" class="modal-overlay" onclick="closeModal('editReservationModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #6b7280;" onclick="closeModal('editReservationModal')">√ó</span>
            <h3 id="editModalTitle">üõ†Ô∏è Rezervasiya Redakt…ôsi</h3>
            <form id="editReservationForm">
                <input type="hidden" id="editResId">
                <input type="hidden" id="editResDate">
                <input type="hidden" id="editResAgentUsername">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="section-title">üóìÔ∏è ∆èsas M…ôlumatlar & Status</div>
                        <label>Check-in</label><input type="date" id="editCheckIn" required>
                        <label>Check-out</label><input type="date" id="editCheckOut" required>
                        <div class="grid" style="grid-template-columns: 1fr 1fr;">
                            <div><label>Adults</label><input type="number" id="editAdults" min="1" required></div>
                            <div><label>Children</label><input type="number" id="editChildren" min="0" required></div>
                        </div>
                        <label>Status</label>
                        <select id="editStatus">
                            <option value="Pending Admin">Pending Admin</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Date Change Requested">Date Change Requested</option>
                            <option value="Date Change Accepted">Date Change Accepted</option>
                            <option value="Date Change Rejected">Date Change Rejected</option>
                        </select>
                    </div>
                    <div>
                        <div class="section-title">‚úàÔ∏è U√ßu≈ü M…ôlumatlarƒ±</div>
                        <label>Arrival Time</label><input type="text" id="editFlightArrival">
                        <label>Departure Time</label><input type="text" id="editFlightDeparture">
                        <label>Hotell…ôrin adƒ±</label><input type="text" id="editHotelNames" required>
                    </div>
                </div>
                <div class="section-title">üë§ S…ôyah…ôt√ßi M…ôlumatlarƒ±</div>
                <div id="editTravelersContainer"></div>
                <div id="editMsg" class="error" style="margin-top: 15px; display: none;"></div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 25px; background: #10b981;">D…ôyi≈üiklikl…ôri Yadda Saxla</button>
            </form>
        </div>
    </div>

    <script>
        let dbData = { regions: [], hotels: [], operations: [], reservations: [], pending_agents: [] };
        let currentEditingRoomId = null; 
        let seasonalDataStore = {}; 

        document.getElementById('agentNameDisplay').textContent = LOGGED_IN_AGENT.name + ' (' + LOGGED_IN_AGENT.role + ')';
        
        // --- UTILS ---
        function formatMoney(v) {
          v = Math.round((v + Number.EPSILON) * 100) / 100;
          return v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' $';
        }
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if(id === 'editHotelModal') document.getElementById('editHotelMsg').style.display = 'none';
        }
        function handleActionResponse(response, type, action, msgEl) {
            return response.json().then(data => {
                if (response.ok && data.success) {
                    msgEl.textContent = `‚úÖ ${type} uƒüurla ${action}.`;
                    msgEl.className = 'success';
                    msgEl.style.display = 'block';
                    fetchData(); 
                    return true;
                } else {
                    throw new Error(data.error || 'X…ôta ba≈ü verdi.');
                }
            }).catch(err => {
                msgEl.textContent = '‚ùå ' + err.message;
                msgEl.className = 'error';
                msgEl.style.display = 'block';
                setTimeout(() => msgEl.textContent = '', 4000);
                return false;
            });
        }
        function statusToTag(status) {
            if(status === 'Confirmed') return '<span class="tag confirmed">T…ôsdiql…ôndi</span>';
            if(status === 'Rejected') return '<span class="tag rejected">R…ôdd edildi</span>';
            if(status === 'Pending Admin') return '<span class="tag pending">G√∂zl…ôyir</span>';
            return `<span class="tag change">${status}</span>`;
        }

        // --- VIEW SWITCHING ---
        function showView(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-view="${viewId}"]`).classList.add('active');
            
            ['hotelsView','regionsView','operationsView','pending-agentsView','reservationsView'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            document.getElementById(viewId + 'View').style.display = 'block';
            
            const titles = {
                'hotels': 'Hotell…ôrin ƒ∞dar…ô Edilm…ôsi',
                'regions': 'Regionlarƒ±n ƒ∞dar…ô Edilm…ôsi',
                'operations': '∆èm…ôliyyatlarƒ±n ƒ∞dar…ô Edilm…ôsi',
                'pending-agents': 'Agent T…ôsdiqi',
                'reservations': 'Rezervasiyalar'
            };
            document.getElementById('viewTitle').textContent = titles[viewId];
        }
        
        function fetchData() {
          fetch('/api/data').then(r => r.json()).then(data => {
              dbData = data;
              renderRegions(data.regions);
              renderOperations(data.operations);
              renderHotels(data.hotels, data.regions);
              renderPendingAgents(data.pending_agents); 
              renderReservations(data.reservations);
            });
        }
        
        // --- UNIVERSAL HOTEL INPUT CREATORS ---
        function createRoomTypeInput(rt = {}, containerId = 'roomTypesAdmin') {
            const tempId = rt.id || 'new_' + new Date().getTime() + Math.random().toString(16).slice(2);
            if (rt.seasonalPrices) { seasonalDataStore[tempId] = rt.seasonalPrices; }

            const container = document.getElementById(containerId);
            const row = document.createElement('div');
            row.className = 'room-type-row-inputs';
            row.dataset.id = tempId; 
            
            const hasSeasonal = seasonalDataStore[tempId] && seasonalDataStore[tempId].length > 0;
            const btnStyle = hasSeasonal ? "background:#8b5cf6; color:white;" : "background:#e5e7eb; color:#374151;";

            row.innerHTML = `
                <input type="text" placeholder="Room adƒ±" value="${rt.name || ''}" class="room-name" required>
                <input type="number" placeholder="Qiym…ôt" value="${rt.pricePerNight || 0}" min="0" class="room-price" required>
                <div class="room-type-checkbox-group">
                    <input type="checkbox" ${rt.isExtraBedAllowed ? 'checked' : ''} class="room-eb-allowed">
                    <label style="margin:0; font-size:11px;">Ex.Bed</label>
                </div>
                <button type="button" class="btn-action" style="${btnStyle}; border:1px solid #d1d5db;" onclick="openSeasonalModal('${tempId}', this)">üìÖ</button>
                <button type="button" class="btn-action btn-delete" onclick="this.parentNode.remove()">Sil</button>
            `;
            container.appendChild(row);
        }
        
        function createMealPlanInput(mp = {}, containerId = 'mealPlansAdmin') {
            const id = mp.id || new Date().getTime() + Math.random().toString(16).slice(2);
            const container = document.getElementById(containerId);
            const row = document.createElement('div');
            row.className = 'meal-plan-row-inputs';
            row.dataset.id = mp.id || '';
            
            row.innerHTML = `
                <input type="text" placeholder="Plan adƒ±" value="${mp.name || ''}" class="meal-name" required>
                <input type="number" placeholder="Qiym…ôt" value="${mp.pricePerPersonPerNight || 0}" min="0" class="meal-price" required>
                <button type="button" class="btn-action btn-delete" onclick="this.parentNode.remove()">Sil</button>
            `;
            container.appendChild(row);
        }

        // --- SEASONAL PRICING LOGIC ---
        function openSeasonalModal(tempRoomId, btnElement) {
            currentEditingRoomId = tempRoomId;
            const row = btnElement.closest('.room-type-row-inputs');
            const roomName = row.querySelector('.room-name').value || 'Adsƒ±z Otaq';
            document.getElementById('seasonalRoomTitle').textContent = `Otaq: ${roomName}`;
            const data = seasonalDataStore[tempRoomId] || [];
            renderSeasonalList(data);
            document.getElementById('seasStart').value = '';
            document.getElementById('seasEnd').value = '';
            document.getElementById('seasPrice').value = '';
            document.getElementById('seasonalPriceModal').style.display = 'flex';
        }

        function renderSeasonalList(data) {
            const tbody = document.getElementById('seasonalListBody');
            tbody.innerHTML = '';
            if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:#9ca3af;">M√∂vs√ºmi qiym…ôt yoxdur.</td></tr>'; return; }
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px dashed #e5e7eb';
                tr.innerHTML = `<td style="padding:8px;">${item.start}</td><td style="padding:8px;">${item.end}</td><td style="padding:8px; font-weight:bold; color:#10b981;">${item.price} $</td><td style="padding:8px;"><button onclick="removeSeasonalItem(${index})" style="color:red; border:none; background:none; cursor:pointer;">üóëÔ∏è</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function addSeasonalRange() {
            const start = document.getElementById('seasStart').value;
            const end = document.getElementById('seasEnd').value;
            const price = document.getElementById('seasPrice').value;
            if(!start || !end || !price) { alert("Z…ôhm…ôt olmasa b√ºt√ºn xanalarƒ± doldurun."); return; }
            if (new Date(start) > new Date(end)) { alert("Ba≈ülanƒüƒ±c tarixi bitm…ô tarixind…ôn sonra ola bilm…ôz."); return; }
            if (!seasonalDataStore[currentEditingRoomId]) { seasonalDataStore[currentEditingRoomId] = []; }
            seasonalDataStore[currentEditingRoomId].push({ start: start, end: end, price: Number(price) });
            renderSeasonalList(seasonalDataStore[currentEditingRoomId]);
            document.getElementById('seasStart').value = '';
            document.getElementById('seasEnd').value = '';
            document.getElementById('seasPrice').value = '';
        }

        function removeSeasonalItem(index) {
            if (seasonalDataStore[currentEditingRoomId]) {
                seasonalDataStore[currentEditingRoomId].splice(index, 1);
                renderSeasonalList(seasonalDataStore[currentEditingRoomId]);
            }
        }

        function saveSeasonalDataToRoom() {
            const btn = document.querySelector(`.room-type-row-inputs[data-id="${currentEditingRoomId}"] button[onclick^="openSeasonalModal"]`);
            if(btn) {
                const hasData = seasonalDataStore[currentEditingRoomId] && seasonalDataStore[currentEditingRoomId].length > 0;
                if(hasData) { btn.style.background = "#8b5cf6"; btn.style.color = "white"; } 
                else { btn.style.background = "#e5e7eb"; btn.style.color = "#374151"; }
            }
            closeModal('seasonalPriceModal');
        }

        // --- ADD HOTEL (MAIN FORM) ---
        function resetHotelForm() {
            document.getElementById('hotelName').value = '';
            document.getElementById('hotelRegionSelect').value = '';
            document.getElementById('hotelStars').value = '4';
            document.getElementById('extraBedPrice').value = '0';
            document.getElementById('roomTypesAdmin').innerHTML = '';
            document.getElementById('mealPlansAdmin').innerHTML = '';
            seasonalDataStore = {}; // Reset store
            createRoomTypeInput({}, 'roomTypesAdmin'); 
            createMealPlanInput({}, 'mealPlansAdmin'); 
        }

        function saveHotel() {
            const hotelName = document.getElementById('hotelName').value.trim();
            const regionId = document.getElementById('hotelRegionSelect').value;
            const stars = document.getElementById('hotelStars').value;
            const extraBedPrice = document.getElementById('extraBedPrice').value;
            const msgEl = document.getElementById('hotelMsg');
            
            if (!hotelName || !regionId) {
                msgEl.textContent = '‚ùå Hotel adƒ± v…ô region se√ßimi m…ôcburidir.';
                msgEl.className = 'error';
                return;
            }

            const roomTypes = Array.from(document.querySelectorAll('#roomTypesAdmin .room-type-row-inputs')).map(row => {
                const tempId = row.dataset.id;
                return {
                    name: row.querySelector('.room-name').value,
                    pricePerNight: row.querySelector('.room-price').value,
                    isExtraBedAllowed: row.querySelector('.room-eb-allowed').checked,
                    seasonalPrices: seasonalDataStore[tempId] || []
                };
            });

            const mealPlans = Array.from(document.querySelectorAll('#mealPlansAdmin .meal-plan-row-inputs')).map(row => ({
                name: row.querySelector('.meal-name').value,
                pricePerPersonPerNight: row.querySelector('.meal-price').value
            }));
            
            const payload = {
                name: hotelName,
                regionId: regionId,
                stars: stars,
                extraBedPricePerNight: extraBedPrice,
                roomTypes: roomTypes,
                mealPlans: mealPlans
            };

            fetch('/api/hotels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => handleActionResponse(response, 'Hotel', '…ôlav…ô edildi', msgEl))
            .then(success => { if(success) resetHotelForm(); });
        }

        // --- EDIT HOTEL (MODAL) ---
        function openEditHotelModal(hotelId) {
            const hotel = dbData.hotels.find(h => h.id === hotelId);
            if (!hotel) return;

            document.getElementById('editHotelId').value = hotel.id;
            document.getElementById('editHotelName').value = hotel.name;
            document.getElementById('editHotelRegionSelect').value = hotel.regionId;
            document.getElementById('editHotelStars').value = hotel.stars;
            document.getElementById('editExtraBedPrice').value = hotel.extraBedPricePerNight;
            
            seasonalDataStore = {}; // Reset for edit
            const rtContainer = document.getElementById('roomTypesModal');
            rtContainer.innerHTML = '';
            hotel.roomTypes.forEach(rt => createRoomTypeInput(rt, 'roomTypesModal'));
            
            const mpContainer = document.getElementById('mealPlansModal');
            mpContainer.innerHTML = '';
            hotel.mealPlans.forEach(mp => createMealPlanInput(mp, 'mealPlansModal'));
            
            document.getElementById('editHotelModal').style.display = 'flex';
        }

        function saveHotelFromModal() {
            const id = document.getElementById('editHotelId').value;
            const msgEl = document.getElementById('editHotelMsg');
            
            if (!id) {
                msgEl.textContent = '‚ùå X…ôta: Hotel ID tapƒ±lmadƒ±.';
                msgEl.className = 'error';
                msgEl.style.display = 'block';
                return;
            }

            const payload = {
                name: document.getElementById('editHotelName').value.trim(),
                regionId: document.getElementById('editHotelRegionSelect').value,
                stars: document.getElementById('editHotelStars').value,
                extraBedPricePerNight: document.getElementById('editExtraBedPrice').value,
                roomTypes: Array.from(document.querySelectorAll('#roomTypesModal .room-type-row-inputs')).map(row => {
                    const tempId = row.dataset.id;
                    return {
                        id: (tempId && !tempId.startsWith('new_')) ? Number(tempId) : undefined,
                        name: row.querySelector('.room-name').value,
                        pricePerNight: row.querySelector('.room-price').value,
                        isExtraBedAllowed: row.querySelector('.room-eb-allowed').checked,
                        seasonalPrices: seasonalDataStore[tempId] || []
                    };
                }),
                mealPlans: Array.from(document.querySelectorAll('#mealPlansModal .meal-plan-row-inputs')).map(row => ({
                    id: row.dataset.id ? Number(row.dataset.id) : undefined,
                    name: row.querySelector('.meal-name').value,
                    pricePerPersonPerNight: row.querySelector('.meal-price').value
                }))
            };

            fetch(`/api/hotels/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") === -1) {
                    throw new Error("Serverd…ôn yanlƒ±≈ü cavab g…ôldi (HTML). URL v…ô ya Serveri yoxlayƒ±n.");
                }
                return handleActionResponse(response, 'Hotel', 'yenil…ôndi', msgEl);
            })
            .then(success => {
                if (success) {
                    setTimeout(() => closeModal('editHotelModal'), 1000);
                }
            })
            .catch(err => {
                console.error(err);
                msgEl.textContent = '‚ùå ' + err.message;
                msgEl.className = 'error';
                msgEl.style.display = 'block';
            });
        }

        // --- RENDERING ---
        function renderRegions(regions) {
            const list = document.getElementById('regionsList');
            const selectMain = document.getElementById('hotelRegionSelect');
            const selectModal = document.getElementById('editHotelRegionSelect');
            
            list.innerHTML = '';
            selectMain.innerHTML = '<option value="">Region se√ß...</option>';
            selectModal.innerHTML = '<option value="">Region se√ß...</option>';
            
            regions.forEach(r => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">${r.name}</div>
                    <div><button class="btn-action btn-delete" onclick="deleteItem('regions', ${r.id})">Sil</button></div>
                `;
                list.appendChild(item);
                
                const opt1 = document.createElement('option');
                opt1.value = r.id; opt1.textContent = r.name;
                selectMain.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = r.id; opt2.textContent = r.name;
                selectModal.appendChild(opt2);
            });
        }
        
        function renderHotels(hotels, regions) {
            const list = document.getElementById('hotelsList');
            list.innerHTML = '';
            
            hotels.forEach(h => {
                const region = regions.find(r => r.id === h.regionId);
                const item = document.createElement('div');
                item.className = 'list-item';
                let roomInfo = h.roomTypes.map(rt => `${rt.name} (${formatMoney(rt.pricePerNight)})`).join(', ');
                
                item.innerHTML = `
                    <div class="list-item-content">
                        <strong>${h.name}</strong> <span class="tag">${h.stars}‚òÖ</span>
                        <span class="tag change">${region ? region.name : 'Unknown'}</span>
                        <div style="font-size:11px; color:#6b7280;">Rooms: ${roomInfo}</div>
                    </div>
                    <div>
                        <button class="btn-action btn-edit" data-hotel-id="${h.id}">Redakt…ô</button>
                        <button class="btn-action btn-delete" onclick="deleteItem('hotels', ${h.id})">Sil</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- OTHER FUNCTIONS ---
        function renderOperations(ops) {
            const list = document.getElementById('operationsList');
            list.innerHTML = '';
            ops.forEach(o => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `<div><strong>${o.name}</strong><br><small>S: ${o.priceSedan}$ | M: ${o.priceMinivan}$</small></div>
                <button class="btn-action btn-delete" onclick="deleteItem('operations', ${o.id})">Sil</button>`;
                list.appendChild(item);
            });
        }
        function deleteItem(type, id) {
            if(!confirm("Silm…ôk ist…ôdiyiniz…ô …ôminsiniz?")) return;
            fetch(`/api/${type}/${id}`, { method: 'DELETE' }).then(() => fetchData());
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.addEventListener('click', function() { showView(this.getAttribute('data-view')); });
            });
            
            document.getElementById('saveHotelBtn').addEventListener('click', saveHotel);
            document.getElementById('addRegionBtn').addEventListener('click', () => {
                const name = document.getElementById('regionName').value;
                fetch('/api/regions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name}) }).then(() => {document.getElementById('regionName').value=''; fetchData();});
            });
            document.getElementById('addOperationBtn').addEventListener('click', () => {
                const name = document.getElementById('opName').value;
                const priceSedan = document.getElementById('opPriceSedan').value;
                const priceMinivan = document.getElementById('opPriceMinivan').value;
                fetch('/api/operations', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, priceSedan, priceMinivan}) }).then(() => fetchData());
            });

            document.getElementById('hotelsList').addEventListener('click', function(e) {
                const btn = e.target.closest('.btn-edit');
                if (btn) {
                    const hotelId = Number(btn.getAttribute('data-hotel-id'));
                    openEditHotelModal(hotelId);
                }
            });

            resetHotelForm(); 
            fetchData();
            showView('hotels');
        });
        
        function renderReservations(reservations) {
            const list = document.getElementById('reservationsList');
            list.innerHTML = '';
            if(!reservations || !reservations.length) { list.innerHTML='<div style="padding:20px; text-align:center;">Bo≈üdur</div>'; return; }
            reservations.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(res => {
                const row = document.createElement('div');
                row.className = 'res-item-row';
                row.innerHTML = `<div>#${res.id}</div><div>${res.submittingAgentUsername}</div>
                <div>${res.summary.checkIn}</div><div>${res.summary.hotelNames}</div>
                <div>${statusToTag(res.status)}</div><div class="res-amount">${formatMoney(res.summary.totalPrice)}</div>`;
                list.appendChild(row);
            });
        }
        function renderPendingAgents(agents) {
            const list = document.getElementById('pendingAgentsList');
            list.innerHTML = '';
            if(!agents.length) list.innerHTML = '<i>Yoxdur</i>';
            agents.forEach(a => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<span>${a.name} (${a.company})</span><div>
                <button class="btn-action btn-save-inline" onclick="fetch('/api/agents/confirm/${a.id}', {method:'POST'}).then(fetchData)">‚úî</button>
                <button class="btn-action btn-delete" onclick="fetch('/api/agents/delete/${a.id}', {method:'DELETE'}).then(fetchData)">‚úò</button></div>`;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html> 
