<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B2B Booking Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===============================
       GLOBAL & NEUMORPHISM BASE
       =============================== */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at top left, #e5ecff 0, #f5f7fb 45%, #eef2f7 100%);
      color: #1F2937;
    }
    .page { max-width: 1500px; margin: 40px auto 50px; padding: 0 20px; }
    h1 { font-size: 32px; font-weight: 800; margin-bottom: 5px; color: #020617; letter-spacing: -0.03em; }
    .subtitle { font-size: 15px; color: #6b7280; margin-bottom: 25px; }

    /* --- CARDS & UI COMPONENTS --- */
    .card {
      background: rgba(255,255,255,0.7); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px);
      border-radius: 18px; border: 1px solid rgba(255,255,255,0.7);
      box-shadow: 8px 8px 22px rgba(15,23,42,0.12), -6px -6px 16px rgba(255,255,255,0.9);
      padding: 22px; margin-bottom: 20px; transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 10px 10px 26px rgba(15,23,42,0.16), -6px -6px 18px rgba(255,255,255,0.95); background: rgba(255,255,255,0.9); }

    .section-title {
      font-size: 17px; font-weight: 800; color: #1F2937; margin: 22px 0 14px;
      border-left: 4px solid #3b82f6; padding-left: 12px; display: flex; align-items: center; gap: 8px;
    }

    label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #4b5563; }
    input[type="text"], input[type="number"], input[type="date"], select {
      width: 100%; padding: 11px 13px; border-radius: 14px; border: none; font-size: 14px;
      background: #e5e9f2; box-shadow: inset 3px 3px 7px rgba(15,23,42,0.12), inset -3px -3px 7px rgba(255,255,255,0.9);
      outline: none; transition: all 0.2s ease;
    }
    input:focus, select:focus {
      background: #edf1fb; box-shadow: inset 2px 2px 6px rgba(15,23,42,0.16), inset -2px -2px 6px rgba(255,255,255,1), 0 0 0 1px rgba(59,130,246,0.5);
    }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .row { display: flex; align-items: center; gap: 16px; }
    .pill {
      padding: 7px 14px; border-radius: 999px; background: radial-gradient(circle at top left, #dbeafe 0, #e5f0ff 40%, #e0ecff 100%);
      font-size: 13px; color: #0c4a6e; display: inline-flex; align-items: center; gap: 6px; font-weight: 700;
    }

    /* LAYOUT & FILTERS */
    .main-content-grid { display: grid; grid-template-columns: 280px minmax(0, 1fr) 340px; gap: 24px; margin-top: 24px; }
    @media (max-width: 1150px) { .main-content-grid { grid-template-columns: 1fr; } }
    .sticky-sidebar { position: sticky; top: 20px; height: fit-content; }

    .filter-box { border-radius: 16px; border: 1px solid rgba(255,255,255,0.8); background: linear-gradient(145deg, rgba(238,242,255,0.8), rgba(255,255,255,0.95)); max-height: 220px; overflow-y: auto; padding: 10px 12px; box-shadow: inset 3px 3px 8px rgba(148,163,184,0.25), inset -3px -3px 8px rgba(255,255,255,0.9); }
    .filter-item, .hotel-item { display: flex; align-items: center; gap: 10px; padding: 7px 6px; font-size: 14px; cursor: pointer; border-radius: 10px; transition: background 0.15s ease; }
    .filter-item:hover, .hotel-item:hover { background: rgba(255,255,255,0.9); }

    .hotel-block { border: 1px solid rgba(226,232,240,0.9); background: linear-gradient(145deg, #f3f4ff, #ffffff); border-radius: 18px; padding: 18px; margin-bottom: 20px; box-shadow: 7px 7px 16px rgba(15,23,42,0.14), -7px -7px 16px rgba(255,255,255,0.95); }
    .hotel-block-title { font-size: 18px; font-weight: 800; color: #020617; margin-bottom: 6px; }
    .hotel-totals-line { font-size: 14px; margin-top: 14px; padding-top: 12px; border-top: 1px dashed #cbd5e1; display: flex; justify-content: space-between; font-weight: 700; color: #1d4ed8; }

    .room-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 10px; padding: 10px 11px; border-radius: 14px; background: #e5e9f2; box-shadow: inset 3px 3px 7px rgba(148,163,184,0.5), inset -3px -3px 7px rgba(255,255,255,0.8); }
    .qty-controls { display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 999px; background: #f3f4f6; box-shadow: inset 2px 2px 5px rgba(148,163,184,0.8), inset -2px -2px 5px rgba(255,255,255,1); }
    .qty-btn { border: none; background: transparent; cursor: pointer; font-size: 16px; color: #4b5563; font-weight: bold; width: 20px; }
    .qty-btn:hover { color: #1d4ed8; }
    .qty-value { min-width: 20px; text-align: center; font-weight: 700; color: #111827; }
    .add-room-btn { margin-top: 6px; border: none; padding: 9px 14px; border-radius: 999px; background: linear-gradient(135deg, #e0f2fe, #eff6ff); font-size: 13px; cursor: pointer; color: #1d4ed8; font-weight: 700; box-shadow: 3px 3px 9px rgba(148,163,184,0.7), -3px -3px 9px rgba(255,255,255,1); }
    .room-remove { margin-left: auto; color: #f97373; font-size: 18px; background: none; border: none; cursor: pointer; }

    /* OPERATIONS UI */
    .op-master-controls { display: flex; gap: 10px; margin-bottom: 15px; }
    .op-master-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; background: #e2e8f0; border-radius: 12px; color: #64748b; transition: all 0.2s; border: 2px solid transparent; cursor: default; }
    .op-master-btn.active-type { background: #eff6ff; border-color: #3b82f6; color: #1e3a8a; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
    .op-master-label { font-size: 12px; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
    .op-master-actions { display: flex; align-items: center; gap: 8px; }
    .op-master-action-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: #3b82f6; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(59,130,246,0.4); }
    .op-master-action-btn:hover { background: #2563eb; transform: scale(1.1); }
    .op-list-container { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
    .op-select-row { padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .op-select-row:hover { background: #f1f5f9; }
    .op-select-row.selected { background: #eff6ff; border-color: #3b82f6; box-shadow: inset 4px 0 0 #3b82f6; }
    .op-checkbox { width: 18px; height: 18px; border-radius: 4px; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
    .op-select-row.selected .op-checkbox { background: #3b82f6; border-color: #3b82f6; }
    .op-checkbox::after { content: '‚úì'; color: white; font-size: 12px; display: none; }
    .op-select-row.selected .op-checkbox::after { display: block; }
    .op-select-row-name { font-weight: 600; font-size: 14px; color: #334155; display:flex; align-items:center;}
    .op-select-row-prices { font-size: 11px; color: #64748b; text-align: right; }

    /* TOTALS CARD */
    .totals-card { background: radial-gradient(circle at top, rgba(31,41,55,0.98), rgba(31,41,55,0.92)); color: #f9fafb; padding: 24px; border-radius: 20px; box-shadow: 10px 10px 26px rgba(15,23,42,0.7), -6px -6px 18px rgba(148,163,184,0.25); }
    .totals-row { display: flex; justify-content: space-between; margin-bottom: 9px; font-size: 14px; }
    .grand { font-size: 24px; font-weight: 800; margin-top: 18px; padding-top: 14px; border-top: 1px solid rgba(148,163,184,0.4); color: #10B981; }

    #reserveBtn { padding: 14px 16px; background: linear-gradient(135deg, #10B981, #059669); font-size: 16px; font-weight: 800; border-radius: 14px; cursor: pointer; width: 100%; margin-top: 18px; border: none; color: white; box-shadow: 0 8px 18px rgba(16,185,129,0.4); }
    #reserveBtn:disabled { background: linear-gradient(135deg, #9ca3af, #6b7280); box-shadow: none; cursor: not-allowed; }

    .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; gap: 4px; }
    .tab-btn { padding: 9px 16px; font-size: 14px; font-weight: 700; cursor: pointer; background: transparent; border: none; border-bottom: 2px solid transparent; color: #6b7280; margin-bottom: -2px; }
    .tab-btn.active { color: #1d4ed8; border-bottom-color: #1d4ed8; background: rgba(255,255,255,0.9); }

    /* AGENT RES LIST */
    .agent-res-row, .agent-res-header { display: grid; grid-template-columns: 0.1fr 0.25fr 0.25fr 0.2fr 0.1fr 0.15fr 0.1fr; padding: 11px 10px; border-bottom: 1px solid #f3f4f6; font-size: 13px; cursor: pointer; align-items: center; gap: 5px; }
    .agent-res-row:hover { background: rgba(255,255,255,0.9); }
    .action-btn { border: none; padding: 5px 8px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; margin-right: 4px; transition: transform 0.1s; }
    .action-btn:hover { transform: scale(1.05); }
    .edit-btn { background: #eff6ff; color: #1d4ed8; }
    .cancel-btn { background: #fef2f2; color: #b91c1c; }

    /* MODAL & PREMIUM FORMS */
    #reservationModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(31, 41, 55, 0.5); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: flex-start; z-index: 100; padding-top: 40px; padding-bottom: 40px; overflow-y: auto; }
    .modal-content { background: #F9FAFB; width: 100%; max-width: 800px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid #E5E7EB; overflow: hidden; position: relative; margin-bottom: 40px; }
    .modal-header { background: white; padding: 20px 30px; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 20px; font-weight: 800; color: #1F2937; margin: 0; }
    .close-modal { background: none; border: none; font-size: 28px; color: #9CA3AF; cursor: pointer; line-height: 1; }
    .close-modal:hover { color: #1F2937; }
    .modal-body { padding: 30px; }
    .summary-box { background: white; border-radius: 16px; padding: 20px; border: 1px solid #E5E7EB; margin-bottom: 25px; display: flex; flex-direction: row; gap: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .summary-left { flex: 1; }
    .summary-right { min-width: 150px; text-align: right; display: flex; flex-direction: column; justify-content: center; border-left: 1px dashed #E5E7EB; padding-left: 20px; }
    .sum-row { margin-bottom: 6px; font-size: 14px; color: #4B5563; display: flex; align-items: center; gap: 8px; }
    .sum-icon { color: #6B7280; font-size: 16px; width: 20px; text-align: center; }
    .sum-total-label { font-size: 12px; color: #6B7280; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
    .sum-total-price { font-size: 28px; font-weight: 800; color: #10B981; letter-spacing: -0.5px; }
    .traveler-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid #F3F4F6; padding: 20px; margin-bottom: 20px; transition: transform 0.2s; }
    .traveler-card:hover { border-color: #E5E7EB; transform: translateY(-2px); }
    .t-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #F3F4F6; padding-bottom: 10px; }
    .t-icon { font-size: 18px; background: #eff6ff; color: #3b82f6; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .t-title { font-weight: 700; font-size: 15px; color: #1F2937; }
    .form-group { margin-bottom: 5px; }
    .modern-label { display: block; font-size: 12px; font-weight: 700; color: #374151; margin-bottom: 5px; margin-left: 2px; }
    .modern-input { width: 100%; height: 48px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; padding: 0 16px; font-size: 14px; color: #111827; outline: none; transition: all 0.2s; box-shadow: none; }
    .modern-input:focus { background: white; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .modern-input::placeholder { color: #9CA3AF; }
    details.flight-accordion { background: white; border-radius: 14px; border: 1px solid #E5E7EB; overflow: hidden; margin-top: 25px; }
    details.flight-accordion summary { padding: 16px 20px; font-weight: 700; font-size: 15px; color: #1F2937; cursor: pointer; background: #F9FAFB; list-style: none; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
    details.flight-accordion summary:hover { background: #f3f4f6; }
    details.flight-accordion summary::-webkit-details-marker { display: none; }
    details.flight-accordion[open] summary { border-bottom: 1px solid #E5E7EB; background: white; color: #3b82f6; }
    .accordion-content { padding: 20px; background: white; }
    .confirm-btn { width: 100%; height: 52px; margin-top: 30px; background: linear-gradient(135deg, #10B981, #059669); color: white; font-size: 16px; font-weight: 700; border: none; border-radius: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(16,185,129,0.3); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .confirm-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(16,185,129,0.4); }
    .microcopy { text-align: center; font-size: 12px; color: #9CA3AF; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; }

    /* LANGUAGE SWITCHER */
    .lang-switcher select {
        padding: 5px 10px; border-radius: 8px; border: 1px solid #cbd5e1;
        background: white; font-weight: bold; font-size: 13px; color: #374151;
        cursor: pointer; box-shadow: none; width: auto;
    }
  </style>
</head>
<body>
  
  <div class="page">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h1 style="margin: 0;" data-i18n="appTitle">B2B Booking Console</h1>
        <div id="agentInfo" style="display: flex; align-items: center; gap: 15px; font-size: 15px; font-weight: 600;">
            <div class="lang-switcher">
                <select id="languageSelect" onchange="changeLanguage(this.value)">
                    <option value="en">üá∫üá∏ EN</option>
                    <option value="ru">üá∑üá∫ RU</option>
                </select>
            </div>
            <span id="agentNameDisplay" style="color: #1d4ed8;"></span>
            <button onclick="logout()" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;" data-i18n="logout">Logout</button>
        </div>
    </div>
    <div class="subtitle" data-i18n="appSubtitle">Advanced multi-hotel configuration, real-time pricing, and instant booking capabilities.</div>

    <div class="tabs">
        <button class="tab-btn active" data-view="booking" onclick="showAgentView('booking')" data-i18n="tabNewBooking">üìù New Reservation</button>
        <button class="tab-btn" data-view="reservations" onclick="showAgentView('reservations')" data-i18n="tabMyRes">üóìÔ∏è My Reservations</button>
    </div>
    
    <div id="bookingView">
        <div class="card">
            <div class="section-title" style="margin-top: 0;" data-i18n="secTravelDate">üóìÔ∏è Travel Date & Guests</div>
            <div class="row" style="flex-wrap: wrap; align-items: flex-end;">
                <div style="flex:1; min-width: 150px;"><label data-i18n="lblCheckIn">Check-in</label><input type="date" id="checkIn" /></div>
                <div style="flex:1; min-width: 150px;"><label data-i18n="lblCheckOut">Check-out</label><input type="date" id="checkOut" /></div>
                <div style="flex:1; min-width: 100px;"><label data-i18n="lblAdults">Adults</label><input type="number" id="adults" min="1" value="2" /></div>
                <div style="flex:1; min-width: 100px;"><label data-i18n="lblChildren">Children</label><input type="number" id="children" min="0" value="0" /></div>
                
                <div style="flex:1; min-width: 120px;"><label data-i18n="lblResNum">Res. Number</label><input type="text" id="agentResNumber" data-i18n-ph="phOptional" placeholder="Optional" /></div>
                <div style="flex:1; min-width: 120px;"><label data-i18n="lblFlightNo">Flight No</label><input type="text" id="agentFlightNumber" placeholder="J2-001" /></div>
                
                <div style="min-width: 150px; margin-left: auto; display: flex; justify-content: flex-end;">
                    <div class="pill"><span data-i18n="lblTotalNights">Total Nights:</span>&nbsp;<span id="nights">0</span></div>
                </div>
            </div>
        </div>

        <div class="main-content-grid">
            <div class="sticky-sidebar">
                <div class="card" style="margin-bottom: 25px;">
                    <div class="section-title" style="margin-top: 0; margin-bottom: 15px; border-left-color: #9333ea;" data-i18n="secFilter">üîç Filter Hotels</div>
                    <div class="filter-header" data-i18n="lblRegions">Regions</div>
                    <div class="filter-box" id="regionsBox" style="margin-bottom: 20px;"></div>
                    <div class="filter-header" data-i18n="lblStars">Stars</div>
                    <div class="filter-box" id="starsBox"></div>
                </div>
            </div>

            <div>
                <div class="card">
                    <div class="section-title" style="margin-top: 0; border-left-color: #f59e0b;" data-i18n="secFilteredHotels">üè® Filtered Hotel Selection</div>
                    <div class="filter-box" id="hotelsBox" style="max-height: 250px; border: none; background: transparent; padding: 0;"></div>
                </div>
                
                <div class="section-title" style="margin-top: 25px;" data-i18n="secConfig">‚öôÔ∏è Selected Hotels Configuration</div>
                <div id="hotelsCalcs">
                    <p style="color: #6b7280; font-style: italic; font-size: 15px; padding-left: 15px;" data-i18n="msgSelectHotel">Please select a hotel from the list above.</p>
                </div>
            </div>
            
            <div class="sticky-sidebar">
                <div class="totals-card">
                    <div class="totals-row"><span data-i18n="sumSelected">Selected Hotels:</span><span id="selectedHotelsCount" style="font-weight: 700;">0</span></div>
                    <div class="totals-row"><span data-i18n="sumRooms">Rooms</span><span id="roomsSubtotal">0 $</span></div>
                    <div class="totals-row"><span data-i18n="sumExtra">Extra beds</span><span id="extraBedsTotal">0 $</span></div>
                    <div class="totals-row"><span data-i18n="sumMeals">Meals</span><span id="mealsTotal">0 $</span></div>
                    <hr style="border-top: 1px solid rgba(148,163,184,0.4); margin: 10px 0;">
                    <div class="totals-row"><strong data-i18n="sumHotelsTotal">Hotels Total</strong><strong id="hotelSubtotal">0 $</strong></div>
                    <div class="totals-row" style="margin-bottom: 20px;">
                        <span data-i18n="sumOps">Operations (Transfer)</span><span id="operationsTotal">0 $</span>
                    </div>
                    <div class="grand"><span data-i18n="sumTotal">Total:</span> <span id="grandTotal">0 $</span></div>
                    <button id="reserveBtn" disabled onclick="openReservationModal()" data-i18n="btnSendRes">Send Reservation</button>
                </div>
                
                <div class="card" style="margin-top: 25px; padding: 18px;">
                    <div class="section-title" style="margin-top: 0; margin-bottom: 12px; border-left-color: #f59e0b;" data-i18n="secOps">‚úàÔ∏è Operations / Transfer</div>
                    
                    <div class="op-master-controls">
                        <div class="op-master-btn" id="masterSedanBtn">
                            <div class="op-master-label" data-i18n="lblSedan">Sedan</div>
                            <div class="op-master-actions">
                                <button class="op-master-action-btn" onclick="adjustMasterQty('sedan', -1)">-</button>
                                <span id="masterSedanVal" style="font-weight:700; min-width:15px; text-align:center;">0</span>
                                <button class="op-master-action-btn" onclick="adjustMasterQty('sedan', 1)">+</button>
                            </div>
                        </div>
                        <div class="op-master-btn" id="masterMinivanBtn">
                            <div class="op-master-label" data-i18n="lblMinivan">Minivan</div>
                            <div class="op-master-actions">
                                <button class="op-master-action-btn" onclick="adjustMasterQty('minivan', -1)">-</button>
                                <span id="masterMinivanVal" style="font-weight:700; min-width:15px; text-align:center;">0</span>
                                <button class="op-master-action-btn" onclick="adjustMasterQty('minivan', 1)">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <p style="font-size:12px; color:#6b7280; margin-bottom:8px;" data-i18n="msgOpsInst">Select transfers below (Multiple allowed), then adjust quantity above:</p>
                    
                    <div class="op-list-container" id="operationsList"></div>
                    <div id="hiddenOperationsData" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reservationsView" style="display: none;">
        <div class="card" style="padding: 0;">
            <div class="agent-res-header">
                <div># ID</div>
                <div data-i18n="colDate">Date</div>
                <div data-i18n="colHotels">Hotels</div>
                <div data-i18n="colStatus">Status</div>
                <div style="text-align: right;" data-i18n="colPrice">Price</div>
                <div data-i18n="colEdit">Edit</div>
                <div data-i18n="colCancel">Cancel</div>
            </div>
            <div id="agentReservationsList"></div>
        </div>
    </div>

  <div id="reservationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="modalTitle">Reservation Confirmation</h2>
        <button onclick="closeReservationModal()" class="close-modal">√ó</button>
      </div>
      <div class="modal-body">
        
        <div id="reservationSummary"></div> 

        <form id="reservationForm">
          <div id="travelersForm"></div>
          
          <details class="flight-accordion">
              <summary><span data-i18n="secFlightInfo">‚úàÔ∏è Flight Information (Optional)</span></summary>
              <div class="accordion-content">
                  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                      <div class="form-group"><label class="modern-label" data-i18n="lblArrDate">Arrival Date</label><input type="date" class="modern-input" name="flightArrivalDate" /></div>
                      <div class="form-group"><label class="modern-label" data-i18n="lblArrTime">Arrival Time</label><select class="modern-input" name="flightArrivalTime" id="arrTimeSelect"></select></div>
                      <div class="form-group"><label class="modern-label" data-i18n="lblDepDate">Departure Date</label><input type="date" class="modern-input" name="flightDepartureDate" /></div>
                      <div class="form-group"><label class="modern-label" data-i18n="lblDepTime">Departure Time</label><select class="modern-input" name="flightDepartureTime" id="depTimeSelect"></select></div>
                  </div>
              </div>
          </details>

          <button type="submit" id="confirmReserveBtn" class="confirm-btn" data-i18n="btnConfirmRes">Confirm Reservation</button>
          <div class="microcopy" data-i18n="msgSecure">üîí All data is stored securely</div>
        </form>
      </div>
    </div>
  </div>

  <div id="editDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.6); display: none; justify-content: center; align-items: center; z-index: 102;">
      <div style="background: white; padding: 25px; border-radius: 16px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
          <h3 style="margin-top: 0; margin-bottom: 5px;" data-i18n="modalEditTitle">Full Edit: Details</h3>
          <p style="font-size: 13px; color: #666; margin-bottom: 20px;" data-i18n="msgEditDesc">Update guest information and flight details.</p>
          <input type="hidden" id="editDetailResId">
          <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
             <h4 style="margin:0 0 10px 0; font-size:14px;" data-i18n="secDateChange">Date Change</h4>
             <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div><label data-i18n="lblCheckIn">Check-in</label><input type="date" id="editDetailCheckIn"></div>
                <div><label data-i18n="lblCheckOut">Check-out</label><input type="date" id="editDetailCheckOut"></div>
             </div>
          </div>
          <div id="editTravelersContainer"></div>
          <div class="section-title" style="font-size: 15px; margin-top: 20px;" data-i18n="secFlightInfo">‚úàÔ∏è Flight Information</div>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
             <div style="grid-column: span 2;"><label data-i18n="lblFlightNo">Flight Number</label><input type="text" id="editDetailFlightNo"></div>
             <div><label data-i18n="lblArrDate">Arrival Date</label><input type="date" id="editDetailArrDate"></div>
             <div><label data-i18n="lblArrTime">Arrival Time</label><input type="text" id="editDetailArrTime"></div>
             <div><label data-i18n="lblDepDate">Departure Date</label><input type="date" id="editDetailDepDate"></div>
             <div><label data-i18n="lblDepTime">Departure Time</label><input type="text" id="editDetailDepTime"></div>
          </div>
          <div style="margin-top: 25px; display: flex; gap: 10px;">
              <button onclick="closeEditDetailsModal()" style="flex: 1; padding: 12px; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer;" data-i18n="btnCancel">Cancel</button>
              <button onclick="submitEditDetails()" style="flex: 1; padding: 12px; border: none; background: #3b82f6; color: white; border-radius: 8px; font-weight: bold; cursor: pointer;" data-i18n="btnSave">Save</button>
          </div>
      </div>
  </div>

  <script>
    // --- TRANSLATION DICTIONARY ---
    const translations = {
        en: {
            appTitle: "B2B Booking Console",
            appSubtitle: "Advanced multi-hotel configuration, real-time pricing, and instant booking capabilities.",
            logout: "Logout",
            tabNewBooking: "üìù New Reservation",
            tabMyRes: "üóìÔ∏è My Reservations",
            secTravelDate: "üóìÔ∏è Travel Date & Guests",
            lblCheckIn: "Check-in",
            lblCheckOut: "Check-out",
            lblAdults: "Adults",
            lblChildren: "Children",
            lblResNum: "Res. Number",
            lblFlightNo: "Flight No",
            lblTotalNights: "Total Nights:",
            phOptional: "Optional",
            secFilter: "üîç Filter Hotels",
            lblRegions: "Regions",
            lblStars: "Stars",
            secFilteredHotels: "üè® Filtered Hotel Selection",
            secConfig: "‚öôÔ∏è Selected Hotels Configuration",
            msgSelectHotel: "Please select a hotel from the list above.",
            sumSelected: "Selected Hotels:",
            sumRooms: "Rooms",
            sumExtra: "Extra beds",
            sumMeals: "Meals",
            sumHotelsTotal: "Hotels Total",
            sumOps: "Operations (Transfer)",
            sumTotal: "Total:",
            btnSendRes: "Send Reservation",
            secOps: "‚úàÔ∏è Operations / Transfer",
            lblSedan: "Sedan",
            lblMinivan: "Minivan",
            msgOpsInst: "Select transfers below (Multiple allowed), then adjust quantity above:",
            colDate: "Date",
            colHotels: "Hotels",
            colStatus: "Status",
            colPrice: "Price",
            colEdit: "Edit",
            colCancel: "Cancel",
            modalTitle: "Reservation Confirmation",
            secFlightInfo: "‚úàÔ∏è Flight Information (Optional)",
            lblArrDate: "Arrival Date",
            lblArrTime: "Arrival Time",
            lblDepDate: "Departure Date",
            lblDepTime: "Departure Time",
            btnConfirmRes: "Confirm Reservation",
            msgSecure: "üîí All data is stored securely",
            modalEditTitle: "Full Edit: Details",
            msgEditDesc: "Update guest information and flight details.",
            secDateChange: "Date Change",
            btnCancel: "Cancel",
            btnSave: "Save",
            // New Label
            lblRoomQty: "Rooms",
            
            // JS Dynamic Strings
            opNone: "No operations available.",
            selRoom: "Select Room...",
            nightMismatch: "‚ö†Ô∏è Night mismatch: Trip is {n} nights, but {b} nights booked.",
            resSuccess: "Reservation successful! ID: ",
            loading: "Loading...",
            noResFound: "No reservations found.",
            statusPending: "Pending",
            statusConfirmed: "Confirmed",
            statusCancelled: "Cancelled",
            statusEdit: "Edited",
            statusCancelReq: "Cancel Requested",
            alertCancel: "Are you sure you want to cancel this reservation?",
            alertSent: "Cancel request sent!",
            alertSaved: "Changes saved!",
            lblTotalAmount: "Total Amount",
            lblName: "Name",
            lblSurname: "Surname",
            lblDob: "Date of Birth",
            lblNat: "Nationality",
            phName: "Enter Name",
            phSurname: "Enter Surname",
            phNat: "e.g. USA",
            lblAdult: "Adult",
            lblChild: "Child"
        },
        ru: {
            appTitle: "B2B –ö–æ–Ω—Å–æ–ª—å –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
            appSubtitle: "–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç–µ–ª–µ–π, —Ü–µ–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.",
            logout: "–í—ã–π—Ç–∏",
            tabNewBooking: "üìù –ù–æ–≤–æ–µ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
            tabMyRes: "üóìÔ∏è –ú–æ–∏ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
            secTravelDate: "üóìÔ∏è –î–∞—Ç—ã –∏ –ì–æ—Å—Ç–∏",
            lblCheckIn: "–ó–∞–µ–∑–¥",
            lblCheckOut: "–í—ã–µ–∑–¥",
            lblAdults: "–í–∑—Ä–æ—Å–ª—ã–µ",
            lblChildren: "–î–µ—Ç–∏",
            lblResNum: "–ù–æ–º–µ—Ä –†–µ–∑–µ—Ä–≤–∞",
            lblFlightNo: "–ù–æ–º–µ—Ä –†–µ–π—Å–∞",
            lblTotalNights: "–í—Å–µ–≥–æ –ù–æ—á–µ–π:",
            phOptional: "–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ",
            secFilter: "üîç –§–∏–ª—å—Ç—Ä –û—Ç–µ–ª–µ–π",
            lblRegions: "–†–µ–≥–∏–æ–Ω—ã",
            lblStars: "–ó–≤–µ–∑–¥—ã",
            secFilteredHotels: "üè® –í—ã–±–æ—Ä –û—Ç–µ–ª–µ–π",
            secConfig: "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –í—ã–±—Ä–∞–Ω–Ω—ã—Ö –û—Ç–µ–ª–µ–π",
            msgSelectHotel: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–µ–ª—å –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.",
            sumSelected: "–í—ã–±—Ä–∞–Ω–æ –æ—Ç–µ–ª–µ–π:",
            sumRooms: "–ù–æ–º–µ—Ä–∞",
            sumExtra: "–î–æ–ø. –∫—Ä–æ–≤–∞—Ç–∏",
            sumMeals: "–ü–∏—Ç–∞–Ω–∏–µ",
            sumHotelsTotal: "–ò—Ç–æ–≥–æ –û—Ç–µ–ª–∏",
            sumOps: "–û–ø–µ—Ä–∞—Ü–∏–∏ (–¢—Ä–∞–Ω—Å—Ñ–µ—Ä)",
            sumTotal: "–ò—Ç–æ–≥–æ:",
            btnSendRes: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
            secOps: "‚úàÔ∏è –û–ø–µ—Ä–∞—Ü–∏–∏ / –¢—Ä–∞–Ω—Å—Ñ–µ—Ä",
            lblSedan: "–°–µ–¥–∞–Ω",
            lblMinivan: "–ú–∏–Ω–∏–≤—ç–Ω",
            msgOpsInst: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã –Ω–∏–∂–µ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ), –∑–∞—Ç–µ–º –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—à–µ:",
            colDate: "–î–∞—Ç–∞",
            colHotels: "–û—Ç–µ–ª–∏",
            colStatus: "–°—Ç–∞—Ç—É—Å",
            colPrice: "–¶–µ–Ω–∞",
            colEdit: "–†–µ–¥.",
            colCancel: "–û—Ç–º–µ–Ω–∞",
            modalTitle: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
            secFlightInfo: "‚úàÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
            lblArrDate: "–î–∞—Ç–∞ –ü—Ä–∏–±—ã—Ç–∏—è",
            lblArrTime: "–í—Ä–µ–º—è –ü—Ä–∏–±—ã—Ç–∏—è",
            lblDepDate: "–î–∞—Ç–∞ –í—ã–ª–µ—Ç–∞",
            lblDepTime: "–í—Ä–µ–º—è –í—ã–ª–µ—Ç–∞",
            btnConfirmRes: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
            msgSecure: "üîí –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–¥–µ–∂–Ω–æ –∑–∞—â–∏—â–µ–Ω—ã",
            modalEditTitle: "–ü–æ–ª–Ω–æ–µ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            msgEditDesc: "–û–±–Ω–æ–≤–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç—è—Ö –∏ –¥–µ—Ç–∞–ª—è—Ö —Ä–µ–π—Å–∞.",
            secDateChange: "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –î–∞—Ç",
            btnCancel: "–û—Ç–º–µ–Ω–∞",
            btnSave: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
            // New Label
            lblRoomQty: "–ù–æ–º–µ—Ä–∞",

            // JS Dynamic Strings
            opNone: "–û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.",
            selRoom: "–í—ã–±–µ—Ä–∏—Ç–µ –ù–æ–º–µ—Ä...",
            nightMismatch: "‚ö†Ô∏è –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—á–µ–π: –ü–æ–µ–∑–¥–∫–∞ {n} –Ω–æ—á–µ–π, –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ {b}.",
            resSuccess: "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! ID: ",
            loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
            noResFound: "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
            statusPending: "–û–∂–∏–¥–∞–Ω–∏–µ",
            statusConfirmed: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ",
            statusCancelled: "–û—Ç–º–µ–Ω–µ–Ω–æ",
            statusEdit: "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ",
            statusCancelReq: "–ó–∞–ø—Ä–æ—Å –û—Ç–º–µ–Ω—ã",
            alertCancel: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?",
            alertSent: "–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!",
            alertSaved: "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!",
            lblTotalAmount: "–û–±—â–∞—è –°—É–º–º–∞",
            lblName: "–ò–º—è",
            lblSurname: "–§–∞–º–∏–ª–∏—è",
            lblDob: "–î–∞—Ç–∞ –†–æ–∂–¥–µ–Ω–∏—è",
            lblNat: "–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ",
            phName: "–í–≤–µ–¥–∏—Ç–µ –ò–º—è",
            phSurname: "–í–≤–µ–¥–∏—Ç–µ –§–∞–º–∏–ª–∏—é",
            phNat: "–Ω–∞–ø—Ä. –†–æ—Å—Å–∏—è",
            lblAdult: "–í–∑—Ä–æ—Å–ª—ã–π",
            lblChild: "–†–µ–±–µ–Ω–æ–∫"
        }
    };

    let currentLang = localStorage.getItem('b2b_lang') || 'en';
    
    function t(key) { return translations[currentLang][key] || key; }

    function changeLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('b2b_lang', lang);
        updateTexts();
    }

    function updateTexts() {
        document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t(el.getAttribute('data-i18n')); });
        document.querySelectorAll('[data-i18n-ph]').forEach(el => { el.placeholder = t(el.getAttribute('data-i18n-ph')); });
        document.getElementById('languageSelect').value = currentLang;
        renderOperations();
        recalcTotals(); 
        if(document.getElementById('reservationsView').style.display === 'block') loadMyRes();
    }

    const LOGGED_IN_AGENT = JSON.parse(localStorage.getItem('b2b_agent_auth'));
    if (!LOGGED_IN_AGENT || !LOGGED_IN_AGENT.success) window.location.href = 'login.html'; 
    else document.getElementById('agentNameDisplay').textContent = LOGGED_IN_AGENT.name;
    function logout() { localStorage.removeItem('b2b_agent_auth'); window.location.href = 'login.html'; }

    let dbData = { regions: [], hotels: [], operations: [], reservations: [] };
    const dateFormatter = new Intl.DateTimeFormat('az-AZ', { day: '2-digit', month: 'short', year: 'numeric' });
    function formatMoney(v) { return (Math.round((v + Number.EPSILON) * 100) / 100).toLocaleString() + ' $'; }

    let selectedOpIds = new Set(); 
    let globalSedanCount = 0;
    let globalMinivanCount = 0;

    function renderOperations() {
      const listContainer = document.getElementById('operationsList');
      const hiddenContainer = document.getElementById('hiddenOperationsData');
      listContainer.innerHTML = ''; hiddenContainer.innerHTML = ''; 
      if (!dbData.operations || dbData.operations.length === 0) { listContainer.innerHTML = `<span style="font-size:13px;color:#6b7280; font-style: italic;">${t('opNone')}</span>`; return; }
      dbData.operations.forEach(op => {
        const isSelected = selectedOpIds.has(op.id);
        const row = document.createElement('div'); row.className = `op-select-row ${isSelected ? 'selected' : ''}`;
        row.onclick = () => toggleOperation(op.id);
        row.innerHTML = `<div class="op-select-row-name"><div class="op-checkbox"></div>${op.name}</div><div class="op-select-row-prices">S: ${op.priceSedan}$ | M: ${op.priceMinivan}$<div id="vis_qty_${op.id}" style="color:#10b981; font-weight:bold; height:15px; margin-top:2px;">${isSelected && (globalSedanCount > 0 || globalMinivanCount > 0) ? `${globalSedanCount} ${t('lblSedan')}, ${globalMinivanCount} ${t('lblMinivan')}` : ''}</div></div>`;
        listContainer.appendChild(row);
        const wrapper = document.createElement('div'); wrapper.id = `hidden_op_wrap_${op.id}`;
        const sedanInp = document.createElement('span'); sedanInp.id = `op_${op.id}_sedan`; sedanInp.className = 'op-qty-input'; sedanInp.dataset.price = op.priceSedan; sedanInp.dataset.opName = op.name; sedanInp.dataset.type = 'Sedan'; sedanInp.textContent = isSelected ? globalSedanCount : '0'; 
        const minivanInp = document.createElement('span'); minivanInp.id = `op_${op.id}_minivan`; minivanInp.className = 'op-qty-input'; minivanInp.dataset.price = op.priceMinivan; minivanInp.dataset.opName = op.name; minivanInp.dataset.type = 'Minivan'; minivanInp.textContent = isSelected ? globalMinivanCount : '0';
        wrapper.appendChild(sedanInp); wrapper.appendChild(minivanInp); hiddenContainer.appendChild(wrapper);
      });
      document.getElementById('masterSedanVal').textContent = globalSedanCount;
      document.getElementById('masterMinivanVal').textContent = globalMinivanCount;
      document.querySelector('#masterSedanBtn .op-master-label').textContent = t('lblSedan');
      document.querySelector('#masterMinivanBtn .op-master-label').textContent = t('lblMinivan');
      if (selectedOpIds.size > 0) { document.getElementById('masterSedanBtn').classList.add('active-type'); document.getElementById('masterMinivanBtn').classList.add('active-type'); } 
      else { document.getElementById('masterSedanBtn').classList.remove('active-type'); document.getElementById('masterMinivanBtn').classList.remove('active-type'); }
    }
    function toggleOperation(id) { if (selectedOpIds.has(id)) { selectedOpIds.delete(id); } else { selectedOpIds.add(id); } renderOperations(); recalcTotals(); }
    function adjustMasterQty(type, delta) { if (selectedOpIds.size === 0) { alert(t('msgOpsInst')); return; } if (type === 'sedan') { const newVal = globalSedanCount + delta; if (newVal >= 0) globalSedanCount = newVal; } else if (type === 'minivan') { const newVal = globalMinivanCount + delta; if (newVal >= 0) globalMinivanCount = newVal; } renderOperations(); recalcTotals(); }

    function fetchData() { fetch('/api/data').then(r => r.json()).then(data => { dbData = data; renderRegions(); renderStars(); renderHotelsFilter(); renderOperations(); populateTimeSelects(); updateTexts(); }).catch(console.error); }
    function renderRegions() { const box = document.getElementById('regionsBox'); box.innerHTML = ''; dbData.regions.forEach(r => { const lbl = document.createElement('label'); lbl.className = 'filter-item'; lbl.innerHTML = `<input type="checkbox" name="regionFilter" value="${r.id}" onchange="onFilterChange()"> ${r.name}`; box.appendChild(lbl); }); }
    function renderStars() { const box = document.getElementById('starsBox'); box.innerHTML = ''; [2,3,4,5].forEach(s => { const lbl = document.createElement('label'); lbl.className = 'filter-item'; lbl.innerHTML = `<input type="checkbox" name="starFilter" value="${s}" onchange="onFilterChange()"> ${s}‚òÖ`; box.appendChild(lbl); }); }
    function onFilterChange() { renderHotelsFilter(); renderHotelBlocks(); recalcTotals(); }
    function filterHotels() { const regs = Array.from(document.querySelectorAll('input[name="regionFilter"]:checked')).map(e=>e.value); const stars = Array.from(document.querySelectorAll('input[name="starFilter"]:checked')).map(e=>e.value); return dbData.hotels.filter(h => (regs.length===0 || regs.includes(String(h.regionId))) && (stars.length===0 || stars.includes(String(h.stars)))); }
    function renderHotelsFilter() { const box = document.getElementById('hotelsBox'); box.innerHTML = ''; filterHotels().forEach(h => { const lbl = document.createElement('label'); lbl.className = 'hotel-item'; lbl.innerHTML = `<input type="checkbox" name="hotelFilter" value="${h.id}" onchange="renderHotelBlocks();recalcTotals()"> <span class="hotel-name">${h.name}</span> <span class="hotel-stars">${'‚òÖ'.repeat(h.stars)}</span>`; box.appendChild(lbl); }); }
    
    function renderHotelBlocks() {
        const container = document.getElementById('hotelsCalcs'); container.innerHTML = '';
        const selectedIds = Array.from(document.querySelectorAll('input[name="hotelFilter"]:checked')).map(e=>e.value);
        document.getElementById('selectedHotelsCount').textContent = selectedIds.length;
        if(selectedIds.length === 0) { container.innerHTML = `<p style="color:#6b7280;font-style:italic;font-size:15px;padding-left:15px;">${t('msgSelectHotel')}</p>`; return; }
        selectedIds.forEach(id => {
            const h = dbData.hotels.find(x => String(x.id) === id); if(!h) return;
            const div = document.createElement('div'); div.className = 'hotel-block';
            const ebPriceDisplay = (h.extraBedPricePerNight || 0) + ' $';
            div.innerHTML = `<div class="hotel-block-title">${h.name} <span class="tag">Extra: ${ebPriceDisplay}</span></div><div id="rooms_h${h.id}"></div><div style="margin-top:10px;"><button class="add-room-btn" onclick="addRoom(${h.id})">+ Room</button></div><div id="meals_h${h.id}" style="margin-top:15px;"></div><div class="hotel-totals-line"><span>Subtotal:</span> <span id="hotelTotal_h${h.id}">0 $</span></div>`;
            container.appendChild(div); renderMeals(h); addRoom(h.id);
        });
    }

    function addRoom(hotelId) {
        const h = dbData.hotels.find(x => x.id === hotelId);
        const div = document.createElement('div'); div.className = 'room-row';
        let opts = `<option value="">${t('selRoom')}</option>` + h.roomTypes.map(r => `<option value="${r.id}" data-eb="${r.isExtraBedAllowed}">${r.name}</option>`).join('');
        
        // Added Label next to qty-controls
        div.innerHTML = `<select class="room-type-select" onchange="recalcTotals()">${opts}</select><div style="display:flex; align-items:center; gap:5px;"><span style="font-size:12px; font-weight:700; color:#4b5563;" data-i18n="lblRoomQty">${t('lblRoomQty')}</span><div class="qty-controls"><button type="button" class="qty-btn" onclick="adjQty(this,-1)">‚Äî</button><span class="qty-value">1</span><button type="button" class="qty-btn" onclick="adjQty(this,1)">+</button></div></div><label class="extra-bed-container" style="display:none; margin-left:10px; font-size:13px; font-weight:700; color:#10b981;"><input type="checkbox" class="extra-bed-checkbox" onchange="recalcTotals()"> Extra Bed</label><button type="button" class="room-remove" onclick="this.parentElement.remove();recalcTotals()">√ó</button>`;
        
        document.getElementById(`rooms_h${hotelId}`).appendChild(div);
        div.querySelector('select').addEventListener('change', function() { const opt = this.options[this.selectedIndex]; div.querySelector('.extra-bed-container').style.display = (opt.dataset.eb === 'true') ? 'flex' : 'none'; });
    }
    function adjQty(btn, delta) { const span = btn.parentElement.querySelector('.qty-value'); let v = parseInt(span.textContent) + delta; if(v < 1) v = 1; span.textContent = v; recalcTotals(); }
    function renderMeals(h) { const c = document.getElementById(`meals_h${h.id}`); c.innerHTML = `<div style="font-weight:600;font-size:14px;margin-bottom:5px;">Meal Plan:</div><label style="margin-right:10px;display:inline-flex;gap:5px;"><input type="radio" name="meal_${h.id}" value="0" checked onchange="recalcTotals()"> None</label>` + h.mealPlans.map(m => `<label style="margin-right:10px;display:inline-flex;gap:5px;"><input type="radio" name="meal_${h.id}" value="${m.pricePerPersonPerNight}" onchange="recalcTotals()"> ${m.name} (${m.pricePerPersonPerNight}$)</label>`).join(''); }
    function getMaxNights() { const d1 = new Date(document.getElementById('checkIn').value); const d2 = new Date(document.getElementById('checkOut').value); if(d1 && d2 && d2 > d1) { const n = Math.round((d2-d1)/(1000*60*60*24)); document.getElementById('nights').textContent = n; return n; } document.getElementById('nights').textContent = 0; return 0; }
    
    // --- SEASONAL PRICING HELPER (YENƒ∞ M∆èNTƒ∞Q) ---
    function calculateTotalRoomPrice(room, checkInStr, checkOutStr) {
        if (!checkInStr || !checkOutStr) return 0;
        const start = new Date(checkInStr);
        const end = new Date(checkOutStr);
        if (start >= end) return 0;

        let total = 0;
        const current = new Date(start);

        // Tarix √ºzr…ô iterasiya edirik (Gec…ô sayƒ± q…ôd…ôr)
        while (current < end) {
            const dateStr = current.toISOString().split('T')[0];
            let dailyPrice = Number(room.pricePerNight) || 0; 
            
            // M√∂vs√ºmi qiym…ôt yoxlanƒ±≈üƒ±
            if (room.seasonalPrices && Array.isArray(room.seasonalPrices)) {
                 const season = room.seasonalPrices.find(s => {
                     return dateStr >= s.start && dateStr <= s.end;
                 });
                 if (season) dailyPrice = Number(season.price);
            }
            
            total += dailyPrice;
            current.setDate(current.getDate() + 1); // N√∂vb…ôti g√ºn…ô ke√ß
        }
        return total;
    }

    // --- RECALC TOTALS (YENƒ∞L∆èNMƒ∞≈û) ---
    function recalcTotals() {
        const nights = getMaxNights(); 
        const checkInVal = document.getElementById('checkIn').value;
        const checkOutVal = document.getElementById('checkOut').value;
        const pax = (parseInt(document.getElementById('adults').value) || 0) + (parseInt(document.getElementById('children').value) || 0);
        
        let rTot = 0, ebTot = 0, mTot = 0, opTot = 0; let totalBookedNights = 0;
        
        // Operations
        document.querySelectorAll('.op-qty-input').forEach(el => { opTot += (parseInt(el.textContent) || 0) * (parseFloat(el.dataset.price) || 0); });
        
        // Hotels
        document.querySelectorAll('.hotel-block').forEach(hb => {
            const hid = hb.querySelector('.add-room-btn').getAttribute('onclick').match(/\d+/)[0]; 
            const h = dbData.hotels.find(x => String(x.id) === hid); 
            if(!h) return;
            let thisHTot = 0;
            
            // Rooms & Extra Beds
            hb.querySelectorAll('.room-row').forEach(rr => { 
                const sel = rr.querySelector('select'); 
                if(sel.value) { 
                    const q = parseInt(rr.querySelector('.qty-value').textContent) || 0; 
                    
                    // Room Price Calculation (Seasonal)
                    const roomObj = h.roomTypes.find(rt => String(rt.id) === sel.value);
                    const totalRoomCost = roomObj ? calculateTotalRoomPrice(roomObj, checkInVal, checkOutVal) : 0;
                    
                    const ebPrice = parseFloat(h.extraBedPricePerNight) || 0;
                    const totalEbCost = rr.querySelector('.extra-bed-checkbox').checked ? (ebPrice * nights) : 0; 
                    
                    rTot += totalRoomCost * q; 
                    ebTot += totalEbCost * q; 
                    thisHTot += (totalRoomCost + totalEbCost) * q; 
                    totalBookedNights += q; 
                } 
            });
            
            // Meals
            const mInput = document.querySelector(`input[name="meal_${hid}"]:checked`);
            const mPrice = mInput ? (parseFloat(mInput.value) || 0) : 0;
            if(mPrice > 0) { 
                const hasAnyRoom = Array.from(hb.querySelectorAll('.room-row')).some(r => r.querySelector('select').value);
                if(hasAnyRoom) {
                     const mealCost = mPrice * pax * nights; 
                     mTot += mealCost; 
                     thisHTot += mealCost;
                }
            }
            document.getElementById(`hotelTotal_h${hid}`).textContent = formatMoney(thisHTot);
        });
        
        document.getElementById('roomsSubtotal').textContent = formatMoney(rTot); 
        document.getElementById('extraBedsTotal').textContent = formatMoney(ebTot); 
        document.getElementById('mealsTotal').textContent = formatMoney(mTot); 
        document.getElementById('hotelSubtotal').textContent = formatMoney(rTot + ebTot + mTot); 
        document.getElementById('operationsTotal').textContent = formatMoney(opTot); 
        document.getElementById('grandTotal').textContent = formatMoney(rTot + ebTot + mTot + opTot);
        
        const btn = document.getElementById('reserveBtn'); 
        
        // --- UPDATED LOGIC: REMOVED WARNING, ONLY DISABLE IF NO NIGHTS BOOKED ---
        btn.disabled = (totalBookedNights === 0);
    }
    
    function getSummary() {
        return {
            agentResNumber: document.getElementById('agentResNumber').value,
            flightNumber: document.getElementById('agentFlightNumber').value,
            checkIn: document.getElementById('checkIn').value, checkOut: document.getElementById('checkOut').value,
            nights: document.getElementById('nights').textContent, adults: document.getElementById('adults').value, children: document.getElementById('children').value,
            totalPrice: parseFloat(document.getElementById('grandTotal').textContent.replace(' $','').replace(/,/g,'')),
            hotelNames: Array.from(document.querySelectorAll('.hotel-block-title')).map(e => e.childNodes[0].textContent.trim()).join(', '),
            operationsInfo: Array.from(document.querySelectorAll('.op-qty-input')).filter(e=>parseInt(e.textContent)>0).map(e=> `${e.dataset.opName} (${e.dataset.type} x ${e.textContent})`).join(', ')
        };
    }

    function populateTimeSelects() {
        const selects = [document.getElementById('arrTimeSelect'), document.getElementById('depTimeSelect')];
        let opts = '<option value="">--:--</option>';
        for(let h=0; h<24; h++) { for(let m=0; m<60; m+=15) { const time = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; opts += `<option value="${time}">${time}</option>`; } }
        selects.forEach(s => s.innerHTML = opts);
    }

    // --- NEW MODAL LOGIC ---
    function openReservationModal() {
        const s = getSummary();
        const summaryDiv = document.getElementById('reservationSummary');
        
        const opsLine = (!s.operationsInfo || s.operationsInfo === '') ? '' : `<div class="sum-row"><span class="sum-icon">üöê</span> ${s.operationsInfo}</div>`;
        const resLine = (!s.agentResNumber) ? '' : `<div class="sum-row"><span class="sum-icon">üîñ</span> Ref: <b>${s.agentResNumber}</b></div>`;
        const flightLine = (!s.flightNumber) ? '' : `<div class="sum-row"><span class="sum-icon">‚úàÔ∏è</span> Flight: <b>${s.flightNumber}</b></div>`;

        summaryDiv.innerHTML = `
          <div class="summary-box">
             <div class="summary-left">
                <div class="sum-row" style="color:#1F2937; font-weight:700; font-size:16px; margin-bottom:12px;">
                   <span class="sum-icon">üè®</span> ${s.hotelNames}
                </div>
                <div class="sum-row"><span class="sum-icon">üìÖ</span> ${s.checkIn} ‚Äî ${s.checkOut} (${s.nights} nights)</div>
                <div class="sum-row"><span class="sum-icon">üë•</span> ${s.adults} Ad, ${s.children} Chd</div>
                ${resLine}
                ${flightLine}
                ${opsLine}
             </div>
             <div class="summary-right">
                <div class="sum-total-label">${t('lblTotalAmount')}</div>
                <div class="sum-total-price">${formatMoney(s.totalPrice)}</div>
             </div>
          </div>
        `;

        const tf = document.getElementById('travelersForm'); tf.innerHTML = '';
        for(let i=0; i<parseInt(s.adults); i++) tf.innerHTML += genTravelerCard(t('lblAdult'), i);
        for(let i=0; i<parseInt(s.children); i++) tf.innerHTML += genTravelerCard(t('lblChild'), i);
        
        document.getElementById('reservationModal').style.display = 'flex';
    }

    function genTravelerCard(type, i) {
        return `
        <div class="traveler-card">
            <div class="t-card-header">
                <div class="t-icon">${type === t('lblAdult') ? 'üë§' : 'üë∂'}</div>
                <div class="t-title">${type} ${i+1}</div>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
                <div class="form-group"><label class="modern-label">${t('lblName')}</label><input class="modern-input" placeholder="${t('phName')}" name="tName_${type}_${i}" required></div>
                <div class="form-group"><label class="modern-label">${t('lblSurname')}</label><input class="modern-input" placeholder="${t('phSurname')}" name="tSurname_${type}_${i}" required></div>
                <div class="form-group"><label class="modern-label">${t('lblDob')}</label><input type="date" class="modern-input" name="tDob_${type}_${i}" required></div>
                <div class="form-group"><label class="modern-label">${t('lblNat')}</label><input class="modern-input" placeholder="${t('phNat')}" name="tNat_${type}_${i}" required></div>
            </div>
        </div>
        `;
    }

    function closeReservationModal() { document.getElementById('reservationModal').style.display = 'none'; }
    
    document.getElementById('reservationForm').onsubmit = (e) => {
        e.preventDefault(); 
        const s = getSummary(); 
        const fd = new FormData(e.target); 
        const travelers = [];
        for(let k of fd.keys()) { if(k.startsWith('tName')) { const p = k.split('_'); travelers.push({ type: p[1], name: fd.get(k), surname: fd.get(`tSurname_${p[1]}_${p[2]}`), dob: fd.get(`tDob_${p[1]}_${p[2]}`), nationality: fd.get(`tNat_${p[1]}_${p[2]}`) }); } }
        
        const payload = { 
            summary: { ...s, totalTravelers: travelers.length, roomsSubtotal:0, mealsTotal:0, extraBedsTotal:0, operationsTotal:0, hotelSubtotal:0 }, 
            travelers, 
            flightInfo: { 
                flightNumber: s.flightNumber,
                arrival: fd.get('flightArrivalDate')+' '+fd.get('flightArrivalTime'), 
                departure: fd.get('flightDepartureDate')+' '+fd.get('flightDepartureTime') 
            }, 
            submittingAgentUsername: LOGGED_IN_AGENT.username,
            status: t('statusPending')
        };
        
        fetch('/api/reservations', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }).then(r=>r.json()).then(res => { if(res.id) { alert(t('resSuccess')+res.id); closeReservationModal(); showAgentView('reservations'); } else alert('Error!'); });
    };

    function showAgentView(v) { document.getElementById('bookingView').style.display = (v==='booking')?'block':'none'; document.getElementById('reservationsView').style.display = (v==='reservations')?'block':'none'; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.view===v)); if(v==='reservations') loadMyRes(); }
    
    function loadMyRes() {
        const list = document.getElementById('agentReservationsList'); list.innerHTML = `<div style="padding:20px;text-align:center;">${t('loading')}</div>`;
        fetch('/api/data').then(r => r.json()).then(d => {
            const myRes = d.reservations.filter(r => r.submittingAgentUsername === LOGGED_IN_AGENT.username);
            list.innerHTML = '';
            if (myRes.length === 0) { list.innerHTML = `<div style="padding:20px;text-align:center;color:#666;">${t('noResFound')}</div>`; return; }
            myRes.forEach(r => { 
                const rawStatus = r.status || 'Pending';
                let displayStatus = rawStatus;
                if(rawStatus === 'G√∂zl…ôm…ôd…ô' || rawStatus === 'Pending') displayStatus = t('statusPending');
                else if(rawStatus.includes('T…ôsd') || rawStatus === 'Confirmed') displayStatus = t('statusConfirmed');
                else if(rawStatus.includes('L…ôƒüv') || rawStatus === 'Cancelled') displayStatus = t('statusCancelled');
                else if(rawStatus.includes('Redakt…ô') || rawStatus === 'Edited') displayStatus = t('statusEdit');

                const isEditable = (rawStatus === 'G√∂zl…ôm…ôd…ô' || rawStatus === 'Pending' || rawStatus.includes('Tarix') || rawStatus === t('statusPending'));
                const editBtnHtml = isEditable ? `<button class="action-btn edit-btn" onclick="openEditDetailsModal('${r.id}')">‚úèÔ∏è ${t('colEdit')}</button>` : `<span style="font-size:11px; color:#999;">-</span>`;
                const cancelBtnHtml = isEditable ? `<button class="action-btn cancel-btn" onclick="cancelReservation('${r.id}')">‚ùå ${t('colCancel')}</button>` : `<span style="font-size:11px; color:#999;">-</span>`;
                const div = document.createElement('div'); div.className = 'agent-res-row'; 
                div.innerHTML = `<div>#${r.id}</div><div>${r.summary.checkIn} <br> <span style="font-size:11px;color:#666;">${r.summary.nights} nights</span></div><div style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.summary.hotelNames}</div><div><span style="padding:3px 8px; border-radius:10px; font-size:11px; font-weight:bold; background:${displayStatus === t('statusConfirmed') ? '#dcfce7' : (displayStatus === t('statusCancelled') ? '#fee2e2' : '#fef9c3')}; color:${displayStatus === t('statusConfirmed') ? '#166534' : (displayStatus === t('statusCancelled') ? '#991b1b' : '#854d0e')};">${displayStatus}</span></div><div style="text-align:right; font-weight:bold;">${formatMoney(r.summary.totalPrice)}</div><div style="text-align:center;">${editBtnHtml}</div><div style="text-align:center;">${cancelBtnHtml}</div>`; 
                list.appendChild(div); 
            });
        });
    }

    function openEditDetailsModal(id) {
        fetch('/api/data').then(r => r.json()).then(data => {
            const res = data.reservations.find(r => r.id == id); if (!res) return;
            document.getElementById('editDetailResId').value = res.id;
            document.getElementById('editDetailCheckIn').value = res.summary.checkIn; document.getElementById('editDetailCheckOut').value = res.summary.checkOut;
            const cont = document.getElementById('editTravelersContainer'); cont.innerHTML = '';
            if (res.travelers && res.travelers.length > 0) { res.travelers.forEach((t, i) => { cont.innerHTML += `<div style="margin-bottom:10px; border-bottom:1px dashed #e2e8f0; padding-bottom:10px;"><div style="font-weight:bold; font-size:12px; margin-bottom:5px;">${t.type} ${i+1}</div><div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr; gap:5px;"><input class="edit-tr-input" data-idx="${i}" data-field="name" value="${t.name}" placeholder="${t('phName')}"><input class="edit-tr-input" data-idx="${i}" data-field="surname" value="${t.surname}" placeholder="${t('phSurname')}"><input class="edit-tr-input" data-idx="${i}" data-field="dob" type="date" value="${t.dob}"><input class="edit-tr-input" data-idx="${i}" data-field="nationality" value="${t.nationality}" placeholder="${t('phNat')}"></div></div>`; }); } 
            else { cont.innerHTML = '<p>No traveler info.</p>'; }
            if (res.flightInfo) { document.getElementById('editDetailFlightNo').value = res.flightInfo.flightNumber || ''; const arr = (res.flightInfo.arrival || '').split(' '); document.getElementById('editDetailArrDate').value = arr[0] || ''; document.getElementById('editDetailArrTime').value = arr[1] || ''; const dep = (res.flightInfo.departure || '').split(' '); document.getElementById('editDetailDepDate').value = dep[0] || ''; document.getElementById('editDetailDepTime').value = dep[1] || ''; }
            document.getElementById('editDetailsModal').style.display = 'flex';
        });
    }
    function closeEditDetailsModal() { document.getElementById('editDetailsModal').style.display = 'none'; }
    function submitEditDetails() {
        const id = document.getElementById('editDetailResId').value;
        fetch('/api/data').then(r => r.json()).then(data => {
            const reservation = data.reservations.find(r => r.id == id); if (!reservation) return;
            reservation.summary.checkIn = document.getElementById('editDetailCheckIn').value; reservation.summary.checkOut = document.getElementById('editDetailCheckOut').value;
             const d1 = new Date(reservation.summary.checkIn); const d2 = new Date(reservation.summary.checkOut); const nights = Math.round((d2 - d1) / (1000 * 60 * 60 * 24)); reservation.summary.nights = nights > 0 ? nights : 0;
            const inputs = document.querySelectorAll('.edit-tr-input'); inputs.forEach(inp => { const idx = inp.dataset.idx; const field = inp.dataset.field; if (reservation.travelers[idx]) { reservation.travelers[idx][field] = inp.value; } });
            reservation.flightInfo = { flightNumber: document.getElementById('editDetailFlightNo').value, arrival: document.getElementById('editDetailArrDate').value + ' ' + document.getElementById('editDetailArrTime').value, departure: document.getElementById('editDetailDepDate').value + ' ' + document.getElementById('editDetailDepTime').value };
            reservation.status = t('statusEdit');
            fetch(`/api/reservations/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reservation) }).then(() => { alert(t('alertSaved')); closeEditDetailsModal(); loadMyRes(); });
        });
    }
    function cancelReservation(id) { if(!confirm(t('alertCancel'))) return; fetch('/api/data').then(r => r.json()).then(data => { const reservation = data.reservations.find(r => r.id == id); if (!reservation) return; reservation.status = t('statusCancelReq'); fetch(`/api/reservations/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reservation) }).then(() => { alert(t('alertSent')); loadMyRes(); }); }); }
    document.addEventListener('DOMContentLoaded', () => { fetchData(); showAgentView('booking'); });
    ['checkIn','checkOut','adults','children'].forEach(id => document.getElementById(id).addEventListener('change', recalcTotals));
  </script>
</body>
</html>
