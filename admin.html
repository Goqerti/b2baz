<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B2B Admin Panel - Professional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Global Styles & Reset */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8; /* A√ßƒ±q, pe≈ü…ôkar fon */
      color: #374151;
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar Navigation */
    .sidebar {
        width: 250px;
        background: #111827; /* T√ºnd r…ông */
        color: #f3f4f6;
        padding: 20px 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    .sidebar h1 {
        font-size: 22px;
        text-align: center;
        margin-bottom: 30px;
        color: #38bdf8;
    }
    .nav-group {
        flex-grow: 1;
    }
    .nav-item {
        padding: 12px 25px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        transition: background 0.3s, color 0.3s;
        border-left: 4px solid transparent;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #f3f4f6;
    }
    .nav-item:hover {
        background: #1f2937;
    }
    .nav-item.active {
        background: #3b82f6;
        border-left-color: #f3f4f6;
        color: white;
    }
    .logout-item {
        margin-top: 20px;
        padding: 15px 25px;
        cursor: pointer;
        color: #ef4444;
        font-weight: 600;
        border-top: 1px solid #334155;
        transition: background 0.3s;
    }
    .logout-item:hover {
        background: #27303e;
    }
    
    /* Main Content Area */
    .page {
      flex-grow: 1;
      padding: 30px;
    }
    .header-info {
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header-info h2 {
        font-size: 28px;
        margin: 0 0 5px;
        color: #111827;
    }
    .header-info p {
        font-size: 15px;
        color: #6b7280;
        margin: 0;
    }
    .user-info {
        font-size: 15px;
        font-weight: 600;
        color: #1d4ed8;
        padding: 8px 15px;
        background: #e0f2fe;
        border-radius: 6px;
    }

    /* Cards & Grids */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 25px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
    }
    
    /* Form Elements */
    h3 {
      font-size: 20px;
      margin: 0 0 15px;
      color: #111827;
      border-left: 4px solid #f59e0b;
      padding-left: 10px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #1f2937;
      font-size: 14px;
      outline: none;
      margin-bottom: 15px;
      transition: box-shadow 0.2s;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .btn {
      border-radius: 8px;
      border: none;
      padding: 10px 18px;
      background: #3b82f6;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 5px;
      transition: background 0.3s;
    }
    .btn:hover { background: #2563eb; }
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #cbd5e1;
      padding: 8px 15px;
      font-size: 13px;
      margin-top: 10px;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn-secondary:hover { background: #e2e8f0; }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    /* Room Type Inputs */
    .room-type-row-inputs, .meal-plan-row-inputs {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 60px; /* Name, Price, Checkbox, Button */
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }
    .meal-plan-row-inputs {
        grid-template-columns: 2fr 1fr 60px; /* Name, Price, Button */
    }
    .room-type-row-inputs input, .room-type-row-inputs select,
    .meal-plan-row-inputs input, .meal-plan-row-inputs select {
        margin-bottom: 0 !important;
    }
    .room-type-checkbox-group {
        display: flex;
        align-items: center;
        padding-top: 4px;
    }
    .room-type-checkbox-group input {
        width: auto !important;
        margin-right: 5px;
        accent-color: #3b82f6;
    }

    
    /* Lists & Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      font-size: 12px;
      color: #0369a1;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .list {
      margin-top: 20px;
      font-size: 13px;
      color: #4b5563;
      max-height: 250px;
      overflow-y: auto;
      border-top: 1px solid #e2e8f0;
      padding-top: 15px;
    }
    .list-item {
      padding: 10px 0;
      border-bottom: 1px dashed #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }
    .btn-action {
        background: none;
        border: none;
        padding: 5px 8px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s;
        margin-left: 5px;
    }
    .btn-edit {
        color: #3b82f6;
        border: 1px solid #3b82f6;
        background: #eff6ff;
    }
    .btn-edit:hover { background: #dbeafe; }
    .btn-delete {
        color: #ef4444;
        border: 1px solid #ef4444;
        background: #fef2f2;
    }
    .btn-delete:hover { background: #fca5a5; }
    .btn-save-inline { background: #10b981; color: white; }
    .btn-cancel-inline { background: #6b7280; color: white; }
    .list-item-content {
        flex-grow: 1;
    }
    .inline-edit-group {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-grow: 1;
    }
    .inline-edit-group input {
        margin-bottom: 0;
    }
    
    .tag {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      margin-left: 6px;
      font-weight: 500;
    }
    .tag.pending { background: #fffbe6; color: #b45309; }
    .tag.confirmed { background: #d1fae5; color: #059669; }
    .tag.rejected { background: #fef2f2; color: #ef4444; }
    .tag.change { background: #e0f2fe; color: #1d4ed8; }

    .success { color: #10b981; margin-top: 10px; font-size: 13px; font-weight: 600; }
    .error { color: #ef4444; margin-top: 10px; font-size: 13px; font-weight: 600; }
    
    /* Reservations View Specific */
    .res-header-grid {
        display: grid;
        grid-template-columns: 0.1fr 0.3fr 0.4fr 0.4fr 0.6fr 0.5fr;
        font-weight: 700;
        padding: 15px 10px;
        border-bottom: 2px solid #e5e7eb;
        color: #111827;
        font-size: 14px;
        background: #f8fafc;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }
    .res-item-row {
        display: grid;
        grid-template-columns: 0.1fr 0.3fr 0.4fr 0.4fr 0.6fr 0.5fr;
        padding: 15px 10px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .res-item-row:hover {
        background: #f9fafb;
    }
    .res-amount {
        font-weight: 700;
        color: #10b981;
        text-align: right;
    }
    .res-detail-box {
        background: #e0f2fe;
        padding: 20px;
        border-radius: 10px;
        margin-top: 25px;
        font-size: 14px;
        white-space: pre-wrap;
        border-left: 5px solid #3b82f6;
    }
    .res-detail-box h4 {
        color: #111827;
        font-weight: 700;
    }
    .res-detail-box .actions {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed #c7d2fe;
    }
    .res-detail-box .actions button {
        margin-right: 10px;
        padding: 8px 15px;
        font-size: 13px;
        border-radius: 6px;
        cursor: pointer;
    }
    .res-detail-box .actions .btn-confirm { background: #10b981; color: white; border: none; }
    .res-detail-box .actions .btn-reject { background: #ef4444; color: white; border: none; }
    .res-detail-box .actions .btn-change { background: #3b82f6; color: white; border: none; }
    .res-detail-box .actions .btn-edit { background: #f59e0b; color: white; border: none; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); display: none; justify-content: center; 
        align-items: center; z-index: 1000;
    }
    .modal-content {
        background: white; padding: 30px; border-radius: 10px; 
        width: 90%; max-width: 800px; 
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
    }
    .modal-content h3 { border-left-color: #3b82f6; }
    .traveler-edit-row {
        border: 1px solid #e5e7eb; padding: 10px; border-radius: 8px; margin-bottom: 10px;
    }
    .traveler-edit-row input { margin-bottom: 8px; }
  </style>
</head>
<body>
    
    <script>
        const LOGGED_IN_AGENT = JSON.parse(localStorage.getItem('b2b_agent_auth'));

        if (!LOGGED_IN_AGENT || LOGGED_IN_AGENT.role !== 'Admin') {
            alert("Bu s…ôhif…ôy…ô daxil olmaq √º√ß√ºn Admin icaz…ôsi t…ôl…ôb olunur.");
            window.location.href = 'login.html'; 
        }
        
        const dateFormatter = new Intl.DateTimeFormat('az-AZ', { day: '2-digit', month: 'short', year: 'numeric' });
        const dateTimeFormatter = new Intl.DateTimeFormat('az-AZ', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        function logout() {
            localStorage.removeItem('b2b_agent_auth');
            window.location.href = 'login.html';
        }
    </script>
    
    <div class="sidebar">
        <h1>Admin Console</h1>
        <div class="nav-group">
            <div class="nav-item active" data-view="hotels">
                <span style="font-size: 18px;">üè®</span> Hotell…ôr
            </div>
            <div class="nav-item" data-view="regions">
                <span style="font-size: 18px;">üåé</span> Regionlar
            </div>
            <div class="nav-item" data-view="operations">
                <span style="font-size: 18px;">‚úàÔ∏è</span> ∆èm…ôliyyatlar
            </div>
            <div class="nav-item" data-view="pending-agents">
                <span style="font-size: 18px;">üë§</span> Agent T…ôsdiqi
            </div>
            <div class="nav-item" data-view="reservations">
                <span style="font-size: 18px;">üìù</span> Rezervasiyalar
            </div>
        </div>
        <div class="logout-item" onclick="logout()">
            √áƒ±xƒ±≈ü et
        </div>
    </div>

    <div class="page">
        <div class="header-info">
            <div>
                <h2 id="viewTitle">Hotell…ôrin ƒ∞dar…ô Edilm…ôsi</h2>
                <p id="viewSubtitle">Otaq tipl…ôri, qidalanma planlarƒ± v…ô extra bed qiym…ôtl…ôrini idar…ô edin.</p>
            </div>
            <div id="agentInfo" class="user-info">
                Agent: <span id="agentNameDisplay">Y√ºkl…ônir...</span>
            </div>
        </div>

        <div id="hotelsView" style="display: block;">
            <div class="card">
                <h3 id="hotelFormTitle">üè® Yeni Hotel ∆èlav…ô Et</h3>
                <div class="pill">Otaq tipl…ôri, qidalanma planlarƒ± v…ô extra bed qiym…ôtl…ôri.</div>
                <input type="hidden" id="hotelId" value="">
                
                <div class="grid" style="gap: 15px;">
                    <div>
                        <label>Hotel adƒ±</label>
                        <input type="text" id="hotelName" placeholder="M…ôs: Alba Hotel" />
                    </div>
                    <div>
                        <label>Region</label>
                        <select id="hotelRegionSelect">
                            <option value="">Region se√ß...</option>
                        </select>
                    </div>
                    <div>
                        <label>Ulduz</label>
                        <select id="hotelStars">
                            <option value="3">3 ‚òÖ</option>
                            <option value="4" selected>4 ‚òÖ</option>
                            <option value="5">5 ‚òÖ</option>
                        </select>
                    </div>
                    <div>
                        <label>Extra bed / night ($)</label>
                        <input type="number" id="extraBedPrice" min="0" value="0" />
                    </div>
                </div>

                <div style="margin-top:25px;">
                    <strong style="font-size:14px; display: block; margin-bottom: 5px;">Otaq N√∂vl…ôri (Room types)</strong>
                    <div id="roomTypesAdmin"></div>
                    <button type="button" class="btn-secondary" id="addRoomTypeAdminBtn">+ Room type …ôlav…ô et</button>
                </div>

                <div style="margin-top:25px;">
                    <strong style="font-size:14px; display: block; margin-bottom: 5px;">Qidalanma Planlarƒ± (Meal plans)</strong>
                    <div id="mealPlansAdmin"></div>
                    <button type="button" class="btn-secondary" id="addMealPlanAdminBtn">+ Meal plan …ôlav…ô et</button>
                </div>

                <button class="btn" id="saveHotelBtn" style="margin-top:30px;">Hotel yadda saxla</button>
                <button class="btn-secondary" id="cancelEditBtn" style="margin-top:30px; display: none;">Redakt…ôni l…ôƒüv et</button>
                <div id="hotelMsg"></div>

                <div class="list" id="hotelsList"></div>
            </div>
        </div>

        <div id="regionsView" style="display: none;">
            <div class="card" style="max-width: 500px;">
                <h3>üåé Regionlar</h3>
                <div class="pill">∆èsas coƒürafi b√∂lg…ôl…ôr</div>
                <label>Region adƒ±</label>
                <input type="text" id="regionName" placeholder="M…ôs: Baku" />
                <button class="btn" id="addRegionBtn">Region …ôlav…ô et</button>
                <div id="regionMsg"></div>
                <div class="list" id="regionsList"></div>
            </div>
        </div>

        <div id="operationsView" style="display: none;">
            <div class="card" style="max-width: 500px;">
                <h3>‚úàÔ∏è ∆èm…ôliyyatlar / Xidm…ôtl…ôr</h3>
                <div class="pill">Transfer, tur v…ô s. xidm…ôt qiym…ôtl…ôri</div>
                <label>Operation adƒ±</label>
                <input type="text" id="opName" placeholder="M…ôs: Airport ‚Üí Hotel transfer" />
                <label>Qiym…ôt ($)</label>
                <input type="number" id="opPrice" min="0" value="0" />
                <button class="btn" id="addOperationBtn">Operation …ôlav…ô et</button>
                <div id="opMsg"></div>
                <div class="list" id="operationsList"></div>
            </div>
        </div>

        <div id="pending-agentsView" style="display: none;">
            <div class="card" style="max-width: 500px;">
                <h3>üë§ Agent T…ôsdiqi G√∂zl…ôyir</h3>
                <div class="pill" style="background: #fffbe6; color: #b45309;">Qeydiyyatdan ke√ßmi≈ü, t…ôsdiql…ônm…ômi≈ü agentl…ôr.</div>
                <div id="pendingAgentsList">
                    <p style="color: #6b7280; font-style: italic; margin-top: 10px;">G√∂zl…ôy…ôn agent yoxdur.</p>
                </div>
            </div>
        </div>
        
        <div id="reservationsView" style="display: none;">
            <div class="card" style="padding: 0;">
                <div class="res-header-grid">
                    <div># ID</div>
                    <div>Agent</div>
                    <div>Tarix Aralƒ±ƒüƒ±</div>
                    <div>Hotell…ôr</div>
                    <div>Status</div>
                    <div style="text-align: right;">Qiym…ôt</div>
                </div>
                <div id="reservationsList">
                    <div style="padding: 20px; text-align: center; color: #6b7280;">Rezervasiya m…ôlumatlarƒ± y√ºkl…ônir...</div>
                </div>
            </div>
            
            <div id="reservationDetail" class="res-detail-box" style="display: none;">
                </div>
        </div>
        
    </div>
    
    <div id="changeDateModal" class="modal-overlay" onclick="closeModal('changeDateModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #6b7280;" onclick="closeModal('changeDateModal')">√ó</span>
            <h3>üìÖ Tarix D…ôyi≈üikliyi T…ôklifi G√∂nd…ôr</h3>
            <form id="changeDateForm">
                <input type="hidden" id="changeResId">
                <label for="newCheckIn">Yeni Check-in tarixi</label>
                <input type="date" id="newCheckIn" required>
                
                <label for="newCheckOut">Yeni Check-out tarixi</label>
                <input type="date" id="newCheckOut" required>
                
                <label for="adminNote">Agent √º√ß√ºn Qeyd (Max 250 simvol) *</label>
                <textarea id="adminNote" maxlength="250" rows="3" required></textarea>
                
                <div id="changeDateMsg" class="error" style="margin-top: 10px; display: none;"></div>
                
                <button type="submit" class="btn" style="width: 100%; margin-top: 15px;">T…ôklifi G√∂nd…ôr</button>
            </form>
        </div>
    </div>
    
    <div id="editReservationModal" class="modal-overlay" onclick="closeModal('editReservationModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #6b7280;" onclick="closeModal('editReservationModal')">√ó</span>
            <h3 id="editModalTitle">üõ†Ô∏è Rezervasiya Redakt…ôsi #ID</h3>
            
            <form id="editReservationForm">
                <input type="hidden" id="editResId">
                <input type="hidden" id="editResDate">
                <input type="hidden" id="editResAgentUsername">
                
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="section-title" style="margin-top: 0; border-left-color: #10b981;">üóìÔ∏è ∆èsas M…ôlumatlar & Status</div>
                        
                        <label>Check-in</label>
                        <input type="date" id="editCheckIn" name="checkIn" required>
                        
                        <label>Check-out</label>
                        <input type="date" id="editCheckOut" name="checkOut" required>
                        
                        <div class="grid" style="grid-template-columns: 1fr 1fr;">
                            <div>
                                <label>Adults</label>
                                <input type="number" id="editAdults" name="adults" min="1" required>
                            </div>
                            <div>
                                <label>Children</label>
                                <input type="number" id="editChildren" name="children" min="0" required>
                            </div>
                        </div>

                        <label>Status</label>
                        <select id="editStatus" name="status">
                            <option value="Pending Admin">Pending Admin</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Date Change Requested">Date Change Requested</option>
                            <option value="Date Change Accepted">Date Change Accepted</option>
                            <option value="Date Change Rejected">Date Change Rejected</option>
                        </select>
                    </div>
                    
                    <div>
                        <div class="section-title" style="margin-top: 0; border-left-color: #f59e0b;">‚úàÔ∏è U√ßu≈ü M…ôlumatlarƒ±</div>
                        <label>Arrival Time (G…ôli≈ü vaxtƒ±)</label>
                        <input type="text" id="editFlightArrival" name="flightArrival" placeholder="M…ôs: 2025-12-30 14:30" />
                        
                        <label>Departure Time (Gedi≈ü vaxtƒ±)</label>
                        <input type="text" id="editFlightDeparture" name="flightDeparture" placeholder="M…ôs: 2026-01-05 10:00" />

                        <div style="margin-top: 25px; padding: 10px; background: #e0f2fe; border-radius: 6px;">
                            <p style="font-size: 13px; color: #1d4ed8; font-weight: 600; margin: 0;">
                                ‚ö†Ô∏è QEYD: Hotel & Otaq Detallarƒ± (M…ôs: Rooms Subtotal, HotelNames) avtomatik yenil…ônm…ôy…ôc…ôk. Redakt…ô etdiyiniz m…ôlumatlar qiym…ôt c…ôdv…ôlinin √ºst√ºn…ô yazƒ±lacaq.
                            </p>
                            <label style="margin-top: 10px;">Hotell…ôrin adƒ± (Redakt…ô √º√ß√ºn)</label>
                            <input type="text" id="editHotelNames" name="hotelNames" required>
                        </div>
                    </div>
                </div>

                <div class="section-title" style="border-left-color: #3b82f6;">üë§ S…ôyah…ôt√ßi M…ôlumatlarƒ± (Ad, Soyad, DOB, V…ôt…ônda≈ülƒ±q)</div>
                <div id="editTravelersContainer">
                    </div>
                
                <div id="editMsg" class="error" style="margin-top: 15px; display: none;"></div>
                
                <button type="submit" class="btn" style="width: 100%; margin-top: 25px; background: #10b981;">D…ôyi≈üiklikl…ôri Yadda Saxla</button>
            </form>
        </div>
    </div>


    <script>
        
        let dbData = { regions: [], hotels: [], operations: [], reservations: [], pending_agents: [] };
        let currentResId = null; 

        // Y√ºkl…ônmi≈ü Agent adƒ±
        document.getElementById('agentNameDisplay').textContent = LOGGED_IN_AGENT.name + ' (' + LOGGED_IN_AGENT.role + ')';
        
        // API HELPERS
        function formatMoney(v) {
          v = Math.round((v + Number.EPSILON) * 100) / 100;
          return v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' $';
        }

        function statusToTag(status) {
            const statuses = {
                'Pending Admin': '<span class="tag pending">G√∂zl…ôyir</span>',
                'Confirmed': '<span class="tag confirmed">T…ôsdiql…ôndi</span>',
                'Rejected': '<span class="tag rejected">R…ôdd edildi</span>',
                'Date Change Requested': '<span class="tag change">Tarix D…ôyi≈üikliyi G√∂zl…ôyir</span>',
                'Date Change Accepted': '<span class="tag confirmed">Tarix D…ôyi≈üikliyi Q…ôbul</span>',
                'Date Change Rejected': '<span class="tag rejected">Tarix D…ôyi≈üikliyi R…ôdd</span>'
            };
            return statuses[status] || `<span class="tag">${status}</span>`;
        }

        // Modal Helpers
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            document.getElementById('changeDateMsg').style.display = 'none';
            document.getElementById('editMsg').style.display = 'none';
        }
        function handleActionResponse(response, type, action, msgEl) {
            return response.json().then(data => {
                if (response.ok && data.success) {
                    msgEl.textContent = `‚úÖ ${type} uƒüurla ${action}.`;
                    msgEl.className = 'success';
                    fetchData(); 
                    return true;
                } else {
                    throw new Error(data.error || `${type} ${action} edil…ôrk…ôn x…ôta ba≈ü verdi.`);
                }
            }).catch(err => {
                msgEl.textContent = '‚ùå ' + err.message;
                msgEl.className = 'error';
                setTimeout(() => msgEl.textContent = '', 4000);
                return false;
            });
        }

        // --- View Switching ---
        function showView(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-view="${viewId}"]`).classList.add('active');

            // Hide all main view containers
            document.getElementById('hotelsView').style.display = 'none';
            document.getElementById('regionsView').style.display = 'none';
            document.getElementById('operationsView').style.display = 'none';
            document.getElementById('pending-agentsView').style.display = 'none';
            document.getElementById('reservationsView').style.display = 'none';


            const view = document.getElementById(viewId + 'View');
            const titleEl = document.getElementById('viewTitle');
            const subtitleEl = document.getElementById('viewSubtitle');
            
            view.style.display = 'block';

            if (viewId === 'hotels') {
                titleEl.textContent = 'Hotell…ôrin ƒ∞dar…ô Edilm…ôsi';
                subtitleEl.textContent = 'Otaq tipl…ôri, qidalanma planlarƒ± v…ô extra bed qiym…ôtl…ôrini idar…ô edin.';
                resetHotelForm();
            } else if (viewId === 'regions') {
                titleEl.textContent = 'Regionlarƒ±n ƒ∞dar…ô Edilm…ôsi';
                subtitleEl.textContent = 'Yeni coƒürafi b√∂lg…ôl…ôr …ôlav…ô edin v…ô m√∂vcud olanlarƒ± redakt…ô/silin.';
            } else if (viewId === 'operations') {
                titleEl.textContent = '∆èm…ôliyyatlarƒ±n ƒ∞dar…ô Edilm…ôsi';
                subtitleEl.textContent = 'Transfer, tur v…ô dig…ôr …ôlav…ô xidm…ôtl…ôrin siyahƒ±sƒ±nƒ± redakt…ô/silin.';
            } else if (viewId === 'pending-agents') {
                titleEl.textContent = 'Agent T…ôsdiqi';
                subtitleEl.textContent = 'Qeydiyyatdan ke√ßmi≈ü, t…ôsdiql…ônm…ômi≈ü agentl…ôr…ô icaz…ô verin v…ô ya r…ôdd edin.';
            } else if (viewId === 'reservations') {
                titleEl.textContent = 'Rezervasiyalar';
                subtitleEl.textContent = 'B√ºt√ºn agent rezervasiyalarƒ±nƒ±n idar…ôetm…ô paneli.';
                document.getElementById('reservationDetail').style.display = 'none';
                fetchData(); 
            }
        }
        
        // --- Data Fetching and Rendering ---
        
        function fetchData() {
          fetch('/api/data')
            .then(r => r.json())
            .then(data => {
              dbData = data;
              
              // Rendering functions must be defined before use
              renderRegions(data.regions);
              renderOperations(data.operations);
              renderHotels(data.hotels, data.regions);
              renderPendingAgents(data.pending_agents); 
              
              renderReservations(data.reservations);
            })
            .catch(err => console.error('Error loading data', err));
        }
        
        // --- Hotel CRUD Logic ---
        
        // Otaq Tipi Inputu Yarat
        function createRoomTypeInput(rt = {}) {
            const id = rt.id || new Date().getTime(); // Yeni ID yaradƒ±lƒ±r
            const container = document.getElementById('roomTypesAdmin');
            const row = document.createElement('div');
            row.className = 'room-type-row-inputs';
            row.dataset.id = id;
            
            row.innerHTML = `
                <input type="text" placeholder="Room adƒ± (M…ôs: Standard)" value="${rt.name || ''}" class="room-name" required>
                <input type="number" placeholder="Qiym…ôt ($)" value="${rt.pricePerNight || 0}" min="0" class="room-price" required>
                <div class="room-type-checkbox-group">
                    <input type="checkbox" id="eb_allowed_${id}" class="room-eb-allowed" ${rt.isExtraBedAllowed ? 'checked' : ''}>
                    <label for="eb_allowed_${id}" style="margin:0;">Extra Bed</label>
                </div>
                <button type="button" class="btn-action btn-delete" onclick="this.parentNode.remove()">Sil</button>
            `;
            container.appendChild(row);
        }
        
        // Meal Plan Inputu Yarat
        function createMealPlanInput(mp = {}) {
            const id = mp.id || new Date().getTime(); // Yeni ID yaradƒ±lƒ±r
            const container = document.getElementById('mealPlansAdmin');
            const row = document.createElement('div');
            row.className = 'meal-plan-row-inputs';
            row.dataset.id = id;
            
            row.innerHTML = `
                <input type="text" placeholder="Plan adƒ± (M…ôs: BB, AI)" value="${mp.name || ''}" class="meal-name" required>
                <input type="number" placeholder="Qiym…ôt ($)" value="${mp.pricePerPersonPerNight || 0}" min="0" class="meal-price" required>
                <button type="button" class="btn-action btn-delete" onclick="this.parentNode.remove()">Sil</button>
            `;
            container.appendChild(row);
        }
        
        function addRoomTypeInput() { createRoomTypeInput(); }
        function addMealPlanInput() { createMealPlanInput(); }
        
        function editHotel(id) {
            const hotel = dbData.hotels.find(h => h.id === id);
            if (!hotel) return;

            // 1. Formu doldur
            document.getElementById('hotelId').value = hotel.id;
            document.getElementById('hotelFormTitle').textContent = `üè® "${hotel.name}" Redakt…ô Et`;
            document.getElementById('hotelName').value = hotel.name;
            document.getElementById('hotelRegionSelect').value = hotel.regionId;
            document.getElementById('hotelStars').value = hotel.stars;
            document.getElementById('extraBedPrice').value = hotel.extraBedPricePerNight;
            document.getElementById('saveHotelBtn').textContent = 'Yenil…ô';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // 2. Room Types v…ô Meal Plans
            document.getElementById('roomTypesAdmin').innerHTML = '';
            hotel.roomTypes.forEach(rt => createRoomTypeInput(rt));
            
            document.getElementById('mealPlansAdmin').innerHTML = '';
            hotel.mealPlans.forEach(mp => createMealPlanInput(mp));
            
            // Y√∂nl…ôndirm…ô
            showView('hotels');
        }
        
        function saveHotel() {
            const id = document.getElementById('hotelId').value;
            const hotelName = document.getElementById('hotelName').value.trim();
            const regionId = document.getElementById('hotelRegionSelect').value;
            const stars = document.getElementById('hotelStars').value;
            const extraBedPrice = document.getElementById('extraBedPrice').value;
            const msgEl = document.getElementById('hotelMsg');
            
            if (!hotelName || !regionId) {
                msgEl.textContent = '‚ùå Hotel adƒ± v…ô region se√ßimi m…ôcburidir.';
                msgEl.className = 'error';
                return;
            }

            const roomTypes = Array.from(document.querySelectorAll('#roomTypesAdmin .room-type-row-inputs')).map(row => ({
                id: row.dataset.id.length < 8 ? Number(row.dataset.id) : undefined, 
                name: row.querySelector('.room-name').value,
                pricePerNight: row.querySelector('.room-price').value,
                isExtraBedAllowed: row.querySelector('.room-eb-allowed').checked
            }));

            const mealPlans = Array.from(document.querySelectorAll('#mealPlansAdmin .meal-plan-row-inputs')).map(row => ({
                id: row.dataset.id.length < 8 ? Number(row.dataset.id) : undefined, 
                name: row.querySelector('.meal-name').value,
                pricePerPersonPerNight: row.querySelector('.meal-price').value
            }));
            
            const payload = {
                name: hotelName,
                regionId: regionId,
                stars: stars,
                extraBedPricePerNight: extraBedPrice,
                roomTypes: roomTypes,
                mealPlans: mealPlans
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/hotels/${id}` : '/api/hotels';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => handleActionResponse(response, 'Hotel', id ? 'yenil…ôndi' : '…ôlav…ô edildi', msgEl))
            .then(success => {
                if (success) {
                    resetHotelForm();
                }
            });
        }

        function resetHotelForm() {
            document.getElementById('hotelId').value = '';
            document.getElementById('hotelFormTitle').textContent = 'üè® Yeni Hotel ∆èlav…ô Et';
            document.getElementById('hotelName').value = '';
            document.getElementById('hotelRegionSelect').value = '';
            document.getElementById('hotelStars').value = '4';
            document.getElementById('extraBedPrice').value = '0';
            document.getElementById('roomTypesAdmin').innerHTML = '';
            document.getElementById('mealPlansAdmin').innerHTML = '';
            document.getElementById('saveHotelBtn').textContent = 'Hotel yadda saxla';
            document.getElementById('cancelEditBtn').style.display = 'none';
            addRoomTypeInput(); 
            addMealPlanInput(); 
        }
        
        // --- Rendering Functions ---
        
        // REGIONS (INLINE EDIT ƒ∞L∆è)
        function renderRegions(regions) {
            const list = document.getElementById('regionsList');
            const select = document.getElementById('hotelRegionSelect');
            list.innerHTML = '';
            select.innerHTML = '<option value="">Region se√ß...</option>';
            
            regions.forEach(r => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.id = `region_item_${r.id}`;
                
                item.innerHTML = `
                    <div class="list-item-content" id="region_content_${r.id}">
                        <span id="region_name_display_${r.id}">${r.name}</span>
                    </div>
                    <div class="actions">
                        <button class="btn-action btn-edit" data-id="${r.id}" onclick="startEditRegion(${r.id}, '${r.name}')">Redakt…ô</button>
                        <button class="btn-action btn-delete" onclick="deleteItem('regions', ${r.id})">Sil</button>
                    </div>
                `;
                list.appendChild(item);
                
                const option = document.createElement('option');
                option.value = r.id;
                option.textContent = r.name;
                select.appendChild(option);
            });
        }
        
        function startEditRegion(id, name) {
            const content = document.getElementById(`region_content_${id}`);
            const actions = content.nextElementSibling;

            content.innerHTML = `<input type="text" id="edit_region_name_${id}" value="${name}" style="flex-grow: 1; margin-bottom: 0;">`;
            actions.innerHTML = `
                <button class="btn-action btn-save-inline" onclick="saveEditRegion(${id})">Yadda Saxla</button>
                <button class="btn-action btn-cancel-inline" onclick="fetchData()">L…ôƒüv Et</button>
            `;
        }

        function saveEditRegion(id) {
            const name = document.getElementById(`edit_region_name_${id}`).value.trim();
            const msgEl = document.getElementById('regionMsg');
            
            fetch(`/api/regions/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            })
            .then(response => handleActionResponse(response, 'Region', 'yenil…ôndi', msgEl));
        }

        
        // OPERATIONS (INLINE EDIT ƒ∞L∆è)
        function renderOperations(operations) {
            const list = document.getElementById('operationsList');
            list.innerHTML = '';
            
            operations.forEach(o => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.id = `op_item_${o.id}`;

                item.innerHTML = `
                    <div class="list-item-content" id="op_content_${o.id}">
                        <strong><span id="op_name_display_${o.id}">${o.name}</span></strong> 
                        <span class="tag change"><span id="op_price_display_${o.id}">${formatMoney(o.price)}</span></span>
                    </div>
                    <div class="actions">
                        <button class="btn-action btn-edit" onclick="startEditOperation(${o.id}, '${o.name}', ${o.price})">Redakt…ô</button>
                        <button class="btn-action btn-delete" onclick="deleteItem('operations', ${o.id})">Sil</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function startEditOperation(id, name, price) {
            const content = document.getElementById(`op_content_${id}`);
            const actions = content.nextElementSibling;
            
            content.innerHTML = `
                <input type="text" id="edit_op_name_${id}" value="${name}" placeholder="Ad" style="flex-grow: 1; width: 150px; margin-bottom: 0;">
                <input type="number" id="edit_op_price_${id}" value="${price}" min="0" placeholder="Qiym…ôt" style="width: 80px; margin-bottom: 0;">
                <span style="font-size: 14px; margin-left: 5px;">$</span>
            `;
            actions.innerHTML = `
                <button class="btn-action btn-save-inline" onclick="saveEditOperation(${id})">Yadda Saxla</button>
                <button class="btn-action btn-cancel-inline" onclick="fetchData()">L…ôƒüv Et</button>
            `;
        }

        function saveEditOperation(id) {
            const name = document.getElementById(`edit_op_name_${id}`).value.trim();
            const price = Number(document.getElementById(`edit_op_price_${id}`).value);
            const msgEl = document.getElementById('opMsg');
            
            fetch(`/api/operations/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, price })
            })
            .then(response => handleActionResponse(response, 'Operation', 'yenil…ôndi', msgEl));
        }

        // HOTELS
        function renderHotels(hotels, regions) {
            const list = document.getElementById('hotelsList');
            list.innerHTML = '';
            
            hotels.forEach(h => {
                const region = regions.find(r => r.id === h.regionId);
                const item = document.createElement('div');
                item.className = 'list-item';
                
                let roomInfo = h.roomTypes.map(rt => `${rt.name} (${formatMoney(rt.pricePerNight)})`).join(', ');
                
                item.innerHTML = `
                    <div class="list-item-content">
                        <strong>${h.name}</strong> 
                        <span class="tag">${h.stars}‚òÖ</span>
                        <span class="tag change">${region ? region.name : 'Unknown Region'}</span>
                        <div style="font-size:11px; color:#6b7280; margin-top:2px;">
                            Room Types: ${roomInfo}<br>
                            Extra Bed: ${formatMoney(h.extraBedPricePerNight)} / night
                        </div>
                    </div>
                    <div>
                        <button class="btn-action btn-edit" data-hotel-id="${h.id}">Redakt…ô</button>
                        <button class="btn-action btn-delete" onclick="deleteItem('hotels', ${h.id})">Sil</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function renderPendingAgents(agents) {
            const list = document.getElementById('pendingAgentsList');
            list.innerHTML = '';
            
            if (agents.length === 0) {
                list.innerHTML = '<p style="color: #6b7280; font-style: italic; margin-top: 10px;">G√∂zl…ôy…ôn agent yoxdur.</p>';
                return;
            }

            agents.forEach(a => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <strong>${a.name}</strong> (${a.username})
                        <div style="font-size:11px; color:#6b7280;">${a.company}</div>
                    </div>
                    <div>
                        <button class="btn-action btn-save-inline" onclick="confirmAgent(${a.id})">T…ôsdiql…ô</button>
                        <button class="btn-action btn-delete" onclick="deleteAgent(${a.id})">R…ôdd et</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function confirmAgent(id) {
            if (!confirm(`Agent #${id} t…ôsdiql…ôn…ôc…ôk. ∆èminsiniz?`)) return;
            fetch(`/api/agents/confirm/${id}`, { method: 'POST' })
            .then(response => handleActionResponse(response, 'Agent', 't…ôsdiql…ôndi', document.getElementById('pendingAgentsList')));
        }

        function deleteAgent(id) {
            if (!confirm(`Agent #${id} silin…ôc…ôk (r…ôdd edil…ôc…ôk). ∆èminsiniz?`)) return;
            fetch(`/api/agents/delete/${id}`, { method: 'DELETE' })
            .then(response => handleActionResponse(response, 'Agent', 'silindi', document.getElementById('pendingAgentsList')));
        }

        // --- General CRUD for simple items (Regions, Operations) ---
        document.getElementById('addRegionBtn').addEventListener('click', () => {
            const name = document.getElementById('regionName').value;
            fetch('/api/regions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) })
            .then(response => handleActionResponse(response, 'Region', '…ôlav…ô edildi', document.getElementById('regionMsg')))
            .then(success => { if (success) document.getElementById('regionName').value = ''; });
        });
        
        document.getElementById('addOperationBtn').addEventListener('click', () => {
            const name = document.getElementById('opName').value;
            const price = document.getElementById('opPrice').value;
            fetch('/api/operations', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, price }) })
            .then(response => handleActionResponse(response, 'Operation', '…ôlav…ô edildi', document.getElementById('opMsg')))
            .then(success => { if (success) { document.getElementById('opName').value = ''; document.getElementById('opPrice').value = '0'; } });
        });

        function deleteItem(type, id) {
            if (!confirm(`${type} #${id} silin…ôc…ôk. ∆èminsiniz?`)) return;
            fetch(`/api/${type}/${id}`, { method: 'DELETE' })
            .then(response => handleActionResponse(response, type, 'silindi', document.getElementById('hotelMsg')));
        }

        // --- Reservation Logic ---
        function renderReservations(reservations) {
            const list = document.getElementById('reservationsList');
            list.innerHTML = '';

            if (!reservations || reservations.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">H…ôl…ô he√ß bir rezervasiya yoxdur.</div>';
                return;
            }
            
            reservations.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            reservations.forEach(res => {
                const row = document.createElement('div');
                row.className = 'res-item-row';
                row.onclick = () => showReservationDetail(res);
                
                const price = (res.summary?.totalPrice || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                row.innerHTML = `
                    <div>#${res.id}</div>
                    <div>${res.submittingAgentUsername}</div>
                    <div>${res.summary?.checkIn.substring(5)} - ${res.summary?.checkOut.substring(5)}</div>
                    <div>${res.summary?.hotelNames || '‚Äî'}</div>
                    <div>${statusToTag(res.status)}</div>
                    <div class="res-amount">${price} $</div>
                `;
                list.appendChild(row);
            });
        }

        function showReservationDetail(res) {
            const detailBox = document.getElementById('reservationDetail');
            detailBox.style.display = 'block';
            
            const travelersHtml = (res.travelers || []).map((t, index) => {
                const dob = t.dob ? dateFormatter.format(new Date(t.dob)) : '‚Äî';
                return `
                    <div style="margin-left: 15px; margin-bottom: 5px;">
                        <strong>${index + 1}. ${t.name} ${t.surname} (${t.type})</strong> 
                        <span style="color: #6b7280;">| DB: ${dob} | V…ôt: ${t.nationality}</span>
                    </div>`;
            }).join('');
            
            const changeRequestInfo = res.status === 'Date Change Requested' && res.changeRequest
                ? `<div style="margin-top: 15px; padding: 10px; border: 1px solid #3b82f6; border-radius: 6px; background: #e0f2fe;">
                    <strong>Tarix D…ôyi≈üikliyi Sorƒüusu:</strong><br>
                    Yeni Tarix: ${res.changeRequest.newCheckIn} ‚Üí ${res.changeRequest.newCheckOut}<br>
                    Qeyd: ${res.changeRequest.adminNote}
                </div>`
                : '';

            detailBox.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #fff; padding-bottom: 10px; margin-bottom: 10px;">
                    <h4 style="margin: 0;">Rezervasiya #${res.id} ${statusToTag(res.status)}</h4>
                    <span style="font-size: 11px; color: #6b7280;">Agent: ${res.submittingAgentUsername} | Qeyd: ${dateFormatter.format(new Date(res.date))}</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <strong>S…ôyah…ôt:</strong> ${res.summary.checkIn} ‚Üí ${res.summary.checkOut} (${res.summary.nights} gec…ô)<br>
                        <strong>Qonaq:</strong> ${res.summary.adults} B√∂y√ºk, ${res.summary.children} U≈üaq<br>
                        <strong>Hotell…ôr:</strong> ${res.summary.hotelNames}<br>
                        
                        <strong style="display: block; margin-top: 10px;">U√ßu≈ü M…ôlumatlarƒ±:</strong>
                        G…ôli≈ü: ${res.flightInfo?.arrival || '‚Äî'}<br>
                        Gedi≈ü: ${res.flightInfo?.departure || '‚Äî'}
                    </div>
                    
                    <div>
                        <strong style="color: #10b981;">Yekun Qiym…ôt: ${formatMoney(res.summary.totalPrice)}</strong><br>
                        <span style="color: #6b7280;">(Otaq/Meal: ${formatMoney(res.summary.roomsSubtotal + res.summary.mealsTotal)} + Extra Bed: ${formatMoney(res.summary.extraBedsTotal)} + Operations: ${formatMoney(res.summary.operationsTotal)})</span>
                    </div>
                </div>

                <h4 style="margin-top: 20px; border-bottom: 1px solid #c7d2fe; padding-bottom: 5px;">S…ôyah…ôt√ßil…ôr (${res.summary.totalTravelers} n…ôf…ôr)</h4>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${travelersHtml}
                </div>
                
                ${changeRequestInfo}

                <div class="actions">
                    <button class="btn-edit" onclick="openEditReservationModal(dbData.reservations.find(r => r.id === ${res.id}))">üõ†Ô∏è Redakt…ô Et</button>
                    ${res.status === 'Pending Admin' ? `
                        <button class="btn-confirm" onclick="updateReservationStatus(${res.id}, 'confirm', null)">‚úÖ T…ôsdiql…ô</button>
                        <button class="btn-reject" onclick="updateReservationStatus(${res.id}, 'reject', null)">‚ùå R…ôdd Et</button>
                        <button class="btn-change" onclick="openChangeDateModal(${res.id}, '${res.summary.checkIn}', '${res.summary.checkOut}')">üìÖ Tarix D…ôyi≈üikliyi T…ôklif Et</button>
                    ` : res.status === 'Date Change Requested' ? `
                        <p style="color: #1d4ed8; font-weight: 600;">Agent t…ôr…ôfind…ôn cavab g√∂zl…ônilir.</p>
                        <button class="btn-reject" onclick="updateReservationStatus(${res.id}, 'reject', null)">‚ùå Sorƒüunu L…ôƒüv Et (R…ôdd et)</button>
                    ` : res.status === 'Confirmed' ? `
                        <p style="color: #10b981; font-weight: 600;">Bu rezervasiya t…ôsdiql…ônib.</p>
                    ` : ''}
                    <button class="btn-delete" onclick="deleteReservation(${res.id})" style="margin-left: auto;">üóëÔ∏è Rezervasiyanƒ± Sil</button>
                </div>
            `;
        }

        function updateReservationStatus(id, action, data) {
            const msgEl = document.getElementById('reservationDetail');
            const endpoint = `/api/reservations/${action}/${id}`;
            const method = action === 'delete' ? 'DELETE' : 'PUT';
            const body = data ? JSON.stringify(data) : undefined;
            
            if ((action === 'reject' || action === 'delete') && !confirm(`Rezervasiya #${id} ${action === 'delete' ? 'silin…ôc…ôk' : 'r…ôdd edil…ôc…ôk'}. ∆èminsiniz?`)) return;

            // D√ºz…ôli≈ü: Admin status yoxlamasƒ± API-d…ô olduƒüu √º√ß√ºn sad…ôc…ô statusu g√∂nd…ôririk
            let statusAction = '';
            if (action === 'confirm') statusAction = 'Confirmed';
            else if (action === 'reject') statusAction = 'Rejected';
            else if (action === 'request_change') statusAction = 'Date Change Requested';

            let finalBody = {};
            if (statusAction) {
                finalBody = { status: statusAction, changeRequest: data };
            }

            fetch(`/api/reservations/status/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalBody)
            })
            .then(res => handleActionResponse(res, `Rezervasiya #${id}`, 'yenil…ôndi', msgEl))
            .then(success => {
                if (success) closeModal('changeDateModal');
            })
            .catch(err => console.error(err));
        }
        
        function deleteReservation(id) {
            if (!confirm(`Rezervasiya #${id} silin…ôc…ôk. ∆èminsiniz?`)) return;
            
            const detailBox = document.getElementById('reservationDetail');
            fetch(`/api/reservations/${id}`, { method: 'DELETE' })
            .then(res => handleActionResponse(res, `Rezervasiya #${id}`, 'silindi', detailBox))
            .then(success => {
                if (success) detailBox.style.display = 'none'; // Detal s…ôhif…ôsini baƒüla
            });
        }

        
        function openChangeDateModal(id, currentIn, currentOut) {
            document.getElementById('changeResId').value = id;
            document.getElementById('newCheckIn').value = currentIn;
            document.getElementById('newCheckOut').value = currentOut;
            document.getElementById('adminNote').value = '';
            document.getElementById('changeDateModal').style.display = 'flex';
        }

        document.getElementById('changeDateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const msgEl = document.getElementById('changeDateMsg');
            const id = document.getElementById('changeResId').value;
            
            const data = {
                newCheckIn: document.getElementById('newCheckIn').value,
                newCheckOut: document.getElementById('newCheckOut').value,
                adminNote: document.getElementById('adminNote').value.trim()
            };
            
            updateReservationStatus(id, 'request_change', data);
        });

        // --- TAM REDAKT∆è MODAL FUNKSƒ∞YALARI ---

        function openEditReservationModal(res) {
            if (!res) return;
            
            document.getElementById('editModalTitle').textContent = `üõ†Ô∏è Rezervasiya Redakt…ôsi #${res.id}`;
            document.getElementById('editResId').value = res.id;
            document.getElementById('editResDate').value = res.date;
            document.getElementById('editResAgentUsername').value = res.submittingAgentUsername;
            
            // 1. √úmumi M…ôlumatlar
            document.getElementById('editCheckIn').value = res.summary.checkIn;
            document.getElementById('editCheckOut').value = res.summary.checkOut;
            document.getElementById('editAdults').value = res.summary.adults;
            document.getElementById('editChildren').value = res.summary.children;
            document.getElementById('editHotelNames').value = res.summary.hotelNames;
            document.getElementById('editStatus').value = res.status;
            
            // 2. U√ßu≈ü M…ôlumatlarƒ± (TYPE=TEXT ƒ∞L∆è MANUAL Gƒ∞Rƒ∞≈û)
            document.getElementById('editFlightArrival').value = res.flightInfo?.arrival || '';
            document.getElementById('editFlightDeparture').value = res.flightInfo?.departure || '';

            // 3. S…ôyah…ôt√ßi M…ôlumatlarƒ±
            const travelersContainer = document.getElementById('editTravelersContainer');
            travelersContainer.innerHTML = '';
            
            (res.travelers || []).forEach((t, index) => {
                const travelerType = t.type === 'adult' ? 'B√∂y√ºk' : 'U≈üaq';
                const row = document.createElement('div');
                row.className = 'traveler-edit-row';
                row.innerHTML = `
                    <strong style="display:block; margin-bottom: 5px;">${travelerType} #${index + 1}</strong>
                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" placeholder="Ad" value="${t.name || ''}" class="traveler-name" required>
                        <input type="text" placeholder="Soyad" value="${t.surname || ''}" class="traveler-surname" required>
                        <input type="date" placeholder="Doƒüum g√ºn√º" value="${t.dob || ''}" class="traveler-dob" required>
                        <input type="text" placeholder="V…ôt…ônda≈ülƒ±q" value="${t.nationality || ''}" class="traveler-nationality" required>
                        <input type="hidden" class="traveler-type" value="${t.type}">
                    </div>
                `;
                travelersContainer.appendChild(row);
            });

            document.getElementById('editReservationModal').style.display = 'flex';
        }

        function submitReservationEdit(e) {
            e.preventDefault();
            const msgEl = document.getElementById('editMsg');
            msgEl.style.display = 'none';

            const id = document.getElementById('editResId').value;
            const oldRes = dbData.reservations.find(r => String(r.id) === id);

            // 1. Summary M…ôlumatlarƒ±nƒ± topla
            const newCheckIn = document.getElementById('editCheckIn').value;
            const newCheckOut = document.getElementById('editCheckOut').value;
            const newAdults = Number(document.getElementById('editAdults').value);
            const newChildren = Number(document.getElementById('editChildren').value);
            
            const nights = (new Date(newCheckOut) - new Date(newCheckIn)) / (1000 * 60 * 60 * 24);

            if (nights <= 0 || nights % 1 !== 0) {
                msgEl.textContent = '‚ùå Z…ôhm…ôt olmasa, d√ºzg√ºn Check-in/Check-out tarixl…ôrini daxil edin. Gec…ô sayƒ± sƒ±fƒ±r v…ô ya m…ônfi ola bilm…ôz.';
                msgEl.className = 'error';
                msgEl.style.display = 'block';
                return;
            }

            const newSummary = {
                ...oldRes.summary,
                checkIn: newCheckIn,
                checkOut: newCheckOut,
                nights: nights,
                adults: newAdults,
                children: newChildren,
                totalTravelers: newAdults + newChildren,
                hotelNames: document.getElementById('editHotelNames').value.trim(),
            };
            
            // 2. Travelers M…ôlumatlarƒ±nƒ± topla
            const newTravelers = Array.from(document.querySelectorAll('#editTravelersContainer .traveler-edit-row')).map(row => ({
                type: row.querySelector('.traveler-type').value,
                name: row.querySelector('.traveler-name').value,
                surname: row.querySelector('.traveler-surname').value,
                dob: row.querySelector('.traveler-dob').value,
                nationality: row.querySelector('.traveler-nationality').value,
            }));
            
            // 3. Flight Info M…ôlumatlarƒ±nƒ± topla (RAW TEXT S∆èTRƒ∞)
            const newFlightInfo = {
                arrival: document.getElementById('editFlightArrival').value,
                departure: document.getElementById('editFlightDeparture').value,
            };
            
            const newStatus = document.getElementById('editStatus').value;
            
            const finalPayload = {
                ...oldRes, 
                summary: newSummary,
                travelers: newTravelers,
                flightInfo: newFlightInfo,
                status: newStatus,
                // ChangeRequest yalnƒ±z 'Date Change Requested' statusunda m…ôna da≈üƒ±yƒ±r
                changeRequest: newStatus === 'Date Change Requested' ? oldRes.changeRequest : null
            };

            // Yenil…ônmi≈ü payload-ƒ± server…ô g√∂nd…ôr
            fetch(`/api/reservations/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalPayload)
            })
            .then(response => handleActionResponse(response, `Rezervasiya #${id}`, 'tam redakt…ô edildi', msgEl))
            .then(success => {
                if (success) {
                    setTimeout(() => {
                        closeModal('editReservationModal');
                        // Yenil…ônmi≈ü detalƒ± g√∂st…ôr
                        const updatedRes = dbData.reservations.find(r => String(r.id) === id);
                        showReservationDetail(updatedRes); 
                    }, 1500);
                } else {
                    msgEl.style.display = 'block';
                }
            });
        }
        
        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Sidebar Navigasiyasƒ± Event Listener-l…ôrini baƒüla
            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.addEventListener('click', function() {
                    const viewId = this.getAttribute('data-view');
                    showView(viewId);
                });
            });

            // 2. Hotel Form Event Listener-l…ôrini baƒüla
            document.getElementById('addRoomTypeAdminBtn').addEventListener('click', addRoomTypeInput);
            document.getElementById('addMealPlanAdminBtn').addEventListener('click', addMealPlanInput);
            document.getElementById('cancelEditBtn').addEventListener('click', resetHotelForm);
            document.getElementById('saveHotelBtn').addEventListener('click', saveHotel);
            
            // 3. Hotel Siyahƒ±sƒ±ndan Redakt…ô d√ºym…ôsi √º√ß√ºn delegation (D√úZ∆èLƒ∞≈û BURADADIR)
            document.getElementById('hotelsList').addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-edit')) {
                    const hotelId = Number(e.target.getAttribute('data-hotel-id'));
                    editHotel(hotelId);
                }
            });

            // 4. Edit Reservation Form listener
            document.getElementById('editReservationForm').addEventListener('submit', submitReservationEdit);


            // 5. Initial Load
            resetHotelForm(); 
            fetchData();
            // S…ôhif…ô y√ºkl…ôn…ônd…ô default olaraq "Hotell…ôr" view-u g√∂st…ôr
            showView('hotels');
        });
        
    </script>
</body>
</html>
