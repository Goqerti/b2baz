<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B2B Booking Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===============================
       GLOBAL PREMIUM NEUMORPHISM + GLASS UI
       =============================== */

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at top left, #e5ecff 0, #f5f7fb 45%, #eef2f7 100%);
      color: #111827;
    }

    .page {
      max-width: 1500px;
      margin: 40px auto 50px;
      padding: 0 20px;
    }

    h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 5px;
      color: #020617;
      letter-spacing: -0.03em;
      text-shadow: 0 2px 6px rgba(15,23,42,0.12);
    }

    .subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 25px;
    }

    /* ===============================
       GLASS / NEUMORPHIC CARDS
       =============================== */

    .card {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.7);
      box-shadow:
        8px 8px 22px rgba(15,23,42,0.12),
        -6px -6px 16px rgba(255,255,255,0.9);
      padding: 22px;
      margin-bottom: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        10px 10px 26px rgba(15,23,42,0.16),
        -6px -6px 18px rgba(255,255,255,0.95);
      background: rgba(255,255,255,0.9);
    }

    .section-title {
      font-size: 17px;
      font-weight: 800;
      color: #020617;
      margin: 22px 0 14px;
      border-left: 4px solid #60a5fa;
      padding-left: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #4b5563;
    }

    /* ===============================
       INPUTS & SELECTS
       =============================== */

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="datetime-local"],
    select {
      width: 100%;
      padding: 11px 13px;
      border-radius: 14px;
      border: none;
      font-size: 14px;
      background: #e5e9f2;
      box-shadow:
        inset 3px 3px 7px rgba(15,23,42,0.12),
        inset -3px -3px 7px rgba(255,255,255,0.9);
      outline: none;
      transition: box-shadow 0.2s ease, background 0.2s ease, transform 0.1s ease;
    }

    input:focus,
    select:focus {
      background: #edf1fb;
      box-shadow:
        inset 2px 2px 6px rgba(15,23,42,0.16),
        inset -2px -2px 6px rgba(255,255,255,1),
        0 0 0 1px rgba(59,130,246,0.5),
        0 0 12px rgba(59,130,246,0.35);
      transform: translateY(-1px);
    }

    input[type="number"]::-webkit-inner-spin-button {
      opacity: 0.4;
    }

    /* GRID & LAYOUT HELPERS */

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .pill {
      padding: 7px 14px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #dbeafe 0, #e5f0ff 40%, #e0ecff 100%);
      font-size: 13px;
      color: #0c4a6e;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      box-shadow:
        3px 3px 8px rgba(15,23,42,0.15),
        -3px -3px 8px rgba(255,255,255,0.95);
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      font-size: 14px;
    }

    .checkbox-row input {
      margin: 0;
      accent-color: #3b82f6;
    }

    /* ===============================
       MAIN GRID
       =============================== */

    .main-content-grid {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr) 340px;
      gap: 24px;
      margin-top: 24px;
    }

    @media (max-width: 1150px) {
      .main-content-grid {
        grid-template-columns: 1fr;
      }
    }

    .sticky-sidebar {
      position: sticky;
      top: 20px;
      height: fit-content;
    }

    /* FILTERS */

    .filter-header {
      font-weight: 700;
      margin-bottom: 8px;
      color: #111827;
      font-size: 14px;
    }

    .filter-box {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.8);
      background: linear-gradient(145deg, rgba(238,242,255,0.8), rgba(255,255,255,0.95));
      max-height: 220px;
      overflow-y: auto;
      padding: 10px 12px;
      box-shadow:
        inset 3px 3px 8px rgba(148,163,184,0.25),
        inset -3px -3px 8px rgba(255,255,255,0.9);
    }

    .filter-item,
    .hotel-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 6px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
    }

    .filter-item:hover,
    .hotel-item:hover {
      background: rgba(255,255,255,0.9);
      box-shadow:
        2px 2px 6px rgba(148,163,184,0.4),
        -2px -2px 6px rgba(255,255,255,1);
      transform: translateY(-1px);
    }

    .hotel-name {
      flex: 1;
      font-weight: 600;
      color: #111827;
    }

    .hotel-stars {
      font-size: 12px;
      color: #f59e0b;
      white-space: nowrap;
    }

    .tag {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15,23,42,0.04);
      color: #4b5563;
      font-weight: 600;
    }

    .tag.pending { background: #fff7e6; color: #b45309; }
    .tag.confirmed { background: #dcfce7; color: #15803d; }
    .tag.rejected { background: #fee2e2; color: #b91c1c; }
    .tag.change { background: #dbeafe; color: #1d4ed8; }

    /* HOTEL BLOCK */

    .hotel-block {
      border: 1px solid rgba(226,232,240,0.9);
      background: linear-gradient(145deg, #f3f4ff, #ffffff);
      border-radius: 18px;
      padding: 18px 18px 16px;
      margin-bottom: 20px;
      box-shadow:
        7px 7px 16px rgba(15,23,42,0.14),
        -7px -7px 16px rgba(255,255,255,0.95);
    }

    .hotel-block-title {
      font-size: 18px;
      font-weight: 800;
      color: #020617;
      margin-bottom: 6px;
    }

    .hotel-totals-line {
      font-size: 14px;
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px dashed #cbd5e1;
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      color: #1d4ed8;
    }

    /* ROOM CONFIG */

    .room-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      background: #e5e9f2;
      border: none;
      box-shadow:
        inset 3px 3px 7px rgba(148,163,184,0.5),
        inset -3px -3px 7px rgba(255,255,255,0.8);
    }

    .qty-controls {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      background: #f3f4f6;
      box-shadow:
        inset 2px 2px 5px rgba(148,163,184,0.8),
        inset -2px -2px 5px rgba(255,255,255,1);
      font-size: 18px;
    }

    .qty-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: #4b5563;
      padding: 0 4px;
      transition: color 0.15s ease, transform 0.1s ease;
    }

    .qty-btn:hover {
      color: #1d4ed8;
      transform: translateY(-1px);
    }

    .qty-value {
      min-width: 20px;
      text-align: center;
      font-weight: 700;
      color: #111827;
    }

    .room-remove {
      margin-left: auto;
      color: #f97373;
      font-size: 18px;
      background: none;
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease, color 0.15s ease;
    }

    .room-remove:hover {
      transform: scale(1.1);
      color: #ef4444;
    }

    .add-room-btn {
      margin-top: 6px;
      border: none;
      padding: 9px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #e0f2fe, #eff6ff);
      font-size: 13px;
      cursor: pointer;
      color: #1d4ed8;
      font-weight: 700;
      box-shadow:
        3px 3px 9px rgba(148,163,184,0.7),
        -3px -3px 9px rgba(255,255,255,1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .add-room-btn:hover {
      transform: translateY(-1px);
      box-shadow:
        4px 4px 10px rgba(148,163,184,0.9),
        -4px -4px 10px rgba(255,255,255,1);
    }

    .extra-bed-container {
      display: none;
      align-items: center;
      gap: 5px;
      font-size: 13px;
      color: #10b981;
      font-weight: 700;
    }

    .extra-bed-container input[type="checkbox"] {
      margin: 0;
      accent-color: #10b981;
    }

    /* OPERATIONS */

    .operations-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .operation-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 11px;
      border-radius: 14px;
      background: #eef2ff;
      border: none;
      font-weight: 500;
      cursor: pointer;
      box-shadow:
        inset 2px 2px 5px rgba(148,163,184,0.6),
        inset -2px -2px 5px rgba(255,255,255,1);
      transition: transform 0.1s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .operation-item:hover {
      transform: translateY(-1px);
      background: #e0ecff;
      box-shadow:
        3px 3px 9px rgba(148,163,184,0.7),
        -3px -3px 9px rgba(255,255,255,1);
    }

    /* TOTALS CARD */

    .totals-card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.92));
      color: #f9fafb;
      padding: 24px;
      border-radius: 20px;
      box-shadow:
        10px 10px 26px rgba(15,23,42,0.7),
        -6px -6px 18px rgba(148,163,184,0.25);
      border: 1px solid rgba(148,163,184,0.5);
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 9px;
      font-size: 14px;
    }

    .totals-row strong {
      font-weight: 800;
    }

    .grand {
      font-size: 24px;
      font-weight: 800;
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid rgba(148,163,184,0.4);
      color: #34d399;
    }

    #reserveBtn {
      padding: 14px 16px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      font-size: 16px;
      font-weight: 800;
      border-radius: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: 18px;
      border: none;
      color: white;
      box-shadow:
        0 8px 18px rgba(22,163,74,0.6);
      transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
    }

    #reserveBtn:disabled {
      background: linear-gradient(135deg, #9ca3af, #6b7280);
      box-shadow: none;
      cursor: not-allowed;
    }

    #reserveBtn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow:
        0 10px 24px rgba(22,163,74,0.75);
    }

    /* CONSTRAINT WARNING */

    .constraint-warning {
      background: #fef2f2;
      color: #b91c1c;
      padding: 10px 12px;
      border-radius: 12px;
      margin-top: 10px;
      font-weight: 600;
      border: 1px solid #fecaca;
      display: none;
      font-size: 13px;
    }

    /* MODAL */

    #reservationModal > div {
      max-width: 900px;
      background: rgba(255,255,255,0.92) !important;
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      border-radius: 22px;
      box-shadow:
        14px 14px 32px rgba(15,23,42,0.4),
        -10px -10px 28px rgba(255,255,255,0.9);
      border: 1px solid rgba(199,210,254,0.9);
    }

    #reservationSummary {
      background: linear-gradient(130deg, #e0ecff, #f1f5f9);
      border: 1px solid #bfdbfe;
      color: #1e40af;
      padding: 18px;
      border-radius: 14px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-grid h4 {
      margin: 0 0 10px;
      color: #1e40af;
      font-size: 15px;
      font-weight: 800;
    }

    .summary-detail-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin: 4px 0;
      gap: 10px;
    }

    .summary-price-col {
      border-left: 1px solid #bfdbfe;
      padding-left: 15px;
    }

    @media (max-width: 900px) {
      .summary-price-col {
        border-left: none;
        border-top: 1px solid #bfdbfe;
        padding-left: 0;
        padding-top: 14px;
        margin-top: 6px;
      }
    }

    #confirmReserveBtn {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow:
        0 8px 20px rgba(37,99,235,0.55);
      border-radius: 14px;
    }

    #confirmReserveBtn:hover {
      transform: translateY(-2px);
      box-shadow:
        0 10px 26px rgba(37,99,235,0.7);
    }

    .alert, .success {
      padding: 11px 12px;
      border-radius: 10px;
      font-weight: 600;
      margin-top: 12px;
      font-size: 13px;
    }

    .alert {
      background-color: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .success {
      background-color: #dcfce7;
      color: #15803d;
      border: 1px solid #86efac;
    }

    /* TABS */

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      gap: 4px;
    }

    .tab-btn {
      padding: 9px 16px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: #6b7280;
      transition: all 0.2s ease;
      margin-bottom: -2px;
      border-radius: 10px 10px 0 0;
    }

    .tab-btn.active {
      color: #1d4ed8;
      border-bottom-color: #1d4ed8;
      background: rgba(255,255,255,0.9);
      box-shadow:
        -2px -4px 8px rgba(255,255,255,1),
        0 4px 10px rgba(148,163,184,0.25);
    }

    /* RESERVATION LIST */

    .agent-res-header {
      font-weight: 700;
      padding: 12px 10px;
      border-bottom: 2px solid #e5e7eb;
      color: #111827;
      background: rgba(248,250,252,0.9);
    }

    .agent-res-row {
      display: grid;
      grid-template-columns: 0.1fr 0.3fr 0.3fr 0.2fr 0.1fr;
      padding: 11px 10px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
      cursor: pointer;
      align-items: center;
      transition: background 0.18s ease, box-shadow 0.18s ease, transform 0.1s ease;
    }

    .agent-res-row:hover {
      background: rgba(255,255,255,0.9);
      box-shadow:
        2px 2px 6px rgba(148,163,184,0.4),
        -2px -2px 6px rgba(255,255,255,1);
      transform: translateY(-1px);
    }

    .res-detail-item {
      margin-top: 22px;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid #bfdbfe;
      background: linear-gradient(145deg, #e5edff, #ffffff);
      box-shadow:
        5px 5px 14px rgba(148,163,184,0.6),
        -5px -5px 14px rgba(255,255,255,1);
      font-size: 14px;
    }

    .res-detail-item h4 {
      margin-top: 0;
      color: #1d4ed8;
      font-weight: 800;
    }

    .res-actions button {
      margin-right: 10px;
      padding: 7px 13px;
      font-size: 13px;
      border-radius: 999px;
      cursor: pointer;
      border: none;
      font-weight: 700;
      box-shadow:
        2px 2px 6px rgba(148,163,184,0.6),
        -2px -2px 6px rgba(255,255,255,1);
      transition: transform 0.1s ease, box-shadow 0.15s ease;
    }

    .res-actions button:hover {
      transform: translateY(-1px);
      box-shadow:
        3px 3px 7px rgba(148,163,184,0.8),
        -3px -3px 7px rgba(255,255,255,1);
    }

    .res-actions .btn-accept { background: #10b981; color: white; }
    .res-actions .btn-reject { background: #ef4444; color: white; }
    .res-actions .btn-delete { background: #6b7280; color: white; }

    /* SMALL ELEMENTS */

    #agentInfo button {
      padding: 7px 11px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      box-shadow:
        0 4px 10px rgba(248,113,113,0.55);
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    #agentInfo button:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow:
        0 6px 14px rgba(248,113,113,0.7);
    }

    /* SCROLLBARS (LIGHT) */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 999px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #93c5fd;
    }
  </style>
</head>
<body>
  
  <div class="page">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h1 style="margin: 0;">B2B Booking Console</h1>
        <div id="agentInfo" style="display: flex; align-items: center; gap: 15px; font-size: 15px; font-weight: 600;">
            <span id="agentNameDisplay" style="color: #1d4ed8;"></span>
            <button onclick="logout()">√áƒ±xƒ±≈ü</button>
        </div>
    </div>
    <div class="subtitle">
      √áoxsaylƒ± otel konfiqurasiyasƒ±, d…ôqiq qiym…ôtl…ôndirm…ô v…ô d…ôrhal rezervasiya imkanƒ±.
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-view="booking" onclick="showAgentView('booking')">üìù Yeni Rezervasiya</button>
        <button class="tab-btn" data-view="reservations" onclick="showAgentView('reservations')">üóìÔ∏è Rezervasiyalarƒ±m</button>
    </div>
    
    <div id="bookingView">
        <div class="card">
            <div class="section-title" style="margin-top: 0;">üóìÔ∏è S…ôyah…ôt Tarixi & Qonaqlar</div>
            <div class="row" style="flex-wrap: wrap; align-items: flex-end;">
                <div style="flex:1; min-width: 150px;">
                    <label>Check-in</label>
                    <input type="date" id="checkIn" />
                </div>
                <div style="flex:1; min-width: 150px;">
                    <label>Check-out</label>
                    <input type="date" id="checkOut" />
                </div>
                <div style="flex:1; min-width: 100px;">
                    <label>Adults</label>
                    <input type="number" id="adults" min="1" value="2" />
                </div>
                <div style="flex:1; min-width: 100px;">
                    <label>Children</label>
                    <input type="number" id="children" min="0" value="0" />
                </div>
                <div style="min-width: 150px; margin-left: auto; display: flex; justify-content: flex-end;">
                    <div class="pill">
                        √úmumi Gec…ô M√ºdd…ôti: <span id="nights">0</span>
                    </div>
                </div>
            </div>

        </div>

        <div class="main-content-grid">
            
            <div class="sticky-sidebar">
                <div class="card" style="margin-bottom: 25px;">
                    <div class="section-title" style="margin-top: 0; margin-bottom: 15px; border-left-color: #9333ea;">üîç Hotell…ôri Filtirl…ô</div>
                    
                    <div class="filter-header">Regionlar</div>
                    <div class="filter-box" id="regionsBox" style="margin-bottom: 20px;"></div>

                    <div class="filter-header">Ulduz Sayƒ±</div>
                    <div class="filter-box" id="starsBox"></div>
                </div>
            </div>

            <div>
                <div class="card">
                    <div class="section-title" style="margin-top: 0; border-left-color: #f59e0b;">üè® Filterl…ônmi≈ü Hotell…ôrin Se√ßimi</div>
                    <div class="filter-box" id="hotelsBox" style="max-height: 250px; border: none; background: transparent; padding: 0;"></div>
                </div>
                
                <div id="constraintWarning" class="constraint-warning"></div>

                <div class="section-title" style="margin-top: 25px;">‚öôÔ∏è Se√ßilmi≈ü Hotell…ôrin Konfiqurasiyasƒ±</div>
                <div id="hotelsCalcs">
                    <p style="color: #6b7280; font-style: italic; font-size: 15px; padding-left: 15px;">Z…ôhm…ôt olmasa, yuxarƒ±dakƒ± siyahƒ±dan otel se√ßin.</p>
                </div>
            </div>
            
            <div class="sticky-sidebar">
                <div class="totals-card">
                    <div class="totals-row" style="font-size: 13px; font-weight: 500; margin-bottom: 15px; color: #9ca3af;">
                        <span>Se√ßilmi≈ü hotel sayƒ±:</span>
                        <span id="selectedHotelsCount" style="font-weight: 700;">0</span>
                    </div>

                    <div class="totals-row">
                        <span>Rooms subtotal (toplam)</span>
                        <span id="roomsSubtotal">0 $</span>
                    </div>
                    <div class="totals-row">
                        <span>Extra beds (toplam)</span>
                        <span id="extraBedsTotal">0 $</span>
                    </div>
                    <div class="totals-row">
                        <span>Meals (toplam)</span>
                        <span id="mealsTotal">0 $</span>
                    </div>
                    
                    <hr style="border-top: 1px solid rgba(148,163,184,0.4); margin: 10px 0;">

                    <div class="totals-row">
                        <strong>Hotels subtotal (c…ômi)</strong>
                        <strong id="hotelSubtotal">0 $</strong>
                    </div>
                    <div class="totals-row" style="margin-bottom: 20px;">
                        <span>Operations (hamƒ±ya eyni)</span>
                        <span id="operationsTotal">0 $</span>
                    </div>
                    
                    <div class="grand">
                        Grand Total: <span id="grandTotal">0 $</span>
                    </div>
                    
                    <button id="reserveBtn" disabled>Rezervasiyanƒ± G√∂nd…ôr</button>
                </div>
                
                <div class="card" style="margin-top: 25px; padding: 18px;">
                    <div class="section-title" style="margin-top: 0; margin-bottom: 12px; border-left-color: #f59e0b;">‚úàÔ∏è Operations / Transfer</div>
                    <div class="operations-list" id="operationsContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reservationsView" style="display: none;">
        <div class="card" style="padding: 0;">
            <div class="agent-res-header agent-res-row">
                <div># ID</div>
                <div>Tarix Aralƒ±ƒüƒ±</div>
                <div>Hotell…ôr</div>
                <div>Status</div>
                <div style="text-align: right;">Qiym…ôt</div>
            </div>
            <div id="agentReservationsList">
                <div style="padding: 20px; text-align: center; color: #6b7280;">Rezervasiya m…ôlumatlarƒ± y√ºkl…ônir...</div>
            </div>
        </div>

        <div id="agentReservationDetail" class="res-detail-item" style="display: none; margin-top: 25px;">
        </div>
    </div>


  <div id="reservationModal" style="
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(15,23,42,0.6); 
    display: none; 
    justify-content: center; 
    align-items: center; 
    z-index: 100;
  ">
    <div style="
      padding: 24px; 
      max-width: 900px; 
      width: 90%; 
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    ">
      <h2 style="margin: 0 0 16px; font-size: 22px; color: #111827;">Rezervasiyanƒ±n T…ôsdiql…ônm…ôsi</h2>
      <button onclick="closeReservationModal()" style="
        position: absolute; 
        top: 10px; 
        right: 15px; 
        background: none; 
        border: none; 
        font-size: 24px; 
        cursor: pointer; 
        color: #6b7280;
      ">√ó</button>

      <div id="reservationSummary" style="margin-bottom: 20px; font-size: 15px;"></div>
      
      <form id="reservationForm">
        <div id="travelersForm">
          <div class="section-title" style="margin-top: 0; border-left-color: #3b82f6;">üë§ S…ôyah…ôt√ßi M…ôlumatlarƒ±</div>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">

        <div class="section-title" style="border-left-color: #f59e0b;">‚úàÔ∏è U√ßu≈ü M…ôlumatlarƒ± (Flight Information)</div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Arrival Date (G…ôli≈ü tarixi)</label>
            <input type="date" id="flightArrivalDate" name="flightArrivalDate" />
          </div>
          <div>
            <label>Arrival Time (G…ôli≈ü vaxtƒ± - Manual)</label>
            <input type="text" id="flightArrivalTime" name="flightArrivalTime" placeholder="M…ôs: 12:18" />
          </div>
          
          <div>
            <label>Departure Date (Gedi≈ü tarixi)</label>
            <input type="date" id="flightDepartureDate" name="flightDepartureDate" />
          </div>
          <div>
            <label>Departure Time (Gedi≈ü vaxtƒ± - Manual)</label>
            <input type="text" id="flightDepartureTime" name="flightDepartureTime" placeholder="M…ôs: 12:18" />
          </div>
        </div>
        
        <button type="submit" id="confirmReserveBtn" style="
            border: none; 
            padding: 12px 16px; 
            color: white; 
            font-size: 16px; 
            font-weight: 700; 
            border-radius: 8px; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 25px;
            transition: background 0.3s;
        ">Rezervasiyanƒ± T…ôsdiql…ô</button>
        <div id="reservationMsg" style="margin-top: 15px; font-size: 14px;"></div>
      </form>
    </div>
  </div>

  <script>
    
    // --- Login Control ---
    const LOGGED_IN_AGENT = JSON.parse(localStorage.getItem('b2b_agent_auth'));

    if (!LOGGED_IN_AGENT || !LOGGED_IN_AGENT.success) {
        window.location.href = 'login.html'; 
    } else {
        document.getElementById('agentNameDisplay').textContent = LOGGED_IN_AGENT.name + ' (' + LOGGED_IN_AGENT.role + ')';
    }

    function logout() {
        localStorage.removeItem('b2b_agent_auth');
        window.location.href = 'login.html';
    }
    // --- End Login Control ---
    
    const TAX_RATE = 0; // VERGƒ∞ L∆èƒûV EDƒ∞LDƒ∞: 0-a b…ôrab…ôrdir
    let dbData = { regions: [], hotels: [], operations: [], reservations: [] };
    const dateFormatter = new Intl.DateTimeFormat('az-AZ', { day: '2-digit', month: 'short', year: 'numeric' });
    
    // --- UTILITY FUNCTIONS ---
    
    function formatMoney(v) {
      v = Math.round((v + Number.EPSILON) * 100) / 100;
      return v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' $';
    }

    function statusToTag(status) {
        const statuses = {
            'Pending Admin': '<span class="tag pending">Admin G√∂zl…ôyir</span>',
            'Confirmed': '<span class="tag confirmed">T…ôsdiql…ôndi</span>',
            'Rejected': '<span class="tag rejected">R…ôdd edildi</span>',
            'Date Change Requested': '<span class="tag change">Tarix D…ôyi≈üikliyi Sorƒüusu</span>',
            'Date Change Accepted': '<span class="tag confirmed">Tarix D…ôyi≈üikliyi Q…ôbul</span>',
            'Date Change Rejected': '<span class="tag rejected">Tarix D…ôyi≈üikliyi R…ôdd</span>'
        };
        return statuses[status] || `<span class="tag">${status}</span>`;
    }

    function generateTravelerForm(type, index) {
        const id = `${type}${index}`;
        const typeLabel = type === 'adult' ? 'B√∂y√ºk (Adult)' : 'U≈üaq (Child)';
        const typeColor = type === 'adult' ? '#111827' : '#b91c1c';
        const typeBg = type === 'adult' ? '#ffffff' : '#fef2f2';

        return `
            <div style="
                border: 1px solid #d1d5db; 
                padding: 12px; 
                border-radius: 10px; 
                margin-bottom: 10px;
                background: ${typeBg};
            ">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: ${typeColor};">
                    ${typeLabel} \#${index + 1}
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                    <div>
                        <label>Ad (First Name) *</label>
                        <input type="text" name="travelerName_${id}" required>
                    </div>
                    <div>
                        <label>Soyad (Last Name) *</label>
                        <input type="text" name="travelerSurname_${id}" required>
                    </div>
                    <div>
                        <label>Doƒüum g√ºn√º (Date of Birth) *</label>
                        <input type="date" name="travelerDOB_${id}" required>
                    </div>
                    <div>
                        <label>V…ôt…ônda≈ülƒ±q (Nationality) *</label>
                        <input type="text" name="travelerNationality_${id}" placeholder="AZ, TR, RU,..." required>
                    </div>
                </div>
            </div>
        `;
    }

    // --- DATA FETCHING & RENDERING (BOOKING VIEW) ---
    
    function fetchData() {
      fetch('/api/data')
        .then(r => r.json())
        .then(data => {
          dbData = data;
          renderRegions();
          renderStars();
          renderHotelsFilter();
          renderOperations();
        })
        .catch(err => console.error('Error loading data', err));
    }

    function renderRegions() {
      const box = document.getElementById('regionsBox');
      box.innerHTML = '';
      dbData.regions.forEach(region => {
        const label = document.createElement('label');
        label.className = 'filter-item';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = region.id;
        input.name = 'regionFilter';
        input.addEventListener('change', onFilterChange);
        label.appendChild(input);
        label.appendChild(document.createTextNode(region.name));
        box.appendChild(label);
      });
    }

    function renderStars() {
      const box = document.getElementById('starsBox');
      box.innerHTML = '';
      const stars = [
        { value: 2, label: '2*' },
        { value: 3, label: '3*' },
        { value: 4, label: '4*' },
        { value: 5, label: '5*' },
        { value: 'others', label: 'Others' }
      ];
      stars.forEach(s => {
        const label = document.createElement('label');
        label.className = 'filter-item';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = s.value;
        input.name = 'starFilter';
        input.addEventListener('change', onFilterChange);
        label.appendChild(input);
        const text = '‚òÖ'.repeat(s.value > 0 ? s.value : 1) + ' ' + s.label;
        label.appendChild(document.createTextNode(text));
        box.appendChild(label);
      });
    }

    function selectedRegionIds() {
      return Array.from(document.querySelectorAll('input[name="regionFilter"]:checked')).map(el => el.value);
    }

    function selectedStarFilters() {
      return Array.from(document.querySelectorAll('input[name="starFilter"]:checked')).map(el => el.value);
    }

    function filterHotels() {
      const regions = selectedRegionIds();
      const starFilters = selectedStarFilters();
      return dbData.hotels.filter(h => {
        const regionMatch = regions.length === 0 || regions.includes(String(h.regionId));
        let starMatch = true;
        if (starFilters.length > 0) {
          starMatch = false;
          starFilters.forEach(sf => {
            if (sf === 'others') {
              if (![2,3,4,5].includes(Number(h.stars))) starMatch = true;
            } else {
              if (Number(sf) === Number(h.stars)) starMatch = true;
            }
          });
        }
        return regionMatch && starMatch;
      });
    }

    function renderHotelsFilter() {
      const box = document.getElementById('hotelsBox');
      box.innerHTML = '';
      const filtered = filterHotels();
      filtered.forEach(hotel => {
        const label = document.createElement('label');
        label.className = 'hotel-item';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.name = 'hotelFilter';
        input.value = hotel.id;
        input.addEventListener('change', onHotelsSelectionChange);
        const nameSpan = document.createElement('span');
        nameSpan.className = 'hotel-name';
        nameSpan.textContent = hotel.name;
        const starsSpan = document.createElement('span');
        starsSpan.className = 'hotel-stars';
        starsSpan.textContent = '‚òÖ'.repeat(hotel.stars || 0);
        label.appendChild(input);
        label.appendChild(nameSpan);
        label.appendChild(starsSpan);
        box.appendChild(label);
      });
    }

    function onFilterChange() {
      renderHotelsFilter();
      renderHotelBlocks();
      recalcTotals();
    }

    function getSelectedHotelIds() {
      return Array.from(document.querySelectorAll('input[name="hotelFilter"]:checked')).map(el => el.value);
    }

    function onHotelsSelectionChange() {
      renderHotelBlocks();
      recalcTotals();
    }

    function renderHotelBlocks() {
      const container = document.getElementById('hotelsCalcs');
      const selectedIds = getSelectedHotelIds();
      container.innerHTML = '';
      document.getElementById('selectedHotelsCount').textContent = selectedIds.length;
      
      if (selectedIds.length === 0) {
          container.innerHTML = '<p style="color: #6b7280; font-style: italic; font-size: 15px; padding-left: 15px;">Z…ôhm…ôt olmasa, yuxarƒ±dakƒ± siyahƒ±dan otel se√ßin.</p>';
      }

      selectedIds.forEach(id => {
        const hotel = dbData.hotels.find(h => String(h.id) === String(id));
        if (!hotel) return;
        const block = document.createElement('div');
        block.className = 'hotel-block';
        block.dataset.hotelId = hotel.id;

        const header = document.createElement('div');
        header.className = 'hotel-block-header';

        const title = document.createElement('div');
        title.className = 'hotel-block-title';
        title.textContent = hotel.name;

        const meta = document.createElement('div');
        meta.className = 'hotel-block-meta';
        meta.style.display = 'flex';
        meta.style.flexWrap = 'wrap';
        meta.style.gap = '8px';
        meta.style.marginTop = '4px';

        const region = dbData.regions.find(r => String(r.id) === String(hotel.regionId));
        const regionTag = document.createElement('span');
        regionTag.className = 'tag';
        regionTag.textContent = region ? region.name : 'No region';

        const stars = document.createElement('span');
        stars.className = 'stars';
        stars.textContent = '‚òÖ'.repeat(hotel.stars || 0);

        const extra = document.createElement('span');
        extra.className = 'tag';
        extra.textContent = 'Extra bed: ' + (hotel.extraBedPricePerNight || 0) + ' $ / night';

        meta.appendChild(regionTag);
        meta.appendChild(stars);
        meta.appendChild(extra);

        header.appendChild(title);
        header.appendChild(meta);

        const body = document.createElement('div');

        // Rooms
        const roomsTitle = document.createElement('div');
        roomsTitle.style.fontSize = '14px';
        roomsTitle.style.fontWeight = '600';
        roomsTitle.style.margin = '10px 0 6px';
        roomsTitle.textContent = 'Otaq Se√ßimi';
        body.appendChild(roomsTitle);

        const roomsContainer = document.createElement('div');
        roomsContainer.id = 'rooms_h' + hotel.id;
        body.appendChild(roomsContainer);

        const addRoomBtn = document.createElement('button');
        addRoomBtn.type = 'button';
        addRoomBtn.className = 'add-room-btn';
        addRoomBtn.textContent = '+ Otaq tipi …ôlav…ô et';
        addRoomBtn.addEventListener('click', () => {
          createRoomRowForHotel(hotel, roomsContainer);
        });
        body.appendChild(addRoomBtn);

        // Meal
        const mealTitle = document.createElement('div');
        mealTitle.style.fontSize = '14px';
        mealTitle.style.fontWeight = '600';
        mealTitle.style.margin = '15px 0 8px';
        mealTitle.textContent = 'Qidalanma Planƒ±';
        body.appendChild(mealTitle);

        const mealsBox = document.createElement('div');
        mealsBox.id = 'meals_h' + hotel.id;
        body.appendChild(mealsBox);

        // Per-hotel total line
        const totalsLine = document.createElement('div');
        totalsLine.className = 'hotel-totals-line';
        totalsLine.innerHTML = '<span>Bu hotel √º√ß√ºn subtotal:</span> <span id="hotelTotal_h' + hotel.id + '">0 $</span>';
        body.appendChild(totalsLine);

        block.appendChild(header);
        block.appendChild(body);
        container.appendChild(block);

        // initial one room row + meal plans
        createRoomRowForHotel(hotel, roomsContainer);
        renderMealsForHotel(hotel, mealsBox);
      });
    }

    function createRoomRowForHotel(hotel, container) {
      const row = document.createElement('div');
      row.className = 'room-row';

      const roomSelect = document.createElement('select');
      roomSelect.className = 'room-type-select';
      
      roomSelect.innerHTML = '<option value="">Room type se√ß...</option>'; 
      
      (hotel.roomTypes || []).forEach((rt, index) => {
        const opt = document.createElement('option');
        opt.value = rt.id;
        opt.setAttribute('data-extrabed', rt.isExtraBedAllowed ? 'true' : 'false');
        opt.textContent = rt.name + ' (' + rt.pricePerNight + ' $ / night)';
        if (index === 0 && !container.querySelector('.room-row')) {
          opt.selected = true;
        }
        roomSelect.appendChild(opt);
      });

      const qtyControls = document.createElement('div');
      qtyControls.className = 'qty-controls';
      const minusBtn = document.createElement('button');
      minusBtn.type = 'button';
      minusBtn.className = 'qty-btn';
      minusBtn.textContent = '‚Äî';
      const qtyValue = document.createElement('span');
      qtyValue.className = 'qty-value';
      qtyValue.textContent = '1';
      const plusBtn = document.createElement('button');
      plusBtn.type = 'button';
      plusBtn.className = 'qty-btn';
      plusBtn.textContent = '+';
      qtyControls.appendChild(minusBtn);
      qtyControls.appendChild(qtyValue);
      qtyControls.appendChild(plusBtn);
      
      const nightLabel = document.createElement('span');
      nightLabel.textContent = ' Gec…ô';
      nightLabel.style.fontSize = '12px';
      nightLabel.style.color = '#4b5563';
      
      const extraBedContainer = document.createElement('label');
      extraBedContainer.className = 'extra-bed-container';
      extraBedContainer.style.display = 'none';
      
      const extraBedInput = document.createElement('input');
      extraBedInput.type = 'checkbox';
      extraBedInput.className = 'extra-bed-checkbox';
      
      const extraBedLabel = document.createElement('span');
      extraBedLabel.textContent = 'Extra Bed';
      extraBedContainer.appendChild(extraBedInput);
      extraBedContainer.appendChild(extraBedLabel);
      

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'room-remove';
      removeBtn.textContent = '√ó';

      row.appendChild(roomSelect);
      row.appendChild(qtyControls);
      row.appendChild(nightLabel);
      row.appendChild(extraBedContainer);
      row.appendChild(removeBtn);
      container.appendChild(row);

      roomSelect.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const isAllowed = selectedOption && selectedOption.getAttribute('data-extrabed') === 'true';
          
          if (isAllowed) {
              extraBedContainer.style.display = 'flex';
          } else {
              extraBedContainer.style.display = 'none';
              extraBedInput.checked = false; 
          }
          recalcTotals();
      });
      
      minusBtn.addEventListener('click', () => {
        const maxNights = getMaxNights();
        let v = parseInt(qtyValue.textContent || '0', 10);
        
        if (v > 1) {
          qtyValue.textContent = String(v - 1);
          recalcTotals();
        }
      });
      plusBtn.addEventListener('click', () => {
        const maxNights = getMaxNights();
        let v = parseInt(qtyValue.textContent || '0', 10);
        
        if (v < maxNights) {
            qtyValue.textContent = String(v + 1);
            recalcTotals();
        } else if (maxNights > 0) {
             document.getElementById('constraintWarning').textContent = `‚ö†Ô∏è X…ôta: Bu hoteld…ô se√ßilmi≈ü gec…ôl…ôm…ô sayƒ± (${v + 1}) √ºmumi s…ôyah…ôt m√ºdd…ôtini (${maxNights}) a≈üƒ±r.`;
             document.getElementById('constraintWarning').style.display = 'block';
             setTimeout(() => document.getElementById('constraintWarning').style.display = 'none', 5000);
        }
      });
      removeBtn.addEventListener('click', () => {
        row.remove();
        recalcTotals();
      });
      
      if (roomSelect.value) {
          roomSelect.dispatchEvent(new Event('change'));
      }
    }

    function renderMealsForHotel(hotel, container) {
      container.innerHTML = '';
      
      if (!hotel.mealPlans || hotel.mealPlans.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:#6b7280;">Bu hotel √º√ß√ºn meal plan yoxdur.</span>';
        return;
      }
      
      const noMealLabel = document.createElement('label');
      noMealLabel.className = 'meal-item';
      const noMealInput = document.createElement('input');
      noMealInput.type = 'radio';
      noMealInput.name = 'mealPlan_h' + hotel.id;
      noMealInput.value = '0'; 
      noMealInput.checked = true; 
      noMealInput.addEventListener('change', recalcTotals);
      const noMealText = document.createElement('span');
      noMealText.textContent = 'Qidalanma yoxdur';
      const noMealPrice = document.createElement('span');
      noMealPrice.style.fontSize = '12px';
      noMealPrice.style.color = '#6b7280';
      noMealPrice.textContent = ' 0 $';
      noMealLabel.appendChild(noMealInput);
      noMealLabel.appendChild(noMealText);
      noMealLabel.appendChild(noMealPrice);
      container.appendChild(noMealLabel);

      
      hotel.mealPlans.forEach((mp, idx) => {
        const label = document.createElement('label');
        label.className = 'meal-item';
        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'mealPlan_h' + hotel.id;
        input.value = mp.id;
        input.addEventListener('change', recalcTotals); 
        const text = document.createElement('span');
        text.textContent = mp.name;
        const price = document.createElement('span');
        price.style.fontSize = '12px';
        price.style.color = '#6b7280';
        price.textContent = ' ' + mp.pricePerPersonPerNight + ' $ / person / night';
        label.appendChild(input);
        label.appendChild(text);
        label.appendChild(price);
        container.appendChild(label);
      });
    }

    function renderOperations() {
      const container = document.getElementById('operationsContainer');
      container.innerHTML = '';
      if (!dbData.operations || dbData.operations.length === 0) {
        container.innerHTML = '<span style="font-size:14px;color:#6b7280; font-style: italic;">∆èm…ôliyyatlar …ôlav…ô edilm…ôyib.</span>';
        return;
      }
      dbData.operations.forEach(op => {
        const id = 'op_' + op.id;
        const row = document.createElement('label');
        row.className = 'operation-item';
        
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.setAttribute('data-price', op.price);
        input.style.marginRight = '8px';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = op.name;

        const left = document.createElement('span');
        left.appendChild(input);
        left.appendChild(nameSpan);

        const right = document.createElement('span');
        right.className = 'price';
        right.textContent = op.price + ' $';
        
        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
      });
      
      recalcTotals();
    }

    function getMaxNights() {
      const inEl = document.getElementById('checkIn');
      const outEl = document.getElementById('checkOut');
      const nightsEl = document.getElementById('nights');
      
      const inDate = inEl.value ? new Date(inEl.value + 'T00:00:00') : null;
      const outDate = outEl.value ? new Date(outEl.value + 'T00:00:00') : null;
      
      let maxNights = 0;
      if (inDate && outDate && outDate > inDate) {
        const diffMs = outDate - inDate;
        maxNights = Math.round(diffMs / (1000 * 60 * 60 * 24)); 
      }
      
      nightsEl.textContent = maxNights;
      return maxNights;
    }

    function recalcTotals(getTotalsOnly = false) {
      const maxNights = getMaxNights(); 
      const adults = parseInt(document.getElementById('adults').value || '0', 10);
      const children = parseInt(document.getElementById('children').value || '0', 10);

      const selectedIds = getSelectedHotelIds();
      let totalRoomsSubtotal = 0;
      let totalExtraBeds = 0;
      let totalMeals = 0;
      let totalBookedNights = 0; 
      const totalTaxes = 0; 

      let operationsTotal = 0;
      document.querySelectorAll('#operationsContainer input[type="checkbox"]:checked').forEach(cb => {
        const price = parseFloat(cb.getAttribute('data-price') || '0');
        operationsTotal += price;
      });

      selectedIds.forEach(id => {
        const hotel = dbData.hotels.find(h => String(h.id) === String(id));
        if (!hotel) return;

        let hotelRoomsSubtotal = 0;
        let hotelMeals = 0;
        let hotelExtraBeds = 0;
        let totalNightsForHotel = 0; 
        
        const roomsContainer = document.getElementById('rooms_h' + hotel.id);
        const extraBedPrice = Number(hotel.extraBedPricePerNight || 0);

        if (roomsContainer) {
          const rows = roomsContainer.querySelectorAll('.room-row');
          const roomTypesMap = {};
          (hotel.roomTypes || []).forEach(rt => { roomTypesMap[rt.id] = rt; });
          
          rows.forEach(row => {
            const sel = row.querySelector('.room-type-select');
            const qtyVal = row.querySelector('.qty-value'); 
            const extraBedCb = row.querySelector('.extra-bed-checkbox');
            
            if (!sel || !qtyVal) return;

            const nightsAtHotelRow = parseInt(qtyVal.textContent || '0', 10);
            
            if (nightsAtHotelRow <= 0) return; 

            totalBookedNights += nightsAtHotelRow; 
            totalNightsForHotel += nightsAtHotelRow; 
            
            const rt = roomTypesMap[sel.value];
            
            if (!rt) return; 

            hotelRoomsSubtotal += rt.pricePerNight * nightsAtHotelRow;

            if (extraBedCb && extraBedCb.checked && extraBedPrice > 0) {
               const eb = extraBedPrice * nightsAtHotelRow;
               totalExtraBeds += eb;
               hotelExtraBeds += eb;
            }
            
            const mealRadio = document.querySelector('input[name="mealPlan_h' + hotel.id + '"]:checked');
            if (mealRadio && mealRadio.value !== '0') {
              const mealId = mealRadio.value;
              const mp = (hotel.mealPlans || []).find(m => String(m.id) === String(mealId));
              if (mp) {
                const guests = adults + children;
                hotelMeals += mp.pricePerPersonPerNight * guests * nightsAtHotelRow;
              }
            }
          });
        }
        
        const hotelSubtotal = hotelRoomsSubtotal + hotelMeals + hotelExtraBeds; 

        totalRoomsSubtotal += hotelRoomsSubtotal;
        totalMeals += hotelMeals;
        
        if (!getTotalsOnly) {
            const hotelTotalEl = document.getElementById('hotelTotal_h' + hotel.id);
            if (hotelTotalEl) {
              hotelTotalEl.textContent = formatMoney(hotelSubtotal); 
            }
        }
      });
      
      const totalHotelSubtotal = totalRoomsSubtotal + totalExtraBeds + totalMeals;
      const grandTotal = totalHotelSubtotal + operationsTotal;

      let constraintViolated = false;
      if (maxNights > 0 && totalBookedNights !== maxNights) {
           document.getElementById('constraintWarning').textContent = `‚ö†Ô∏è X…ôta: C…ômi ${totalBookedNights} gec…ô se√ßilib. √úmumi s…ôyah…ôt m√ºdd…ôti ${maxNights} gec…ôdir. Qalan gec…ôl…ôri (F…ôrq: ${maxNights - totalBookedNights}) dig…ôr hotell…ôr…ô …ôlav…ô edin.`;
           document.getElementById('constraintWarning').style.display = 'block';
           constraintViolated = true;
      } else {
           document.getElementById('constraintWarning').style.display = 'none';
      }


      if (!getTotalsOnly) {
          updateTotals(totalRoomsSubtotal, totalExtraBeds, totalMeals, totalHotelSubtotal, totalTaxes, operationsTotal, grandTotal);
          
          const reserveBtn = document.getElementById('reserveBtn');
          const isReadyToReserve = !constraintViolated && selectedIds.length > 0 && (adults + children) > 0 && totalBookedNights > 0;
          
          reserveBtn.disabled = !isReadyToReserve;
          if (isReadyToReserve) {
              reserveBtn.textContent = 'Rezervasiyanƒ± G√∂nd…ôr';
          } else if (constraintViolated) {
              reserveBtn.textContent = 'M…ôhdudiyy…ôt X…ôtasƒ±';
          } else if (selectedIds.length === 0) {
              reserveBtn.textContent = 'Hotel se√ßin';
          } else if (totalBookedNights === 0) {
              reserveBtn.textContent = 'Gec…ô sayƒ± daxil edin';
          } else {
              reserveBtn.textContent = 'Rezervasiyanƒ± G√∂nd…ôr';
          }
      }
      
      return {
          roomsSubtotal: totalRoomsSubtotal,
          extraBedsTotal: totalExtraBeds,
          mealsTotal: totalMeals,
          hotelSubtotal: totalHotelSubtotal,
          taxes: totalTaxes,
          operationsTotal: operationsTotal,
          grandTotal: grandTotal,
          nights: totalBookedNights 
      };
    }


    function updateTotals(roomsSubtotal, extraBedsTotal, mealsTotal, hotelSubtotal, taxes, operationsTotal, grandTotal) {
      document.getElementById('roomsSubtotal').textContent = formatMoney(roomsSubtotal || 0);
      document.getElementById('extraBedsTotal').textContent = formatMoney(extraBedsTotal || 0);
      document.getElementById('mealsTotal').textContent = formatMoney(mealsTotal || 0);
      document.getElementById('hotelSubtotal').textContent = formatMoney(hotelSubtotal || 0);
      document.getElementById('operationsTotal').textContent = formatMoney(operationsTotal || 0);
      document.getElementById('grandTotal').textContent = formatMoney(grandTotal || 0);
    }
    
    function getBookingSummary() {
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;
        const adults = parseInt(document.getElementById('adults').value || '0', 10);
        const children = parseInt(document.getElementById('children').value || '0', 10);
        const selectedHotelIds = getSelectedHotelIds();
        
        const totals = recalcTotals(true);

        const selectedHotels = dbData.hotels.filter(h => selectedHotelIds.includes(String(h.id)));
        const hotelNames = selectedHotels.map(h => h.name).join(', ');

        return {
            checkIn,
            checkOut,
            nights: totals.nights,
            adults,
            children,
            hotels: selectedHotels.map(h => ({ 
                id: h.id, 
                name: h.name, 
                totalPrice: totals.hotelSubtotal / (selectedHotels.length || 1) 
            })),
            totalPrice: totals.grandTotal,
            totalTravelers: adults + children,
            hotelNames: hotelNames,
            roomsSubtotal: totals.roomsSubtotal,
            extraBedsTotal: totals.extraBedsTotal, 
            mealsTotal: totals.mealsTotal,
            hotelSubtotal: totals.hotelSubtotal, 
            operationsTotal: totals.operationsTotal 
        };
    }
    
    // --- MODAL & RESERVATION SUBMISSION ---

    function openReservationModal() {
        const summary = getBookingSummary();
        const modal = document.getElementById('reservationModal');
        const travelersFormEl = document.getElementById('travelersForm');
        const reservationSummaryEl = document.getElementById('reservationSummary');
        
        if (summary.hotels.length === 0 || summary.nights <= 0 || summary.totalTravelers === 0) {
            alert("Rezervasiya etm…ôk √º√ß√ºn …ôn azƒ± bir hotel se√ßilm…ôli, check-in/out tarixl…ôri v…ô qonaq sayƒ± daxil edilm…ôlidir.");
            return;
        }

        reservationSummaryEl.innerHTML = `
            <div class="summary-grid">
                <div>
                    <h4 style="margin: 0 0 10px; color: #1e40af;">REZERVASƒ∞YA ƒ∞CMALI</h4>
                    <div class="summary-detail-row">
                        <span>üè® Hotell…ôr:</span>
                        <strong style="text-align: right;">${summary.hotelNames || '‚Äî'}</strong>
                    </div>
                    <div class="summary-detail-row">
                        <span>üìÖ Tarix:</span>
                        <strong>${summary.checkIn} ‚Üí ${summary.checkOut}</strong>
                    </div>
                    <div class="summary-detail-row">
                        <span>üåô Gec…ô sayƒ±:</span>
                        <strong>${summary.nights} gec…ô</strong>
                    </div>
                    <div class="summary-detail-row">
                        <span>üë• Qonaqlar:</span>
                        <strong>${summary.adults} B√∂y√ºk / ${summary.children} U≈üaq</strong>
                    </div>
                </div>
                
                <div class="summary-price-col">
                    <h4 style="margin: 0 0 10px; color: #1e40af;">Qƒ∞YM∆èT DETALLARI</h4>
                    <div class="summary-detail-row">
                        <span>Otaqlar & Qidalanma</span>
                        <strong>${formatMoney(summary.roomsSubtotal + summary.mealsTotal)}</strong>
                    </div>
                    <div class="summary-detail-row">
                        <span>∆èlav…ô √ßarpayƒ± (Extra Bed)</span>
                        <strong>${formatMoney(summary.extraBedsTotal)}</strong>
                    </div>
                    <div class="summary-detail-row">
                        <span>Xidm…ôtl…ôr (Operations)</span>
                        <strong>${formatMoney(summary.operationsTotal)}</strong>
                    </div>
                    
                    <hr style="border: none; border-top: 2px solid #1e40af; margin: 15px 0;">
                    
                    <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 700; color: #ef4444;">
                        <span>üöÄ Yekun Total:</span>
                        <strong>${formatMoney(summary.totalPrice)}</strong>
                    </div>
                </div>
            </div>
        `;

        let formsHtml = '';
        for (let i = 0; i < summary.adults; i++) {
            formsHtml += generateTravelerForm('adult', i);
        }
        for (let i = 0; i < summary.children; i++) {
            formsHtml += generateTravelerForm('child', i);
        }

        travelersFormEl.innerHTML = `<div class="section-title" style="margin-top: 0; border-left-color: #3b82f6;">üë§ S…ôyah…ôt√ßi M…ôlumatlarƒ± (${summary.totalTravelers} n…ôf…ôr)</div>${formsHtml}`;

        document.getElementById('reservationMsg').textContent = '';
        document.getElementById('reservationForm').reset();
        
        document.getElementById('flightArrivalDate').value = '';
        document.getElementById('flightArrivalTime').value = '';
        document.getElementById('flightDepartureDate').value = '';
        document.getElementById('flightDepartureTime').value = '';
        
        modal.style.display = 'flex';
    }

    function closeReservationModal() {
        document.getElementById('reservationModal').style.display = 'none';
    }
    
    function submitReservation(e) {
        e.preventDefault();
        const msgEl = document.getElementById('reservationMsg');
        msgEl.textContent = 'Rezervasiya g√∂nd…ôrilir...';
        msgEl.className = ''; 

        const summary = getBookingSummary();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const travelers = [];
        const totalTravelers = summary.adults + summary.children;
        
        let allTravelersValid = true;
        for (let i = 0; i < totalTravelers; i++) {
            const type = i < summary.adults ? 'adult' : 'child';
            const index = i < summary.adults ? i : i - summary.adults;
            const id = `${type}${index}`;
            
            const travelerData = {
                type: type,
                name: data[`travelerName_${id}`],
                surname: data[`travelerSurname_${id}`],
                dob: data[`travelerDOB_${id}`],
                nationality: data[`travelerNationality_${id}`]
            };

            if (!travelerData.name || !travelerData.surname || !travelerData.dob || !travelerData.nationality) {
                allTravelersValid = false;
                break;
            }
            
            travelers.push(travelerData);
        }
        
        if (!allTravelersValid) {
            msgEl.textContent = '‚ùå Z…ôhm…ôt olmasa, b√ºt√ºn s…ôyah…ôt√ßi m…ôlumatlarƒ±nƒ± (Ad, Soyad, Doƒüum g√ºn√º, V…ôt…ônda≈ülƒ±q) tam daxil edin.';
            msgEl.className = 'alert';
            return;
        }

        const formatFlightDateTime = (date, time) => {
            if (!date) return '';
            return date + (time ? ' ' + time : '');
        };
        
        const flightInfo = {
            arrival: formatFlightDateTime(data.flightArrivalDate, data.flightArrivalTime),
            departure: formatFlightDateTime(data.flightDepartureDate, data.flightDepartureTime)
        };

        const reservationPayload = {
            summary: summary,
            travelers: travelers,
            flightInfo: flightInfo,
            dateBooked: new Date().toISOString(),
            submittingAgentUsername: LOGGED_IN_AGENT.username
        };

        fetch('/api/reservations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reservationPayload)
        })
        .then(r => r.json())
        .then(res => {
            if (res.error) throw new Error(res.error);
            msgEl.textContent = '‚úÖ Rezervasiya uƒüurla saxlanƒ±ldƒ±! ID: ' + res.id;
            msgEl.className = 'success';
            setTimeout(() => {
                closeReservationModal();
                fetchAgentReservations();
                showAgentView('reservations');
            }, 3000);
        })
        .catch(err => {
            console.error('Reservation error:', err);
            msgEl.textContent = '‚ùå Rezervasiya saxlanƒ±lark…ôn x…ôta: ' + (err.message || 'Server x…ôtasƒ±');
            msgEl.className = 'alert';
        });
    }

    // --- AGENT RESERVATIONS LOGIC ---
    
    function showAgentView(viewId) {
        document.getElementById('bookingView').style.display = 'none';
        document.getElementById('reservationsView').style.display = 'none';
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[data-view="${viewId}"]`).classList.add('active');

        document.getElementById(viewId + 'View').style.display = 'block';

        if (viewId === 'reservations') {
            fetchAgentReservations();
        }
    }

    function fetchAgentReservations() {
        fetch('/api/data')
        .then(r => r.json())
        .then(data => {
            dbData = data;
            
            const agentReservations = data.reservations.filter(res => 
                res.submittingAgentUsername === LOGGED_IN_AGENT.username
            );
            
            renderAgentReservations(agentReservations);
        })
        .catch(err => {
            console.error('Error fetching agent reservations:', err);
            document.getElementById('agentReservationsList').innerHTML = '<div style="padding: 20px; text-align: center; color: #b91c1c;">Rezervasiyalarƒ± y√ºkl…ôy…ôrk…ôn x…ôta ba≈ü verdi.</div>';
        });
    }

    function renderAgentReservations(reservations) {
        const list = document.getElementById('agentReservationsList');
        list.innerHTML = '';
        document.getElementById('agentReservationDetail').style.display = 'none';

        if (!reservations || reservations.length === 0) {
            list.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">He√ß bir rezervasiyanƒ±z yoxdur.</div>';
            return;
        }

        reservations.sort((a, b) => new Date(b.date) - new Date(a.date));

        reservations.forEach(res => {
            const row = document.createElement('div');
            row.className = 'agent-res-row';
            row.onclick = () => showAgentReservationDetail(res);

            const price = (res.summary?.totalPrice || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            row.innerHTML = `
                <div>#${res.id}</div>
                <div>${res.summary?.checkIn} ‚Üí ${res.summary?.checkOut}</div>
                <div>${res.summary?.hotelNames || '‚Äî'}</div>
                <div>${statusToTag(res.status)}</div>
                <div style="text-align: right;">${price} $</div>
            `;
            list.appendChild(row);
        });
    }

    function showAgentReservationDetail(res) {
        const detailBox = document.getElementById('agentReservationDetail');
        detailBox.style.display = 'block';

        const travelersHtml = (res.travelers || []).map((t, index) => {
            const dob = t.dob ? dateFormatter.format(new Date(t.dob)) : '‚Äî';
            return `<div style="margin-left: 15px; font-size: 13px;">${index + 1}. ${t.name} ${t.surname} (${t.type === 'adult' ? 'B√∂y√ºk' : 'U≈üaq'})</div>`;
        }).join('');
        
        const changeRequest = res.changeRequest;
        let changeRequestHtml = '';
        if (res.status === 'Date Change Requested' && changeRequest) {
            changeRequestHtml = `
                <div style="margin-top: 15px; padding: 15px; border-radius: 8px; border: 1px solid #f59e0b; background: #fffbe6;">
                    <h4>üîî Admin Tarix D…ôyi≈üikliyi T…ôklif Edir</h4>
                    <p style="margin: 5px 0;"><strong>K√∂hn…ô:</strong> ${res.summary.checkIn} ‚Üí ${res.summary.checkOut}</p>
                    <p style="margin: 5px 0;"><strong>Yeni:</strong> <span style="font-weight: 700; color: #1d4ed8;">${changeRequest.newCheckIn} ‚Üí ${changeRequest.newCheckOut}</span></p>
                    <p style="font-size: 13px; color: #4b5563;">Admin Qeydi: ${changeRequest.adminNote || '‚Äî'}</p>
                    <div class="res-actions" style="margin-top: 15px;">
                        <button class="btn-accept" onclick="respondToChangeRequest(${res.id}, 'accept')">‚úÖ Q…ôbul Et</button>
                        <button class="btn-reject" onclick="respondToChangeRequest(${res.id}, 'reject')">‚ùå R…ôdd Et</button>
                    </div>
                </div>
            `;
        } else if (res.status === 'Date Change Rejected') {
            changeRequestHtml = `<div class="alert" style="margin-top: 15px;">‚ùå Tarix D…ôyi≈üikliyi T…ôklifi R…ôdd edildi.</div>`;
        }

        detailBox.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1d4ed8; padding-bottom: 10px; margin-bottom: 15px;">
                <h4 style="margin: 0;">Rezervasiya #${res.id} ${statusToTag(res.status)}</h4>
                <span style="font-size: 13px; color: #6b7280;">Qeyd Tarixi: ${dateFormatter.format(new Date(res.date))}</span>
            </div>
            
            <div class="summary-grid">
                <div>
                    <strong>Tarix:</strong> ${res.summary.checkIn} ‚Üí ${res.summary.checkOut} (${res.summary.nights} gec…ô)<br>
                    <strong>Qonaqlar:</strong> ${res.summary.adults} B√∂y√ºk, ${res.summary.children} U≈üaq<br>
                    <strong>Hotell…ôr:</strong> ${res.summary.hotelNames}<br>
                    <strong style="display: block; margin-top: 10px;">U√ßu≈ü:</strong> G…ôli≈ü: ${res.flightInfo?.arrival || '‚Äî'}
                </div>
                <div class="summary-price-col">
                    <strong style="font-size: 20px; color: #ef4444;">Total: ${formatMoney(res.summary.totalPrice)}</strong><br>
                    <span style="font-size: 13px; color: #4b5563;">Otaq/Meal: ${formatMoney(res.summary.roomsSubtotal + res.summary.mealsTotal)} + Extra Bed: ${formatMoney(res.summary.extraBedsTotal)} + Operations: ${formatMoney(res.summary.operationsTotal)}</span>
                </div>
            </div>

            <h4 style="margin-top: 20px;">S…ôyah…ôt√ßil…ôr (${res.summary.totalTravelers} n…ôf…ôr)</h4>
            <div style="max-height: 120px; overflow-y: auto;">
                ${travelersHtml}
            </div>

            ${changeRequestHtml}
            
            <div class="res-actions" style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #d1d5db;">
                <p style="font-size: 12px; color: ${res.status === 'Confirmed' ? '#b91c1c' : '#6b7280'};">Yalnƒ±z t…ôsdiql…ônm…ômi≈ü rezervasiyalar silin…ô bil…ôr.</p>
                <button class="btn-delete" onclick="deleteAgentReservation(${res.id})" ${res.status === 'Confirmed' ? 'disabled' : ''}>üóëÔ∏è Rezervasiyanƒ± Sil</button>
            </div>
        `;
    }

    function respondToChangeRequest(id, action) {
        const detailBox = document.getElementById('agentReservationDetail');
        if (!confirm(`Tarix d…ôyi≈üikliyini ${action === 'accept' ? 'Q…ôbul' : 'R…ôdd'} etm…ôk ist…ôyirsiniz?`)) return;

        fetch(`/api/reservations/respond_change/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action })
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(result => {
            if (result.status === 200 && result.body.success) {
                const successMsg = `<div class="success">‚úÖ Tarix d…ôyi≈üikliyi uƒüurla ${action === 'accept' ? 'Q…ôbul edildi' : 'R…ôdd edildi'}. Status: ${result.body.reservation.status}</div>`;
                detailBox.innerHTML = successMsg + detailBox.innerHTML;
                
                fetchAgentReservations();
            } else {
                detailBox.innerHTML += `<div class="alert">‚ùå X…ôta: ${result.body.error || 'Nam…ôlum x…ôta'}</div>`;
            }
        })
        .catch(err => {
            detailBox.innerHTML += `<div class="alert">‚ùå Server il…ô …ôlaq…ô x…ôtasƒ±.</div>`;
        });
    }

    function deleteAgentReservation(id) {
        if (!confirm(`Rezervasiya #${id} silin…ôc…ôk. ∆èminsiniz?`)) return;

        const detailBox = document.getElementById('agentReservationDetail');
        fetch(`/api/reservations/${id}`, { method: 'DELETE' })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(result => {
            if (result.status === 200 && result.body.success) {
                alert(`Rezervasiya #${id} uƒüurla silindi.`);
                fetchAgentReservations();
                detailBox.style.display = 'none';
            } else {
                alert(`Silinm…ô x…ôtasƒ±: ${result.body.error || 'Nam…ôlum x…ôta'}`);
            }
        })
        .catch(err => {
            alert('Server il…ô …ôlaq…ô x…ôtasƒ±.');
        });
    }
    
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
      fetchData();

      document.getElementById('checkIn').addEventListener('change', recalcTotals);
      document.getElementById('checkIn').addEventListener('input', recalcTotals);
      document.getElementById('checkOut').addEventListener('change', recalcTotals);
      document.getElementById('checkOut').addEventListener('input', recalcTotals);
      
      document.getElementById('adults').addEventListener('input', recalcTotals);
      document.getElementById('children').addEventListener('input', recalcTotals);
      
      document.getElementById('operationsContainer').addEventListener('change', (e) => {
          if (e.target.type === 'checkbox') {
              recalcTotals();
          }
      });
      
      document.getElementById('hotelsCalcs').addEventListener('change', (e) => {
          if (e.target.classList.contains('extra-bed-checkbox') || e.target.type === 'radio') {
              recalcTotals();
          }
      });
      
      document.getElementById('reserveBtn').addEventListener('click', openReservationModal);
      document.getElementById('reservationForm').addEventListener('submit', submitReservation);
      
      showAgentView('booking');
    });

  </script>
</body>
</html>
